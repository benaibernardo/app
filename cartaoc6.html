<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>C6 | Benai Cloud (Fixed)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Plus+Jakarta+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        (function() {
            const PIN_CORRETO = "16359001"; 
            if (sessionStorage.getItem("benai_access_granted") === "true") return;
            document.write('<style>body{visibility:hidden;overflow:hidden}#gatekeeper{visibility:visible;position:fixed;inset:0;background:#0f172a;color:white;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Outfit,sans-serif}.pin-box{text-align:center;width:90%;max-width:350px}.pin-inp{padding:15px;font-size:1.5rem;text-align:center;border-radius:15px;border:2px solid rgba(56,189,248,.3);outline:0;margin-top:25px;background:rgba(255,255,255,.05);color:white;letter-spacing:4px;width:100%;transition:.3s}.pin-inp:focus{border-color:#38bdf8}.pin-msg{color:#f87171;margin-top:15px;font-weight:600;height:20px}</style><div id="gatekeeper"><div class="pin-box"><i class="fa-solid fa-shield-halved" style="font-size:3rem;color:#38bdf8;margin-bottom:15px"></i><h2 style="font-size:1.5rem;letter-spacing:-1px">Sistema Protegido</h2><p style="opacity:.6;font-size:.85rem">Insira o c√≥digo</p><input type="password" class="pin-inp" maxlength="8" onkeyup="verifyPin(this)"><div class="pin-msg" id="pin-error"></div></div></div>');
            window.verifyPin = function(el) {
                if (el.value.length === 8) {
                    if (el.value === PIN_CORRETO) { sessionStorage.setItem("benai_access_granted", "true"); location.reload(); } 
                    else { document.getElementById("pin-error").innerText = "C√≥digo Incorreto"; el.value = ""; }
                }
            };
        })();
    </script>
    <style>
        :root { --primary:#1e293b; --bg:#f8fafc; --text:#334155; --accent:#4f46e5; --safe:#10b981; --danger:#ef4444; --warn:#f59e0b; --benai:#2563eb; --talita:#db2777; --font-ui:'Plus Jakarta Sans',sans-serif; --font-num:'Outfit',sans-serif; }
        *{margin:0;padding:0;box-sizing:border-box;font-family:var(--font-ui);outline:0;-webkit-tap-highlight-color:transparent}
        body{background:var(--bg);color:var(--text);padding:20px;padding-bottom:80px;font-size:13px}
        .container{max-width:1150px;margin:0 auto}
        header{display:flex;justify-content:space-between;margin-bottom:25px;flex-wrap:wrap;gap:15px}
        .trip-header-block{display:flex;gap:15px}
        .trip-card-select{background:white;padding:8px 12px;border-radius:12px;border:1px solid #e2e8f0;box-shadow:0 4px 10px -2px rgba(0,0,0,0.03);min-width:280px}
        .trip-top-row{display:flex;align-items:center;gap:10px}
        .icon-box{width:42px;height:42px;border-radius:10px;background:#e0e7ff;color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;position:relative;overflow:hidden}
        .icon-box img{width:100%;height:100%;object-fit:cover;display:none;position:absolute;top:0;left:0}
        select{border:none;font-weight:800;color:var(--primary);font-size:1rem;background:transparent;cursor:pointer;width:100%}
        .trip-meta-row{display:flex;align-items:center;gap:10px;padding-left:52px}
        .status-badge{padding:2px 8px;border-radius:4px;font-size:0.6rem;font-weight:800}
        .st-open{background:#dcfce7;color:#166534} .st-closed{background:#1e293b;color:white}
        
        .cloud-status{width:10px;height:10px;border-radius:50%;background:#cbd5e1;display:inline-block;position:absolute;top:8px;right:8px}
        .cloud-status.ok{background:var(--safe);box-shadow:0 0 8px var(--safe)}
        .cloud-status.syncing{background:var(--accent);animation:pulse 1s infinite}
        @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}

        .actions{display:flex;gap:8px;flex-wrap:wrap}
        .btn{padding:8px 14px;border-radius:8px;cursor:pointer;font-size:0.8rem;font-weight:600;border:none;display:inline-flex;align-items:center;gap:6px;color:white;transition:0.2s}
        .btn:active{transform:scale(0.95)}
        .btn-trip{background:linear-gradient(135deg,#4f46e5,#8b5cf6)}
        .btn-month{background:linear-gradient(135deg,#059669,#10b981)}
        .btn-icon{width:42px;height:42px;border-radius:12px;border:1px solid #e2e8f0;background:white;color:#94a3b8;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;position:relative}
        .btn-icon:hover{color:var(--primary);border-color:var(--primary)}
        
        .invoice-panel{background:white;border:1px solid #e2e8f0;border-radius:14px;margin-bottom:25px;overflow:hidden}
        .inv-header{background:#fffbeb;padding:10px 25px;font-size:0.75rem;color:#b45309;font-weight:700;display:flex;justify-content:space-between}
        .inv-body{padding:18px 25px;display:flex;align-items:center;gap:30px}
        .credit-info-block{flex:1.2} .couple-split{flex:1;display:flex;gap:15px;justify-content:center} .action-block{margin-left:10px;display:flex;gap:8px}
        .trip-mode .credit-info-block,.trip-mode .action-block,.trip-mode .inv-header{display:none}
        .trip-mode .couple-split{flex:1;width:100%;justify-content:space-around}
        .limit-row{display:flex;justify-content:space-between;font-size:0.8rem;font-weight:600;color:#64748b;margin-bottom:6px}
        .limit-bar{height:10px;background:#f1f5f9;border-radius:5px;overflow:hidden}
        .limit-fill{height:100%;width:0;background:var(--accent);transition:width 0.6s}
        .person{display:flex;align-items:center;gap:8px;background:#f8fafc;padding:8px 20px;border-radius:10px;border:1px solid #e2e8f0;min-width:120px;justify-content:center}
        .person strong{font-family:var(--font-num);font-size:1.1rem}
        .c-benai{color:var(--benai)} .c-talita{color:var(--talita)}
        .btn-pay{background:linear-gradient(135deg,#16a34a,#15803d);padding:8px 14px;border-radius:6px;color:white;border:none;font-weight:700;cursor:pointer}
        .btn-undo{background:white;border:1px solid #fdba74;color:#c2410c;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:700}

        .tabs{display:flex;gap:8px;margin-bottom:20px;padding-bottom:5px;overflow-x:auto}
        .t-btn{padding:10px 20px;border:none;background:transparent;color:#64748b;font-weight:600;cursor:pointer;border-radius:8px}
        .t-btn.active{background:white;color:var(--primary);box-shadow:0 2px 5px rgba(0,0,0,.05)}
        .tab-content{display:none} .tab-content.active{display:block}

        .summary{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:25px}
        .sum-box{padding:18px;border-radius:14px;background:white;box-shadow:0 4px 6px -1px rgba(0,0,0,.02)}
        .sum-box .val{font-family:var(--font-num);font-size:1.4rem;font-weight:800;display:block}
        .sb-1{background:#eff6ff;color:#1e40af} .sb-2{background:#fff7ed;color:#c2410c}
        .sb-3{background:#f0fdf4;color:#15803d} .sb-4{background:#faf5ff;color:#7e22ce}
        
        .main-grid{display:grid;grid-template-columns:300px 1fr;gap:20px}
        .card{background:white;border-radius:14px;border:1px solid #e2e8f0;padding:20px}
        h2{font-size:0.9rem;color:var(--primary);margin-bottom:15px;font-weight:700}
        
        input,select{width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:0.85rem;background:#f8fafc;color:var(--primary)}
        .btn-save{width:100%;padding:12px;background:var(--safe);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:5px}
        
        .list-filters{display:flex;gap:8px;margin-bottom:15px}
        .list-box{max-height:600px;overflow-y:auto}
        .item-container{background:white;border-radius:8px;border:1px solid #f1f5f9;margin-bottom:6px;position:relative}
        .item-container.paid{background:var(--bg-paid-subtle);border-left:4px solid var(--safe);opacity:0.9}
        .item-container.pending{background:var(--bg-pend-subtle);border-left:4px solid var(--danger)}
        .item-main{display:grid;grid-template-columns:55px 1fr auto;align-items:center;gap:12px;padding:10px 15px}
        .i-desc{font-weight:700;color:var(--primary)}
        .i-val{font-family:var(--font-num);font-weight:800;font-size:1rem}
        .val-paid{color:var(--safe)} .val-pend{color:var(--danger)}
        
        #modal-sync{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,31,91,.6);z-index:1000;align-items:center;justify-content:center}
        .modal-box{background:white;width:90%;max-width:450px;padding:30px;border-radius:24px;position:relative}
        .sync-btn{width:100%;padding:15px;margin-bottom:10px;border:1px solid #e2e8f0;border-radius:12px;background:white;display:flex;align-items:center;gap:15px;cursor:pointer;text-align:left}
        .sync-btn:hover{border-color:var(--accent)}
        
        @media(max-width:850px){
            header,.inv-body,.main-grid,.summary,.set-grid{flex-direction:column;grid-template-columns:1fr}
            .trip-header-block,.trip-card-select,.actions,.couple-split{width:100%}
            .item-main{grid-template-columns:55px 1fr;align-items:start}
            .i-right{grid-column:span 2;text-align:left;border-top:1px solid #eee;margin-top:5px;padding-top:5px;display:flex;justify-content:space-between}
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="trip-header-block">
                <div class="trip-card-select">
                    <div class="trip-top-row">
                        <div class="icon-box" onclick="triggerImg()" id="iconWrapper"><i id="tripIcon" class="fa-solid fa-suitcase"></i><img id="tripImg" alt="Trip"></div>
                        <select id="tripSelector" onchange="switchTrip(this.value)"></select>
                    </div>
                    <div class="trip-meta-row">
                        <span id="stBadge" class="status-badge st-open">EM ABERTO</span>
                        <span id="dateDisplay" class="date-display">...</span>
                    </div>
                </div>
                <button class="btn-icon" onclick="toggleSettings()"><i class="fa-solid fa-gear"></i></button>
            </div>
            <div class="actions">
                <button class="btn btn-trip" onclick="createNewTrip('trip')"><i class="fa-solid fa-plane"></i> Nova Viagem</button>
                <button class="btn btn-month" onclick="createNewTrip('month')"><i class="fa-solid fa-calendar"></i> Novo M√™s</button>
                <button class="btn-icon sync" onclick="openModal('sync')"><i class="fa-solid fa-cloud"></i><div id="cloudIndicator" class="cloud-status"></div></button>
            </div>
        </header>

        <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        <input type="file" id="tripImageInput" style="display:none" onchange="handleImageUpload(this)">

        <div id="settingsPanel" style="display:none;background:white;padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid #e2e8f0">
            <h3>Configura√ß√µes</h3>
            <label>Nome</label><input id="cfgName">
            <label>Limite</label><input id="cfgCredit" oninput="maskMoney(this)">
            <label>In√≠cio</label><input type="date" id="cfgStart">
            <label>Fim</label><input type="date" id="cfgEnd">
            <label>Dia Venc</label><input type="number" id="cfgDue">
            <button class="btn-save" onclick="saveSettings()">Salvar</button>
        </div>

        <div class="invoice-panel" id="invoicePanel">
            <div class="inv-header"><div><i class="fa-solid fa-credit-card"></i> PAINEL DE CR√âDITO</div><span id="dueAlert"></span></div>
            <div class="inv-body">
                <div class="credit-info-block">
                    <div class="limit-row"><span>GASTO: <strong style="color:var(--primary)" id="cardSpent">R$ 0,00</strong></span><span>LIMITE: <strong id="cardLimit">---</strong></span></div>
                    <div class="limit-bar"><div id="barCredit" class="limit-fill"></div></div>
                </div>
                <div class="couple-split">
                    <div class="person" style="border-left:3px solid var(--benai)"><small>BENAI</small><strong id="valBenai">R$ 0,00</strong></div>
                    <div class="person" style="border-left:3px solid var(--talita)"><small>TALITA</small><strong id="valTalita">R$ 0,00</strong></div>
                </div>
                <div class="action-block"><button class="btn-pay" onclick="payInvoice()">Pagar</button><button class="btn-undo" onclick="undoInvoice()">Desfazer</button></div>
            </div>
        </div>

        <div class="tabs">
            <button class="t-btn active" id="btn-tab-main" onclick="setTab('main')">Lan√ßamentos</button>
            <button class="t-btn" id="btn-tab-charts" onclick="setTab('charts')">Gr√°ficos</button>
        </div>

        <div id="tab-main" class="tab-content active">
            <div class="summary" id="tripSummaryPanel">
                <div class="sum-box sb-1" id="budgetBox"><small>Or√ßamento</small><div id="budgetDisplay" class="val">R$ 0,00</div></div>
                <div class="sum-box sb-2"><small>Gasto Total</small><div id="dispSpent" class="val">R$ 0,00</div></div>
                <div class="sum-box sb-3"><small>Pago</small><div id="dispPaid" class="val">R$ 0,00</div></div>
                <div class="sum-box sb-4"><small>Saldo</small><div id="dispRem" class="val">R$ 0,00</div></div>
            </div>

            <div class="main-grid">
                <div class="card">
                    <h2>Novo Lan√ßamento</h2>
                    <form id="addForm">
                        <label>Data</label><input type="date" id="fDate" required>
                        <label>Descri√ß√£o</label><input id="fDesc" required>
                        <label>Valor</label><input id="fVal" required oninput="maskMoney(this)">
                        <label>Categoria</label>
                        <div style="display:flex;gap:5px"><select id="fCat"></select><button type="button" onclick="addCustomCategory()" style="width:40px">+</button></div>
                        <label>Pagamento</label><select id="fPay"><option value="credit">Cr√©dito</option><option value="debit">D√©bito</option><option value="pix">Pix</option></select>
                        <label>Parcelas</label><select id="fInst"></select>
                        <div style="margin-top:10px"><input type="checkbox" id="fRecur" style="width:auto"> Recorrente</div>
                        <button type="submit" class="btn-save">Salvar</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Extrato</h2>
                    <div class="list-filters">
                        <select id="filDate" onchange="renderFilters()"></select>
                        <select id="filCat" onchange="renderFilters()"></select>
                        <input id="filTxt" placeholder="Buscar..." onkeyup="renderFilters()">
                    </div>
                    <div id="listContainer" class="list-box"></div>
                </div>
            </div>
        </div>

        <div id="tab-charts" class="tab-content">
            <div class="chart-grid">
                <div class="card" style="height:300px"><canvas id="c1"></canvas></div>
                <div class="card" style="height:300px"><canvas id="c2"></canvas></div>
            </div>
        </div>
    </div>

    <div id="modal-sync">
        <div class="modal-box">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px">
                <h3>Dados</h3><span onclick="closeModal('sync')" style="cursor:pointer">X</span>
            </div>
            <div style="border-bottom:1px solid #eee;margin-bottom:15px;padding-bottom:15px">
                <small style="color:var(--accent)">NUVEM</small>
                <button class="sync-btn" onclick="forceSync()">‚òÅÔ∏è For√ßar Download da Nuvem</button>
            </div>
            <small>LOCAL</small>
            <button class="sync-btn" onclick="exportData()">üíæ Baixar JSON</button>
            <button class="sync-btn" onclick="document.getElementById('importFile').click()">üìÇ Restaurar JSON</button>
            <button class="sync-btn" style="color:red;border-color:red" onclick="hardReset()">üóëÔ∏è Resetar Tudo</button>
        </div>
    </div>

    <script>
        const DB_KEY = 'benai_card_main_db'; 
        const TOKEN_KEY = 'benai_coach_gh_token';
        const GIST_DESC = 'BENAI_PERSONAL_DB'; 
        const DEFAULT_CATS = ['Alimenta√ß√£o', 'Transporte', 'Hospedagem', 'Passeios', 'Compras', 'Mercado', 'Outros'];
        
        let db = { currentId: null, categories: [...DEFAULT_CATS], trips: [] };
        let active = null;
        let gistId = null; 

        // --- INIT & MIGRATION BLINDADA ---
        async function init() {
            // Tenta recuperar dados locais (N√ÉO APAGA NADA SE FALHAR)
            let saved = localStorage.getItem(DB_KEY);
            
            // Se n√£o tem na chave nova, tenta migrar das chaves antigas famosas
            if (!saved || saved.length < 20) {
                const legacy = ['benai_card_v1', 'controle_fin_v83', 'controle_fin_v82'];
                for(let k of legacy) {
                    let old = localStorage.getItem(k);
                    if(old && old.length > 50) {
                        saved = old;
                        localStorage.setItem(DB_KEY, saved); // Salva na nova
                        break;
                    }
                }
            }

            if(saved) {
                try {
                    db = JSON.parse(saved);
                    // Garante estrutura m√≠nima se o JSON for muito velho
                    if(!db.trips) db.trips = [];
                    if(!db.categories) db.categories = [...DEFAULT_CATS];
                } catch(e) { console.error("JSON corrompido", e); }
            } else {
                // S√≥ cria do zero se realmente n√£o achou nada
                db = { trips: [{id:'def', name:'Meu Controle', type:'trip', budget:0, creditLimit:0, transactions:[]}], currentId:'def', categories: [...DEFAULT_CATS] };
                saveLocal();
            }

            initInstallmentSelect();
            refreshUI();
            
            // Sync silencioso com a nuvem (s√≥ se tiver token)
            await syncCloud();
        }

        // --- NUVEM ---
        function updateCloudStatus(status) {
            const el = document.getElementById('cloudIndicator');
            if(el) el.className = 'cloud-status ' + status;
        }

        async function syncCloud() {
            const token = localStorage.getItem(TOKEN_KEY);
            if(!token) return updateCloudStatus('error');
            updateCloudStatus('syncing');
            try {
                if(!gistId) {
                    const s = await fetch('https://api.github.com/gists', { headers: { 'Authorization': `token ${token}` } });
                    const g = await s.json();
                    const f = g.find(x => x.description === GIST_DESC);
                    if(f) gistId = f.id;
                }
                if(gistId) {
                    const r = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { 'Authorization': `token ${token}` } });
                    const j = await r.json();
                    if(j.files["c6_card.json"]) {
                        const cloudDB = JSON.parse(j.files["c6_card.json"].content);
                        // L√≥gica simples: Se nuvem tem dados v√°lidos, usa ela
                        if(cloudDB.trips && cloudDB.trips.length > 0) {
                            db = cloudDB;
                            saveLocal();
                            refreshUI();
                        }
                    } else { await pushCloud(); }
                    updateCloudStatus('ok');
                } else { await pushCloud(); }
            } catch(e) { console.error(e); updateCloudStatus('error'); }
        }

        async function pushCloud() {
            const token = localStorage.getItem(TOKEN_KEY);
            if(!token) return;
            updateCloudStatus('syncing');
            try {
                let url = 'https://api.github.com/gists';
                let method = 'POST';
                if(gistId) { url += '/' + gistId; method = 'PATCH'; }
                const payload = { description: GIST_DESC, public: false, files: { "c6_card.json": { content: JSON.stringify(db) } } };
                await fetch(url, { method: method, headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                updateCloudStatus('ok');
            } catch(e) { console.error(e); updateCloudStatus('error'); }
        }

        function forceSync() { if(confirm("Baixar dados da nuvem?")) { syncCloud(); closeModal('sync'); } }
        function saveLocal() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
        function save() { saveLocal(); refreshUI(); pushCloud(); }

        // --- BACKUP ---
        function openModal(id) { document.getElementById('modal-'+id).style.display='flex'; }
        function closeModal(id) { document.getElementById('modal-'+id).style.display='none'; }
        
        function importData(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    // IMPORTADOR TOLERANTE (LEGACY MODE)
                    const raw = JSON.parse(e.target.result);
                    // Se o JSON importado for do formato antigo (sem .trips), converte na marra
                    if (Array.isArray(raw)) {
                        alert("Formato antigo detectado. Convertendo...");
                        db.trips[0].transactions = raw; // Joga tudo na viagem atual
                    } else if (raw.transactions && !raw.trips) {
                        db.trips[0].transactions = raw.transactions;
                    } else {
                        db = raw; // Formato novo direto
                    }
                    save();
                    location.reload();
                } catch(err) { alert("Erro ao importar: " + err.message); }
            };
            r.readAsText(f);
        }
        
        function exportData() {
            const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a'); a.href = d; a.download = "benai_card_backup.json"; a.click();
        }
        function hardReset() { if(confirm("Apagar tudo?")) { localStorage.removeItem(DB_KEY); location.reload(); } }

        // --- UI LOGIC ---
        function initInstallmentSelect() { const s = document.getElementById('fInst'); s.innerHTML = ''; for(let i=1; i<=12; i++) s.add(new Option(i + 'x', i)); }
        
        function refreshUI() {
            active = db.trips.find(t => t.id === db.currentId);
            if(!active && db.trips.length > 0) { active = db.trips[0]; db.currentId = active.id; }
            if(!active) return; // Should create default in init

            // Populate Selector
            const sel = document.getElementById('tripSelector'); sel.innerHTML = '';
            db.trips.forEach(t => sel.add(new Option((t.type==='month'?'üìÖ ':'‚úàÔ∏è ')+t.name, t.id)));
            sel.value = active.id;

            // Update Header & Settings Inputs
            document.getElementById('dateDisplay').innerText = active.startDate ? `${active.startDate} - ${active.endDate}` : '...';
            document.getElementById('cfgName').value = active.name;
            document.getElementById('cfgCredit').value = fmt(active.creditLimit);
            document.getElementById('cfgStart').value = active.startDate || '';
            document.getElementById('cfgEnd').value = active.endDate || '';
            document.getElementById('cfgDue').value = active.dueDay || '';
            document.getElementById('budgetDisplay').innerText = fmt(active.budget);

            // Populate Cats
            const sCat = document.getElementById('fCat'); sCat.innerHTML = '';
            db.categories.forEach(c => sCat.add(new Option(c,c)));

            // Calculate Totals
            let tot=0, paid=0, credit=0;
            const allTrans = [];
            
            // Juntar transa√ß√µes (simplificado para debug)
            if(active.transactions) {
                active.transactions.forEach(t => allTrans.push(t));
            }

            allTrans.forEach(t => {
                const v = parseFloat(t.amount) || 0;
                tot += v;
                if(t.payment === 'credit') credit += v;
                // Calculo simples de pago
                if(t.installments > 1) {
                    const part = v / t.installments;
                    paid += part * (t.paidInstallments || 0);
                } else if(t.paid) {
                    paid += v;
                }
            });

            document.getElementById('dispSpent').innerText = fmt(tot);
            document.getElementById('dispPaid').innerText = fmt(paid);
            document.getElementById('dispRem').innerText = fmt((active.budget||0) - tot);
            document.getElementById('cardSpent').innerText = fmt(credit);
            
            // Progress Bar
            const cl = active.creditLimit || 1;
            const pct = (credit / cl) * 100;
            document.getElementById('barCredit').style.width = Math.min(pct, 100) + '%';
            document.getElementById('cardLimit').innerText = fmt(cl);

            // RENDER LIST (AQUI ESTAVA O PROBLEMA)
            renderList(allTrans);
        }

        function renderList(data) {
            const list = document.getElementById('listContainer'); 
            list.innerHTML = '';
            
            // FILTRO SEGURO: Se filtro falhar, mostra tudo
            let filtered = data;
            
            // Popula selects de filtro
            const filDate = document.getElementById('filDate');
            // Salva sele√ß√£o atual
            const curDate = filDate.value;
            filDate.innerHTML = '<option value="">Todas Datas</option>';
            const dates = [...new Set(data.map(t => t.date))].sort().filter(d=>d);
            dates.forEach(d => filDate.add(new Option(d.split('-').reverse().join('/'), d)));
            filDate.value = curDate;

            const filCat = document.getElementById('filCat');
            if(filCat.options.length <= 1) {
                filCat.innerHTML = '<option value="">Todas Categorias</option>';
                db.categories.forEach(c => filCat.add(new Option(c,c)));
            }

            // Aplica filtros se existirem
            const fD = filDate.value;
            const fC = filCat.value;
            const fT = document.getElementById('filTxt').value.toLowerCase();

            filtered = data.filter(t => {
                if (fD && t.date !== fD) return false;
                if (fC && t.category !== fC) return false;
                if (fT && !t.desc.toLowerCase().includes(fT)) return false;
                return true;
            });

            // Ordena por data
            filtered.sort((a,b) => (a.date < b.date ? 1 : -1));

            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding:20px;text-align:center;color:#999">Vazio</div>';
                return;
            }

            filtered.forEach(t => {
                // Tratamento de erro individual
                try {
                    const div = document.createElement('div');
                    const isPaid = (t.paid || (t.installments > 1 && t.paidInstallments >= t.installments));
                    div.className = `item-container ${isPaid ? 'paid' : 'pending'}`;
                    
                    let dateStr = '---';
                    if(t.date) dateStr = t.date.split('-').reverse().slice(0,2).join('/');

                    let valStr = fmt(t.amount);
                    if(t.installments > 1) valStr += ` <small>(${t.paidInstallments||0}/${t.installments})</small>`;

                    div.innerHTML = `
                        <div class="item-main">
                            <div></div>
                            <div>
                                <div class="i-desc">${t.desc || 'Sem nome'}</div>
                                <div style="font-size:0.75rem;color:#64748b">${dateStr} ‚Ä¢ ${t.category||'Geral'} ‚Ä¢ ${t.payment||'Card'}</div>
                            </div>
                            <div style="text-align:right">
                                <div class="i-val ${isPaid?'val-paid':'val-pend'}">${valStr}</div>
                                <div style="font-size:0.8rem;cursor:pointer" onclick="delT('${t.id}')">üóëÔ∏è</div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                } catch(e) { console.error("Item ruim pulado"); }
            });
        }

        // Helpers
        function switchTrip(id) { db.currentId = id; save(); }
        function toggleSettings() { const p = document.getElementById('settingsPanel'); p.style.display = p.style.display==='block'?'none':'block'; }
        function saveSettings() { active.name = document.getElementById('cfgName').value; active.creditLimit = parse(document.getElementById('cfgCredit').value); active.budget = parse(document.getElementById('budgetDisplay').innerText); active.startDate = document.getElementById('cfgStart').value; active.endDate = document.getElementById('cfgEnd').value; active.dueDay = document.getElementById('cfgDue').value; save(); toggleSettings(); }
        function setTab(t) { document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.t-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.getElementById('btn-tab-'+t).classList.add('active'); }
        function renderFilters() { refreshUI(); } // Re-render triggers filter logic inside renderList
        
        document.getElementById('addForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const val = parse(document.getElementById('fVal').value);
            if(val <= 0) return;
            const nt = {
                id: Date.now().toString(),
                date: document.getElementById('fDate').value,
                desc: document.getElementById('fDesc').value,
                category: document.getElementById('fCat').value,
                amount: val,
                payment: document.getElementById('fPay').value,
                installments: parseInt(document.getElementById('fInst').value),
                recur: document.getElementById('fRecur').checked,
                paid: false, paidInstallments: 0
            };
            active.transactions.push(nt);
            save(); e.target.reset(); document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
            showToast("Salvo!");
        });

        function delT(id) { if(confirm("Apagar?")) { active.transactions = active.transactions.filter(t=>t.id!==id); save(); } }
        function fmt(n) { return (n||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
        function parse(s) { return parseFloat(s.replace(/[^0-9,]/g,'').replace(',','.'))||0; }
        function maskMoney(i) { let v=i.value.replace(/\D/g,''); v=(v/100).toFixed(2)+''; v=v.replace(".",","); v=v.replace(/(\d)(?=(\d{3})+(?!\d))/g,'$1.'); i.value='R$ '+v; }
        function showToast(m) { const t=document.getElementById('toast'); t.innerHTML=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
        document.getElementById('budgetBox').onclick = function() { const v = prompt("Novo Or√ßamento:", active.budget); if(v) { active.budget = parseFloat(v); save(); } };

        init();
    </script>
</body>
</html>
