<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benai Finance | Jar Method</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['Space Grotesk', 'monospace'] },
                    colors: {
                        brand: { dark: '#0f172a', accent: '#0ea5e9', success: '#10b981', danger: '#ef4444', warn: '#f59e0b' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; font-family: 'Outfit', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: #0f172a; color: #f8fafc; }
        
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(0, 0, 0, 0.05); }
        .dark .glass { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; transition: background 0.3s; }
        .dark .glass-header { background: rgba(15, 23, 42, 0.9); border-bottom: 1px solid rgba(56, 189, 248, 0.1); }
        
        .jar-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .jar-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2); }
        .dark .jar-card:hover { border-color: rgba(56, 189, 248, 0.3); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5); }
        
        .input-std { background: #fff; border: 1px solid #e2e8f0; color: #1e293b; padding: 10px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; }
        .dark .input-std { background: #1e293b; border: 1px solid #334155; color: white; }
        .input-std:focus { border-color: #0ea5e9; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .dark .modal { background: rgba(0, 0, 0, 0.7); }
        
        /* CLOUD SHIELD (BLOCKING OVERLAY) */
        #cloud-shield {
            position: fixed; inset: 0; z-index: 9999;
            background: #0f172a; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .shield-spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #0ea5e9; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Z-INDEX FIX FOR NESTED MODALS */
        #modalCats { z-index: 200; } 
        
        .modal-content { background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 450px; border: 1px solid #e2e8f0; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto; }
        .dark .modal-content { background: #1e293b; border: 1px solid #334155; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        .toggle-checkbox:checked { right: 0; border-color: #0ea5e9; }
        .toggle-checkbox:checked + .toggle-label { background-color: #0ea5e9; }
        
        /* SYNC INDICATOR DOT */
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; position: absolute; top: 8px; right: 8px; }
        .sync-dot.active { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .sync-dot.inactive { background-color: #94a3b8; }
        
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* JAR COLORS */
        .j-essen { --c: #3b82f6; } 
        .j-free { --c: #a855f7; }  
        .j-edu { --c: #06b6d4; }   
        .j-long { --c: #10b981; }  
        .j-play { --c: #f59e0b; }  
        .j-give { --c: #ec4899; }  
    </style>
</head>
<body class="pb-20">

    <!-- CLOUD SHIELD (Load Blocker) -->
    <div id="cloud-shield">
        <div class="shield-spinner"></div>
        <h2 class="text-xl font-bold font-sans tracking-widest uppercase">Sincronizando</h2>
        <p class="text-xs text-slate-400 mt-2" id="shield-msg">Buscando versão mais recente...</p>
    </div>

    <!-- HEADER -->
    <header class="glass-header px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <button onclick="window.parent.closeApp()" class="p-2 hover:bg-black/5 dark:hover:bg-white/10 rounded-lg transition"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-500 dark:text-slate-400"></i></button>
            <div>
                <h1 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight flex items-center gap-2"><i data-lucide="wallet" class="w-5 h-5 text-sky-500 dark:text-sky-400"></i> Benai<span class="text-sky-500 dark:text-sky-400">Fin</span></h1>
                <p class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-widest font-bold">Gestão Inteligente</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleLocalTheme()" class="p-2 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 dark:text-slate-300 hover:text-sky-500 transition"><i id="themeIcon" data-lucide="moon" class="w-5 h-5"></i></button>
            <button onclick="openConfig()" class="p-2 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 dark:text-slate-300 hover:text-sky-500 transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
            <button onclick="openCloudModal()" class="p-2 bg-sky-50 dark:bg-sky-900/30 border border-sky-200 dark:border-sky-800 rounded-lg text-sky-500 dark:text-sky-400 hover:bg-sky-100 dark:hover:bg-sky-900/50 transition relative">
                <i data-lucide="cloud" class="w-5 h-5"></i>
                <div id="cloudStatusDot" class="sync-dot inactive"></div>
            </button>
        </div>
    </header>

    <!-- MAIN DASHBOARD -->
    <main class="max-w-4xl mx-auto px-4 mt-6 space-y-8">
        
        <!-- MONTH NAVIGATOR (NATIVE PICKER) -->
        <div class="flex justify-center items-center gap-4">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition text-slate-500 dark:text-slate-300"><i data-lucide="chevron-left"></i></button>
            <div class="relative group">
                <h2 id="mainDateDisplay" class="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-widest min-w-[180px] text-center cursor-pointer hover:text-sky-500 transition">Mês Atual</h2>
                <input type="month" id="monthPicker" class="absolute inset-0 opacity-0 cursor-pointer" onchange="setSpecificMonth(this.value)">
                <div class="absolute -bottom-4 left-0 right-0 text-[10px] text-center text-sky-500 opacity-0 group-hover:opacity-100 transition">Clique para mudar</div>
            </div>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition text-slate-500 dark:text-slate-300"><i data-lucide="chevron-right"></i></button>
        </div>

        <!-- SUMMARY CARDS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- SALDO EM CONTA (Inclui TUDO) -->
            <div class="glass p-5 rounded-2xl border-l-4 border-l-blue-500 relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10"><i data-lucide="landmark" class="w-16 h-16 text-slate-800 dark:text-white"></i></div>
                <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Saldo Bancário (Real)</p>
                <h2 class="text-2xl font-bold text-blue-600 dark:text-blue-400 font-mono mt-1" id="dispBankBalance">R$ 0,00</h2>
                <p class="text-[10px] text-slate-400 mt-1">Considera todas movimentações (inclusive terceiros)</p>
            </div>
            <!-- CUSTO DE VIDA (Sem terceiros) -->
            <div class="glass p-5 rounded-2xl border-l-4 border-l-rose-500 relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10"><i data-lucide="user-minus" class="w-16 h-16 text-slate-800 dark:text-white"></i></div>
                <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Meu Gasto Real</p>
                <h2 class="text-2xl font-bold text-rose-600 dark:text-rose-400 font-mono mt-1" id="dispMySpent">R$ 0,00</h2>
                <p class="text-[10px] text-slate-400 mt-1">Exclui repasses/reembolsos</p>
            </div>
            <!-- ENTRADA PESSOAL -->
            <div class="glass p-5 rounded-2xl border-l-4 border-l-emerald-500 relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10"><i data-lucide="user-plus" class="w-16 h-16 text-slate-800 dark:text-white"></i></div>
                <p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Minha Renda</p>
                <h2 class="text-2xl font-bold text-emerald-600 dark:text-emerald-400 font-mono mt-1" id="dispMyIncome">R$ 0,00</h2>
                <p class="text-[10px] text-slate-400 mt-1">Exclui dinheiro de terceiros</p>
            </div>
        </div>

        <!-- DEBT SNIPER WIDGET (MULTI TARGET) -->
        <div id="debtSniper" class="glass p-6 rounded-2xl border border-rose-200 dark:border-rose-900/30 bg-rose-50/50 dark:bg-rose-900/10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-rose-800 dark:text-rose-300 uppercase tracking-widest flex items-center gap-2"><i data-lucide="crosshair" class="w-4 h-4"></i> Sniper de Dívidas</h3>
                <button onclick="editDebtTarget()" class="text-xs font-bold text-rose-600 dark:text-rose-400 hover:underline flex items-center gap-1"><i data-lucide="settings-2" class="w-3 h-3"></i> Gerenciar Dívidas</button>
            </div>
            
            <div id="debtList" class="space-y-4">
                <!-- JS RENDERED INDIVIDUAL DEBTS -->
            </div>

            <div class="mt-4 pt-4 border-t border-rose-200 dark:border-rose-800">
                <div class="flex justify-between text-xs font-mono font-bold text-rose-900 dark:text-rose-100">
                    <span>TOTAL PAGO</span>
                    <span id="debtTotalPaid">R$ 0,00</span>
                </div>
                <div class="flex justify-between text-xs font-mono font-bold text-rose-900 dark:text-rose-100 mt-1">
                    <span>TOTAL RESTANTE</span>
                    <span id="debtTotalRemaining">R$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- NEW TRANSACTION BUTTON -->
        <div class="glass p-4 rounded-xl flex gap-3 items-center">
            <div class="flex-1">
                <h3 class="font-bold text-slate-800 dark:text-white text-sm">Novo Lançamento</h3>
                <p class="text-xs text-slate-500 dark:text-slate-400">Registre entradas, saídas ou pague contas.</p>
            </div>
            <button onclick="openTransactionModal()" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-sky-500/20 transition flex items-center gap-2 text-sm">
                <i data-lucide="plus-circle" class="w-4 h-4"></i> LANÇAR
            </button>
        </div>

        <!-- CHARTS SECTION -->
        <div class="glass p-6 rounded-2xl border border-slate-200 dark:border-slate-700/50">
            <h3 class="text-sm font-bold text-slate-800 dark:text-white uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-sky-500"></i> Gastos Diários (Pessoal)</h3>
            <div class="h-48 w-full relative">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>

        <!-- JARS GRID -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="package" class="w-5 h-5 text-sky-500"></i> Seus Potes (Orçamento)</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="jarsContainer">
                <!-- JARS RENDERED JS -->
            </div>
        </div>

        <!-- TRANSACTIONS (WITH FILTERS) -->
        <div class="glass rounded-2xl overflow-hidden border border-slate-200 dark:border-slate-700/50">
            <!-- Filter Header -->
            <div class="p-4 border-b border-slate-200 dark:border-slate-700/50 bg-slate-50 dark:bg-slate-800/30">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-slate-700 dark:text-white text-sm flex items-center gap-2"><i data-lucide="list" class="w-4 h-4 text-sky-500"></i> Extrato</h3>
                    <button onclick="toggleFilters()" class="text-xs font-bold text-sky-600 dark:text-sky-400 flex items-center gap-1"><i data-lucide="filter" class="w-3 h-3"></i> Filtros</button>
                </div>
                
                <!-- Expanded Filters -->
                <div id="filterPanel" class="hidden grid grid-cols-1 md:grid-cols-4 gap-3 mb-3 animate-fade-in">
                    <input type="text" id="filterText" placeholder="Buscar (Local, Desc)..." class="input-std text-xs" onkeyup="renderTransactions()">
                    <select id="filterCat" class="input-std text-xs" onchange="renderTransactions()">
                        <option value="">Todas Categorias</option>
                    </select>
                    <!-- NEW DATE FILTER -->
                    <select id="filterDate" class="input-std text-xs" onchange="renderTransactions()">
                        <option value="">Todas as Datas</option>
                    </select>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="filterHideThirdParty" class="w-4 h-4 rounded border-slate-300" onchange="renderTransactions()" checked>
                        <label for="filterHideThirdParty" class="text-xs text-slate-600 dark:text-slate-300">Ocultar Terceiros</label>
                    </div>
                </div>
            </div>
            
            <div class="max-h-[500px] overflow-y-auto" id="txList">
                <!-- TX RENDERED JS -->
            </div>
        </div>

    </main>

    <!-- MODAL CLOUD & BACKUP (NEW) -->
    <div id="modalCloud" class="modal">
        <div class="modal-content max-w-sm text-center">
            <div class="flex justify-end mb-2">
                <button onclick="closeModal('modalCloud')"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>
            <div class="w-16 h-16 bg-sky-100 dark:bg-sky-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="cloud" class="w-8 h-8 text-sky-600 dark:text-sky-400"></i>
            </div>
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">Central de Dados</h3>
            <p class="text-xs text-slate-500 mb-6">Sincronização & Segurança</p>
            
            <div class="space-y-4">
                <div class="text-left">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Token GitHub (Acesso Direto)</label>
                    <div class="flex gap-2">
                        <input type="password" id="manualToken" class="input-std text-xs" placeholder="ghp_...">
                        <button onclick="saveLocalToken()" class="p-2 bg-emerald-500 text-white rounded-lg"><i data-lucide="save" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div class="border-t border-slate-200 dark:border-slate-700 my-4"></div>

                <button onclick="backupData()" class="w-full py-3 rounded-xl bg-slate-800 dark:bg-slate-700 text-white font-bold text-xs flex justify-center gap-2 hover:bg-slate-700 transition">
                    <i data-lucide="download"></i> FAZER BACKUP (JSON)
                </button>
                
                <label class="w-full py-3 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 text-slate-500 font-bold text-xs cursor-pointer flex justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-800 transition">
                    <i data-lucide="upload"></i> RESTAURAR BACKUP
                    <input type="file" id="fileIn" hidden onchange="restoreData(this)">
                </label>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIG (SMART CALC & DEBTS) -->
    <div id="modalConfig" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5 text-sky-500"></i> Configurações</h3>
                <button onclick="closeModal('modalConfig')"><i data-lucide="x" class="w-5 h-5 text-slate-400 hover:text-slate-600 dark:hover:text-white"></i></button>
            </div>
            
            <div class="space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                <!-- Smart Calc Section -->
                <div class="space-y-3">
                    <h4 class="text-xs font-bold text-sky-600 dark:text-sky-400 uppercase border-b border-slate-200 dark:border-slate-700 pb-1">Orçamento Inteligente</h4>
                    <div><label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Renda Mensal Estimada</label><input type="text" id="cfgIncome" class="input-std font-mono text-lg font-bold" oninput="maskMoney(this)" placeholder="R$ 0,00"></div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Gastos Fixos (Obrigatórios)</label>
                        <div id="fixedList" class="space-y-2 mb-2"></div>
                        <div class="flex gap-2"><input id="newFixedName" class="input-std text-xs" placeholder="Nome (Ex: Aluguel)"><input id="newFixedVal" class="input-std text-xs font-mono w-24" placeholder="R$ 0,00" oninput="maskMoney(this)"><button onclick="addFixedCost()" class="p-2 bg-slate-200 dark:bg-slate-700 rounded-lg"><i data-lucide="plus" class="w-3 h-3"></i></button></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mt-2"><button onclick="applyPreset('conservative')" class="py-2 text-[10px] font-bold bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200">Conservador</button><button onclick="applyPreset('balanced')" class="py-2 text-[10px] font-bold bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Equilibrado</button><button onclick="applyPreset('aggressive')" class="py-2 text-[10px] font-bold bg-rose-100 text-rose-700 rounded hover:bg-rose-200">Agressivo (Econ)</button></div>
                    <button onclick="runSmartCalc()" class="w-full py-2 bg-sky-600 text-white font-bold rounded-lg text-xs hover:bg-sky-500">RECALCULAR POTES</button>
                    <div id="jarSliders" class="space-y-3 mt-2 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg"></div>
                </div>
                <!-- Debts Section -->
                <div class="space-y-3 pt-4">
                    <h4 class="text-xs font-bold text-rose-600 dark:text-rose-400 uppercase border-b border-slate-200 dark:border-slate-700 pb-1">Gestão de Dívidas</h4>
                    <p class="text-[10px] text-slate-500">Cadastre suas dívidas para abatimento no Sniper.</p>
                    <div id="cfgDebtList" class="space-y-2"></div>
                    <div class="flex gap-2"><input id="newDebtName" class="input-std text-xs" placeholder="Nome (Ex: C6)"><input id="newDebtVal" class="input-std text-xs font-mono w-24" placeholder="Total" oninput="maskMoney(this)"><button onclick="addDebtConfig()" class="p-2 bg-rose-100 dark:bg-rose-900/30 text-rose-600 rounded-lg hover:bg-rose-200"><i data-lucide="plus" class="w-3 h-3"></i></button></div>
                </div>
            </div>
            <button onclick="saveConfig()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg transition mt-4">SALVAR TUDO</button>
        </div>
    </div>

    <!-- MODAL CATEGORIES -->
    <div id="modalCats" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800 dark:text-white">Gerenciar Categorias</h3><button onclick="closeModal('modalCats')"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="flex gap-2 mb-4"><input id="newCatName" class="input-std" placeholder="Nome (Ex: Uber)"><select id="newCatJar" class="input-std w-40"></select><button onclick="addNewCategory()" class="bg-emerald-500 text-white p-2 rounded-lg"><i data-lucide="plus" class="w-5 h-5"></i></button></div>
            <div id="catList" class="max-h-60 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <!-- MODAL INFO -->
    <div id="modalInfo" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-slate-800 dark:text-white" id="infoTitle">Titulo</h3><button onclick="closeModal('modalInfo')"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <p id="infoText" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed"></p>
        </div>
    </div>

    <!-- MODAL TRANSACTION -->
    <div id="modalTx" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white" id="mTxTitle">Nova Movimentação</h3>
                <button onclick="closeModal('modalTx')"><i data-lucide="x" class="w-5 h-5 text-slate-400 hover:text-slate-600 dark:hover:text-white"></i></button>
            </div>
            
            <form id="txForm" onsubmit="handleTxSubmit(event)" class="space-y-4">
                <input type="hidden" id="txId">
                
                <!-- TIPO -->
                <div class="grid grid-cols-2 gap-3">
                    <button type="button" onclick="setTxType('out')" id="btnTypeOut" class="py-3 rounded-xl border border-rose-500/50 text-rose-500 font-bold text-sm transition flex justify-center items-center gap-2"><i data-lucide="arrow-up-right"></i> SAÍDA (Gasto)</button>
                    <button type="button" onclick="setTxType('in')" id="btnTypeIn" class="py-3 rounded-xl border border-emerald-500/50 text-emerald-500 font-bold text-sm transition flex justify-center items-center gap-2"><i data-lucide="arrow-down-left"></i> ENTRADA (Renda)</button>
                </div>

                <!-- DESCRIPTION & LOCAL -->
                <div><label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">O que?</label><input id="txDesc" class="input-std" placeholder="Ex: Almoço" required></div>
                <div><label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Onde? (Local)</label><input id="txLocal" class="input-std" placeholder="Ex: Restaurante X"></div>

                <!-- FORM OF PAYMENT (NEW) -->
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Forma de Pagamento</label>
                    <select id="txMethod" class="input-std">
                        <option value="pix">Pix</option>
                        <option value="debit">Débito</option>
                        <option value="credit">Crédito</option>
                        <option value="cash">Dinheiro</option>
                        <option value="transfer">Transferência</option>
                    </select>
                </div>

                <!-- VALOR / DATA -->
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Valor</label><input id="txVal" class="input-std font-mono text-lg" placeholder="R$ 0,00" oninput="maskMoney(this)" required></div>
                    <div><label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Data</label><input type="date" id="txDate" class="input-std" required></div>
                </div>

                <!-- AREA DINAMICA: CATEGORIA (OUT) OU FONTE (IN) -->
                <div id="divCategory">
                    <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Categoria (Define o Pote)</label>
                    <div class="flex gap-2">
                        <select id="txCat" class="input-std flex-1" onchange="checkDebtOption()"></select>
                        <button type="button" onclick="openCatManager()" class="p-2 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-sky-500 hover:border-sky-400 transition" title="Criar Nova Categoria"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <!-- Debt Selector -->
                    <div id="debtSelector" class="hidden mt-2 bg-rose-50 dark:bg-rose-900/20 p-2 rounded border border-rose-100 dark:border-rose-800"><label class="block text-[9px] font-bold text-rose-600 uppercase mb-1">Qual dívida está pagando?</label><select id="txDebtItem" class="input-std text-xs h-8 py-0"></select></div>
                    <div id="jarPreview" class="mt-2 text-xs font-bold text-slate-400 flex items-center gap-2 hidden"><span>Sai do Pote:</span> <span id="jarPreviewTag" class="px-2 py-1 rounded text-white bg-slate-500">...</span></div>
                </div>

                <div id="divSource" class="hidden">
                    <label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Fonte de Renda</label>
                    <select id="txSource" class="input-std"><option value="Salário">Salário</option><option value="Consultoria">Consultoria</option><option value="Venda">Venda</option><option value="Investimentos">Investimentos</option><option value="Repasse (Terceiros)">Repasse (Terceiros)</option><option value="Resgate (Caixinha)">Resgate (Caixinha)</option><option value="Outros">Outros</option></select>
                </div>

                <!-- TERCEIROS TOGGLE -->
                <div class="flex items-center justify-between bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                    <div><div class="text-[10px] font-bold text-slate-600 dark:text-slate-300 uppercase">Movimentação de Terceiros</div><div class="text-[9px] text-slate-400">Ignorar nos gráficos de gastos e potes.</div></div>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" id="txThirdParty" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300"/><label for="txThirdParty" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label></div>
                </div>

                <!-- DETALHES -->
                <div><label class="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Detalhes / Notas</label><textarea id="txNotes" class="input-std" rows="2" placeholder="Ex: Parcela 2/10, Reunião de negócios..."></textarea></div>

                <button type="submit" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-xl shadow-lg transition mt-2">CONFIRMAR LANÇAMENTO</button>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 right-5 bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold shadow-xl transform translate-x-full transition-transform duration-300 z-[200]">Salvo com sucesso!</div>

    <script>
        // --- MASTER CONFIG (FIXED) ---
        const DB_KEY = 'BENAI_FINANCE_MASTER'; // Definitive Key
        const TOKEN_KEY = 'BENAI_GLOBAL_TOKEN'; 
        const GIST_DESC = 'BENAI_FINANCE_DB';
        const GIST_FILENAME = 'finance_master.json';
        
        // MIGRATION CANDIDATES
        const OLD_DB_KEYS = ['benai_fin_v6', 'benai_fin_v5', 'finance_db_v1', 'benai_fin_v4'];
        const OLD_GIST_FILES = ['finance_v5.json', 'finance.json', 'finance_db_v1.json'];

        const DEFAULT_JARS = [
            { id: 'essen', name: 'Necessidades (55%)', perc: 55, color: 'j-essen', icon: 'home', desc: 'Sobrevivência: Aluguel, contas, mercado. Cobre seus Custos Fixos.' },
            { id: 'free', name: 'Lib. Financeira (15%)', perc: 15, color: 'j-free', icon: 'trending-up', desc: 'Investimentos.' },
            { id: 'long', name: 'Sonhos/Reserva (15%)', perc: 15, color: 'j-long', icon: 'piggy-bank', desc: 'Reserva de Emergência, Viagens, Bens.' },
            { id: 'edu', name: 'Educação (5%)', perc: 5, color: 'j-edu', icon: 'book-open', desc: 'Cursos, livros, mentoria.' },
            { id: 'play', name: 'Lazer (10%)', perc: 10, color: 'j-play', icon: 'gamepad-2', desc: 'Torrar sem culpa.' }
        ];

        let db = {
            config: { income: 0, debts: [], jars: DEFAULT_JARS, fixedCosts: [] },
            categories: [
                {id:1, name:'Mercado', jar:'essen'}, 
                {id:2, name:'Aluguel', jar:'essen'},
                {id:3, name:'Amortização Dívida', jar:'free'}, 
                {id:4, name:'Livros/Cursos', jar:'edu'},
                {id:5, name:'Restaurante', jar:'play'}, 
                {id:6, name:'Uber/Transporte', jar:'essen'},
                {id:7, name:'Investimento', jar:'free'},
                {id:8, name:'Presentes', jar:'play'},
                {id:9, name:'Reserva Emergência', jar:'long'},
                {id:10, name:'Cartão C6 (Total)', jar:'essen'},
                {id:11, name:'Netflix (Repasse)', jar:'essen'},
                {id:12, name:'Repasse/Terceiros', jar:'essen'}
            ],
            transactions: [],
            lastUpdated: 0
        };

        let currentType = 'out';
        let viewDate = new Date();
        let chartInstance = null;

        // INIT
        window.onload = async () => {
            lucide.createIcons();
            initTheme();
            
            const shield = document.getElementById('cloud-shield');
            const hasToken = localStorage.getItem(TOKEN_KEY);
            let loadedFromCloud = false;

            if (hasToken) {
                document.getElementById('manualToken').value = hasToken;
                updateSyncUI(true);
                try {
                    // Try cloud load with migration support
                    loadedFromCloud = await forceCloudLoad();
                } catch (e) {
                    console.error("Shield Error", e);
                }
            }
            
            if(!loadedFromCloud) {
                // If cloud failed or no token, try local load with migration support
                loadLocal();
                updateSyncUI(false);
            }

            // Ensure data structure is sound
            sanitizeData(db);
            
            // Fade out shield
            shield.style.opacity = '0';
            setTimeout(() => shield.style.display = 'none', 500);

            if (loadedFromCloud) toast('Nuvem Sincronizada (Dados Mestre)');
            else if (hasToken) toast('Offline (Usando cache local)');

            updateDateDisplay();
            renderAll();
            updateFilterCats();
        };

        // --- MIGRATION & DATA HANDLING ---

        function sanitizeData(data) {
            // Guarantees the structure supports new features without breaking
            if(!data.transactions) data.transactions = [];
            
            // Fix transactions
            data.transactions.forEach(t => {
                if(!t.method) t.method = 'pix'; // Default payment for old entries
                if(!t.date) t.date = new Date().toISOString().split('T')[0];
                if(t.date.includes('/')) { // Fix DD/MM/YYYY to YYYY-MM-DD
                    const [d, m, y] = t.date.split('/');
                    t.date = `${y}-${m}-${d}`;
                }
                if(!t.id) t.id = Date.now() + Math.random();
            });

            // Fix config
            if(!data.config) data.config = {};
            if(!data.config.jars) data.config.jars = DEFAULT_JARS;
            
            return data;
        }

        function loadLocal() {
            // 1. Try Master Key
            const saved = localStorage.getItem(DB_KEY);
            if(saved) {
                try {
                    db = JSON.parse(saved);
                    return;
                } catch(e) { console.error("Corrupt Master DB", e); }
            }

            // 2. Try Old Keys (Migration)
            for(const key of OLD_DB_KEYS) {
                const oldData = localStorage.getItem(key);
                if(oldData) {
                    try {
                        console.log(`Migrating from ${key}...`);
                        const parsed = JSON.parse(oldData);
                        db = sanitizeData(parsed);
                        db.lastUpdated = Date.now();
                        localStorage.setItem(DB_KEY, JSON.stringify(db)); // Save to Master
                        toast("Dados antigos recuperados localmente!");
                        return;
                    } catch(e) { console.error(`Failed to migrate ${key}`, e); }
                }
            }
        }

        async function forceCloudLoad() {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) return false;
            
            const headers = { 'Authorization': `token ${token}` };
            try {
                const res = await fetch('https://api.github.com/gists', { headers });
                if (!res.ok) return false;
                
                const gists = await res.json();
                const found = gists.find(g => g.description === GIST_DESC);
                
                if (found) {
                    db.gistId = found.id;
                    const r = await fetch(found.url, { headers });
                    const data = await r.json();
                    
                    // 1. Look for Master File
                    if (data.files[GIST_FILENAME]) {
                        const cloudData = JSON.parse(data.files[GIST_FILENAME].content);
                        db = sanitizeData(cloudData);
                        localStorage.setItem(DB_KEY, JSON.stringify(db));
                        return true;
                    }

                    // 2. Look for Old Files (Migration)
                    for(const oldFile of OLD_GIST_FILES) {
                        if(data.files[oldFile]) {
                            console.log(`Migrating from cloud file: ${oldFile}`);
                            const oldContent = JSON.parse(data.files[oldFile].content);
                            db = sanitizeData(oldContent);
                            db.lastUpdated = Date.now();
                            localStorage.setItem(DB_KEY, JSON.stringify(db)); // Save local master
                            
                            // Trigger async save to create Master File in cloud
                            syncData(true); 
                            toast("Dados antigos recuperados da nuvem!");
                            return true;
                        }
                    }
                }
            } catch (e) { console.error("Cloud Error", e); return false; }
            return false;
        }

        async function syncData(silent = false) {
            const token = localStorage.getItem(TOKEN_KEY);
            if(!token) {
                if(!silent) alert("Configure o Token Global.");
                return;
            }
            
            // Ensure local DB is updated before sending
            localStorage.setItem(DB_KEY, JSON.stringify(db));

            const headers = { 'Authorization': `token ${token}` };
            try {
                if(!silent) toast('Sincronizando...');
                
                if(!db.gistId) {
                    // Search for Gist ID again if lost
                    const res = await fetch('https://api.github.com/gists', { headers });
                    const gists = await res.json();
                    const found = gists.find(g => g.description === GIST_DESC);
                    if(found) db.gistId = found.id;
                }

                if(db.gistId) {
                    // Create payload with NEW filename
                    const filesPayload = {};
                    filesPayload[GIST_FILENAME] = { content: JSON.stringify(db) };
                    
                    // Optional: Nullify old files to delete them? 
                    // No, let's keep them for safety for now.

                    const body = JSON.stringify({
                        description: GIST_DESC,
                        public: false,
                        files: filesPayload
                    });

                    let url = `https://api.github.com/gists/${db.gistId}`;
                    await fetch(url, { method: 'PATCH', headers, body });
                    if(!silent) toast('Dados Salvos na Nuvem!');
                }
            } catch(e) {
                console.error(e);
                if(!silent) alert("Erro de sincronização.");
            }
        }

        // --- UI HELPERS ---
        function updateSyncUI(isActive) {
            const dot = document.getElementById('cloudStatusDot');
            if(isActive) dot.className = "sync-dot active";
            else dot.className = "sync-dot inactive";
        }

        function changeMonth(dir) {
            viewDate.setMonth(viewDate.getMonth() + dir);
            updateDateDisplay();
            renderAll();
        }

        function setSpecificMonth(val) {
            if(!val) return;
            const [y, m] = val.split('-');
            viewDate = new Date(parseInt(y), parseInt(m) - 1, 1);
            updateDateDisplay();
            renderAll();
        }

        function updateDateDisplay() {
            const m = viewDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('mainDateDisplay').innerText = m.toUpperCase();
        }

        function initTheme() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').setAttribute('data-lucide', 'sun');
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('themeIcon').setAttribute('data-lucide', 'moon');
            }
        }

        function toggleLocalTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('themeIcon').setAttribute('data-lucide', 'moon');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeIcon').setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
        }

        function saveLocal() {
            db.lastUpdated = Date.now();
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderAll();
        }

        // RENDER FUNCTIONS
        function renderAll() {
            renderSummary();
            renderDebtSniper();
            renderJars();
            renderTransactions();
            renderDailyChart();
            updateCategorySelect();
        }

        function renderSummary() {
            const currentMonth = viewDate.toISOString().slice(0, 7); 
            
            const allIn = db.transactions
                .filter(t => t.date.startsWith(currentMonth) && t.type === 'in')
                .reduce((acc, t) => acc + t.val, 0);

            const allOut = db.transactions
                .filter(t => t.date.startsWith(currentMonth) && t.type === 'out')
                .reduce((acc, t) => acc + t.val, 0);
            
            const myIncome = db.transactions
                .filter(t => t.date.startsWith(currentMonth) && t.type === 'in' && !t.thirdParty)
                .reduce((acc, t) => acc + t.val, 0);

            const mySpent = db.transactions
                .filter(t => t.date.startsWith(currentMonth) && t.type === 'out' && !t.thirdParty)
                .reduce((acc, t) => acc + t.val, 0);
            
            const netBank = allIn - allOut; 
            document.getElementById('dispBankBalance').innerText = fmtMoney(netBank);
            if(netBank < 0) document.getElementById('dispBankBalance').className = "text-2xl font-bold text-rose-500 font-mono mt-1";
            else document.getElementById('dispBankBalance').className = "text-2xl font-bold text-blue-600 dark:text-blue-400 font-mono mt-1";

            document.getElementById('dispMyIncome').innerText = fmtMoney(myIncome);
            document.getElementById('dispMySpent').innerText = fmtMoney(mySpent);
        }

        function renderDebtSniper() {
            const list = document.getElementById('debtList');
            list.innerHTML = '';
            
            let totalPaid = 0;
            let totalTarget = 0;

            if(!db.config.debts || db.config.debts.length === 0) {
                list.innerHTML = '<div class="text-center text-xs text-slate-400 italic">Nenhuma dívida cadastrada.</div>';
            } else {
                db.config.debts.forEach(d => {
                    const paid = db.transactions
                        .filter(t => t.type === 'out' && t.debtId === d.id)
                        .reduce((acc, t) => acc + t.val, 0);
                    
                    totalPaid += paid;
                    totalTarget += d.val;
                    
                    const pct = Math.min((paid / d.val) * 100, 100);
                    
                    list.innerHTML += `
                    <div>
                        <div class="flex justify-between text-xs font-bold text-rose-700 dark:text-rose-300 mb-1">
                            <span>${d.name}</span>
                            <span>${fmtMoney(paid)} / ${fmtMoney(d.val)}</span>
                        </div>
                        <div class="relative w-full h-2 bg-rose-200 dark:bg-rose-900/50 rounded-full overflow-hidden">
                            <div class="absolute top-0 left-0 h-full bg-rose-500" style="width: ${pct}%"></div>
                        </div>
                    </div>`;
                });
            }

            document.getElementById('debtTotalPaid').innerText = fmtMoney(totalPaid);
            const remaining = Math.max(0, totalTarget - totalPaid);
            document.getElementById('debtTotalRemaining').innerText = fmtMoney(remaining);
        }

        function renderJars() {
            const container = document.getElementById('jarsContainer');
            container.innerHTML = '';
            
            const estimatedIncome = db.config.income || 1;
            const currentMonth = viewDate.toISOString().slice(0, 7);

            db.config.jars.forEach(jar => {
                let limit = jar.limitVal || (estimatedIncome * jar.perc) / 100;
                
                const spent = db.transactions
                    .filter(t => t.date.startsWith(currentMonth) && t.type === 'out' && !t.thirdParty)
                    .filter(t => {
                        const cat = db.categories.find(c => c.name === t.cat);
                        return cat && cat.jar === jar.id;
                    })
                    .reduce((acc, t) => acc + t.val, 0);

                const pct = limit > 0 ? (spent / limit) * 100 : 0;
                const available = Math.max(0, limit - spent);
                
                let statusColor = 'bg-emerald-500'; 
                if(pct > 80) statusColor = 'bg-amber-500'; 
                if(pct > 100) statusColor = 'bg-rose-500'; 

                const card = document.createElement('div');
                card.className = `glass p-5 rounded-2xl jar-card ${jar.color} relative overflow-hidden group`;
                card.innerHTML = `
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="showInfo('${jar.id}')" class="text-slate-400 hover:text-sky-500"><i data-lucide="info" class="w-4 h-4"></i></button>
                    </div>
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">${jar.name}</span>
                                <span class="text-[10px] bg-slate-200 dark:bg-slate-800 px-2 py-0.5 rounded text-sky-600 dark:text-sky-400 font-mono">${Math.round(jar.perc)}%</span>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white font-mono">${fmtMoney(available)}</h3>
                            <span class="text-[10px] text-slate-500">Meta: ${fmtMoney(limit)}</span>
                        </div>
                        <div class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-[var(--c)]">
                            <i data-lucide="${jar.icon}" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div class="relative w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div class="absolute top-0 left-0 h-full ${statusColor} transition-all duration-1000" style="width: ${Math.min(pct, 100)}%"></div>
                    </div>
                    <div class="mt-2 text-[10px] font-bold ${pct > 100 ? 'text-rose-500' : 'text-slate-500'} text-right">
                        ${pct > 100 ? 'ORÇAMENTO ESTOURADO!' : `${Math.round(pct)}% Utilizado`}
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function renderTransactions() {
            const list = document.getElementById('txList');
            const search = document.getElementById('filterText') ? document.getElementById('filterText').value.toLowerCase() : '';
            const filterCat = document.getElementById('filterCat') ? document.getElementById('filterCat').value : '';
            const filterDate = document.getElementById('filterDate') ? document.getElementById('filterDate').value : '';
            const hideThirdParty = document.getElementById('filterHideThirdParty') ? document.getElementById('filterHideThirdParty').checked : false;
            
            const currentMonth = viewDate.toISOString().slice(0, 7);
            
            // Populate Date Filter
            const dateSel = document.getElementById('filterDate');
            if (dateSel && dateSel.options.length <= 1) { 
                const dates = [...new Set(db.transactions.filter(t => t.date.startsWith(currentMonth)).map(t => t.date))].sort().reverse();
                dateSel.innerHTML = '<option value="">Todas as Datas</option>';
                dates.forEach(d => {
                    const [y, m, day] = d.split('-');
                    dateSel.add(new Option(`${day}/${m}`, d));
                });
            }

            list.innerHTML = '';

            let filtered = db.transactions.filter(t => t.date.startsWith(currentMonth));

            // Apply Filters
            if(hideThirdParty) filtered = filtered.filter(t => !t.thirdParty);
            if(filterCat) filtered = filtered.filter(t => t.cat === filterCat);
            if(filterDate) filtered = filtered.filter(t => t.date === filterDate);
            if(search) {
                filtered = filtered.filter(t => 
                    (t.desc && t.desc.toLowerCase().includes(search)) || 
                    (t.local && t.local.toLowerCase().includes(search))
                );
            }
            
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date));

            if(filtered.length === 0) {
                list.innerHTML = '<div class="text-center p-8 text-slate-500 text-xs italic">Nenhuma movimentação encontrada.</div>';
                return;
            }

            filtered.forEach(t => {
                const isOut = t.type === 'out';
                let iconColor = isOut ? 'text-rose-500' : 'text-emerald-500';
                
                let subLabel = "";
                
                if(isOut) {
                    subLabel = `<span class="text-rose-400 font-bold">${t.cat}</span>`;
                } else {
                    subLabel = `<span class="text-emerald-400 font-bold">${t.source || 'Entrada'}</span>`;
                }
                
                // Badges
                let badges = "";
                if(t.thirdParty) badges += `<span class="ml-2 text-[9px] bg-slate-200 dark:bg-slate-700 px-1 rounded text-slate-500">Terceiros</span>`;
                if(t.debtId) {
                    const d = (db.config.debts || []).find(x=>x.id===t.debtId);
                    if(d) badges += `<span class="ml-2 text-[9px] bg-rose-100 dark:bg-rose-900/30 px-1 rounded text-rose-500">Dívida: ${d.name}</span>`;
                }
                
                // Payment Method Badge
                if(t.method) {
                    let mColor = "bg-slate-100 text-slate-500";
                    let mIcon = "credit-card";
                    if(t.method === 'pix') { mColor = "bg-emerald-100 text-emerald-600"; mIcon="zap"; }
                    if(t.method === 'credit') { mColor = "bg-purple-100 text-purple-600"; mIcon="credit-card"; }
                    if(t.method === 'debit') { mColor = "bg-blue-100 text-blue-600"; mIcon="credit-card"; }
                    if(t.method === 'cash') { mColor = "bg-amber-100 text-amber-600"; mIcon="banknote"; }
                    
                    badges += `<span class="ml-2 text-[9px] ${mColor} px-1.5 py-0.5 rounded flex items-center gap-1 inline-flex"><i data-lucide="${mIcon}" class="w-2 h-2"></i> ${t.method.toUpperCase()}</span>`;
                }

                const location = t.local ? `<div class="flex items-center gap-1 text-[10px] text-slate-500"><i data-lucide="map-pin" class="w-3 h-3"></i> ${t.local}</div>` : '';

                const el = document.createElement('div');
                el.className = 'p-3 hover:bg-slate-100 dark:hover:bg-slate-800/50 rounded-lg flex items-center justify-between group transition border-b border-slate-100 dark:border-slate-800/50 last:border-0';
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center ${iconColor}">
                            <i data-lucide="${isOut ? 'arrow-up-right' : 'arrow-down-left'}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <div class="text-sm font-bold text-slate-800 dark:text-white flex items-center flex-wrap gap-1">${t.desc} ${badges}</div>
                            ${location}
                            <div class="text-xs text-slate-500 flex items-center mt-0.5">
                                ${subLabel}
                                <span class="text-slate-400 mx-1">•</span> ${fmtDate(t.date)}
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold font-mono ${isOut ? 'text-rose-500' : 'text-emerald-500'}">
                            ${isOut ? '-' : '+'} ${fmtMoney(t.val)}
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition flex justify-end gap-2 mt-1">
                            <button onclick="editTx(${t.id})" class="text-sky-500 hover:text-sky-700 dark:hover:text-white"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                            <button onclick="delTx(${t.id})" class="text-rose-500 hover:text-rose-700 dark:hover:text-white"><i data-lucide="trash" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderDailyChart() {
            const ctx = document.getElementById('dailyChart');
            if(!ctx) return;
            if(chartInstance) chartInstance.destroy();

            const currentMonth = viewDate.toISOString().slice(0, 7);
            const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
            const labels = [];
            const data = [];
            
            for(let i=1; i<=daysInMonth; i++) labels.push(i);
            
            labels.forEach(d => {
                const dateStr = `${currentMonth}-${String(d).padStart(2,'0')}`;
                const dailySum = db.transactions
                    .filter(t => t.date === dateStr && t.type === 'out' && !t.thirdParty)
                    .reduce((acc, t) => acc + t.val, 0);
                data.push(dailySum);
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gasto Pessoal (R$)',
                        data: data,
                        backgroundColor: '#0ea5e9',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: {size: 8} } },
                        y: { border: { display: false }, grid: { color: '#334155' }, ticks: { display: false } }
                    }
                }
            });
        }

        // --- FILTERS ---
        function toggleFilters() { document.getElementById('filterPanel').classList.toggle('hidden'); }
        function updateFilterCats() {
            const sel = document.getElementById('filterCat');
            sel.innerHTML = '<option value="">Todas Categorias</option>';
            db.categories.forEach(c => { sel.add(new Option(c.name, c.name)); });
        }

        // --- CONFIG ---
        function openConfig() {
            document.getElementById('cfgIncome').value = fmtMoney(db.config.income);
            renderFixedList(); renderSliders(); renderDebtConfigList();
            openModal('modalConfig');
        }
        function renderDebtConfigList() {
            const div = document.getElementById('cfgDebtList'); div.innerHTML = '';
            (db.config.debts || []).forEach((d, i) => {
                div.innerHTML += `<div class="flex justify-between items-center text-xs p-2 bg-white dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700"><span class="text-slate-700 dark:text-slate-300 font-bold">${d.name}</span><div class="flex items-center gap-2"><span class="font-mono text-slate-500">${fmtMoney(d.val)}</span><i data-lucide="trash" class="w-3 h-3 text-rose-400 cursor-pointer" onclick="removeDebtConfig(${i})"></i></div></div>`;
            });
            lucide.createIcons();
        }
        function addDebtConfig() {
            const n = document.getElementById('newDebtName').value;
            const v = parseMoney(document.getElementById('newDebtVal').value);
            if(n && v) {
                if(!db.config.debts) db.config.debts = [];
                db.config.debts.push({ id: Date.now().toString(), name: n, val: v });
                document.getElementById('newDebtName').value = ''; document.getElementById('newDebtVal').value = ''; renderDebtConfigList();
            }
        }
        function removeDebtConfig(i) { db.config.debts.splice(i,1); renderDebtConfigList(); }
        function applyPreset(type) {
            const income = parseMoney(document.getElementById('cfgIncome').value) || 1000;
            let p = { essen:55, free:15, long:15, edu:5, play:10 };
            if(type==='balanced') p = { essen:50, free:20, long:20, edu:5, play:5 };
            if(type==='aggressive') p = { essen:40, free:30, long:20, edu:5, play:5 };
            db.config.jars.forEach(j => { j.perc = p[j.id]; j.limitVal = (income * j.perc) / 100; });
            renderSliders();
        }
        function renderFixedList() {
            const div = document.getElementById('fixedList'); div.innerHTML = '';
            (db.config.fixedCosts || []).forEach((c, i) => {
                div.innerHTML += `<div class="flex justify-between items-center text-xs p-2 bg-white dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700"><span class="text-slate-700 dark:text-slate-300 font-bold">${c.name}</span><div class="flex items-center gap-2"><span class="font-mono text-slate-500">${fmtMoney(c.val)}</span><i data-lucide="trash" class="w-3 h-3 text-rose-400 cursor-pointer" onclick="removeFixed(${i})"></i></div></div>`;
            });
            lucide.createIcons();
        }
        function addFixedCost() { const n = document.getElementById('newFixedName').value; const v = parseMoney(document.getElementById('newFixedVal').value); if(n && v) { db.config.fixedCosts.push({name: n, val: v}); document.getElementById('newFixedName').value = ''; document.getElementById('newFixedVal').value = ''; renderFixedList(); }}
        function removeFixed(i) { db.config.fixedCosts.splice(i,1); renderFixedList(); }
        function runSmartCalc() { applyPreset('conservative'); } 
        function renderSliders() {
            const div = document.getElementById('jarSliders'); div.innerHTML = '';
            const inc = parseMoney(document.getElementById('cfgIncome').value);
            db.config.jars.forEach((jar) => {
                const val = jar.limitVal || (inc * jar.perc / 100);
                div.innerHTML += `<div><div class="flex justify-between text-[10px] font-bold text-slate-500 dark:text-slate-300 mb-1"><span>${jar.name}</span><span class="text-sky-500">${fmtMoney(val)} (${Math.round(jar.perc)}%)</span></div><div class="w-full h-1 bg-slate-200 dark:bg-slate-700 rounded-lg overflow-hidden"><div class="h-full bg-sky-500" style="width:${jar.perc}%"></div></div></div>`;
            });
        }
        function saveConfig() { db.config.income = parseMoney(document.getElementById('cfgIncome').value); saveLocal(); closeModal('modalConfig'); toast('Configurações Salvas!'); }

        // --- TX LOGIC ---
        function openTransactionModal() {
            document.getElementById('txForm').reset();
            document.getElementById('txId').value = '';
            document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('mTxTitle').innerText = "Nova Movimentação";
            document.getElementById('txMethod').value = 'pix';
            setTxType('out');
            checkDebtOption();
            openModal('modalTx');
        }
        function checkDebtOption() {
            const cat = document.getElementById('txCat').value;
            const div = document.getElementById('debtSelector');
            const sel = document.getElementById('txDebtItem');
            if(cat.toLowerCase().includes('dívida') || cat.toLowerCase().includes('amortização')) {
                div.classList.remove('hidden');
                sel.innerHTML = '<option value="">(Opcional) Selecione a Dívida</option>';
                (db.config.debts || []).forEach(d => sel.add(new Option(d.name, d.id)));
            } else { div.classList.add('hidden'); sel.value = ""; }
            updateJarPreview();
        }
        function setTxType(type) {
            currentType = type;
            const btnIn = document.getElementById('btnTypeIn');
            const btnOut = document.getElementById('btnTypeOut');
            const divCat = document.getElementById('divCategory');
            const divSrc = document.getElementById('divSource');
            if(type === 'in') {
                btnIn.className = "py-3 rounded-xl border border-emerald-500 bg-emerald-100 dark:bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 font-bold text-sm transition flex justify-center items-center gap-2 ring-2 ring-emerald-500 ring-offset-2 dark:ring-offset-slate-800";
                btnOut.className = "py-3 rounded-xl border border-slate-300 dark:border-slate-700 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm transition flex justify-center items-center gap-2 opacity-50";
                divCat.style.display = 'none'; divSrc.style.display = 'block';
            } else {
                btnOut.className = "py-3 rounded-xl border border-rose-500 bg-rose-100 dark:bg-rose-500/20 text-rose-600 dark:text-rose-400 font-bold text-sm transition flex justify-center items-center gap-2 ring-2 ring-rose-500 ring-offset-2 dark:ring-offset-slate-800";
                btnIn.className = "py-3 rounded-xl border border-slate-300 dark:border-slate-700 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm transition flex justify-center items-center gap-2 opacity-50";
                divCat.style.display = 'block'; divSrc.style.display = 'none';
                updateCategorySelect();
            }
        }
        function updateCategorySelect() {
            const sel = document.getElementById('txCat');
            const currentVal = sel.value;
            sel.innerHTML = '';
            db.config.jars.forEach(jar => {
                const group = document.createElement('optgroup'); group.label = jar.name;
                const cats = db.categories.filter(c => c.jar === jar.id);
                cats.forEach(c => { const opt = document.createElement('option'); opt.value = c.name; opt.innerText = c.name; group.appendChild(opt); });
                if(cats.length > 0) sel.appendChild(group);
            });
            if(currentVal) sel.value = currentVal;
            checkDebtOption();
        }
        function updateJarPreview() {
            const catName = document.getElementById('txCat').value;
            const cat = db.categories.find(c => c.name === catName);
            const preview = document.getElementById('jarPreview');
            const tag = document.getElementById('jarPreviewTag');
            if(cat) {
                const jar = db.config.jars.find(j => j.id === cat.jar);
                if(jar) {
                    preview.classList.remove('hidden');
                    tag.innerText = jar.name;
                    const colors = {'j-essen':'bg-blue-500', 'j-free':'bg-purple-500', 'j-edu':'bg-cyan-500', 'j-long':'bg-emerald-500', 'j-play':'bg-amber-500', 'j-give':'bg-pink-500'};
                    tag.className = `px-2 py-1 rounded text-white font-bold text-[10px] uppercase ${colors[jar.color]||'bg-slate-500'}`;
                }
            } else { preview.classList.add('hidden'); }
        }
        function handleTxSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('txId').value;
            const desc = document.getElementById('txDesc').value;
            const local = document.getElementById('txLocal').value;
            const notes = document.getElementById('txNotes').value;
            const val = parseMoney(document.getElementById('txVal').value);
            const date = document.getElementById('txDate').value;
            const thirdParty = document.getElementById('txThirdParty').checked;
            const method = document.getElementById('txMethod').value;
            let cat = ""; let source = ""; let debtId = "";
            if(currentType === 'out') {
                cat = document.getElementById('txCat').value;
                debtId = document.getElementById('txDebtItem').value;
                if(!cat) return alert("Selecione uma Categoria");
            } else { source = document.getElementById('txSource').value; }
            const tx = { id: id ? parseInt(id) : Date.now(), type: currentType, desc, local, notes, val, date, cat, source, thirdParty, debtId, method };
            if(id) { const idx = db.transactions.findIndex(t => t.id == id); if(idx > -1) db.transactions[idx] = tx; } else { db.transactions.push(tx); }
            document.getElementById('filterDate').innerHTML = '<option value="">Todas as Datas</option>';
            saveLocal();
            // Trigger background cloud save to create master file if it doesn't exist
            syncData(true);
            closeModal('modalTx');
            toast('Movimentação Registrada!');
        }
        function editTx(id) {
            const t = db.transactions.find(x => x.id === id); if(!t) return;
            document.getElementById('txId').value = t.id;
            document.getElementById('txDesc').value = t.desc;
            document.getElementById('txLocal').value = t.local || '';
            document.getElementById('txNotes').value = t.notes || '';
            document.getElementById('txVal').value = fmtMoney(t.val);
            document.getElementById('txDate').value = t.date;
            document.getElementById('txThirdParty').checked = !!t.thirdParty;
            document.getElementById('txMethod').value = t.method || 'pix';
            setTxType(t.type);
            if(t.type === 'out') {
                document.getElementById('txCat').value = t.cat;
                checkDebtOption();
                document.getElementById('txDebtItem').value = t.debtId || '';
            } else { document.getElementById('txSource').value = t.source; }
            document.getElementById('mTxTitle').innerText = "Editar Movimentação";
            openModal('modalTx');
        }
        function delTx(id) {
            if(confirm("Excluir registro?")) {
                db.transactions = db.transactions.filter(t => t.id !== id);
                document.getElementById('filterDate').innerHTML = '<option value="">Todas as Datas</option>';
                saveLocal();
                syncData(true);
                toast('Registro Excluído');
            }
        }

        // --- CLOUD/BACKUP ---
        function openCloudModal() { document.getElementById('manualToken').value = localStorage.getItem(TOKEN_KEY) || ''; openModal('modalCloud'); }
        function saveLocalToken() { const t = document.getElementById('manualToken').value.trim(); if(t) { localStorage.setItem(TOKEN_KEY, t); updateSyncUI(true); toast('Token Salvo! Sincronizando...'); syncData(true); } }
        function backupData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(db,null,2)],{type:"application/json"})); a.download=`finance_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); toast('Backup baixado!'); }
        function restoreData(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(confirm("Substituir dados atuais?")) {
                        db = sanitizeData(json); // Use Sanitizer here too
                        saveLocal();
                        syncData(true);
                        toast('Restaurado!');
                        setTimeout(() => location.reload(), 1000);
                    }
                } catch(err) { alert("Erro JSON."); }
            };
            reader.readAsText(file);
        }

        // --- UTILS ---
        function openCatManager() { document.getElementById('modalCats').style.display = 'flex'; renderCatList(); const s = document.getElementById('newCatJar'); s.innerHTML = ''; db.config.jars.forEach(j => s.add(new Option(j.name, j.id))); }
        function renderCatList() { const div = document.getElementById('catList'); div.innerHTML = ''; db.categories.forEach((c, i) => { const jar = db.config.jars.find(j=>j.id===c.jar); div.innerHTML += `<div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700"><div><div class="font-bold text-sm text-slate-700 dark:text-slate-300">${c.name}</div><div class="text-[10px] text-slate-400">${jar ? jar.name : '?'}</div></div><i data-lucide="trash" class="w-4 h-4 text-rose-400 cursor-pointer" onclick="deleteCat(${i})"></i></div>`; }); lucide.createIcons(); }
        function addNewCategory() { const name = document.getElementById('newCatName').value; const jar = document.getElementById('newCatJar').value; if(name && jar) { db.categories.push({id:Date.now(), name, jar}); saveLocal(); renderCatList(); document.getElementById('newCatName').value = ''; updateCategorySelect(); updateFilterCats(); } }
        function deleteCat(i) { db.categories.splice(i,1); saveLocal(); renderCatList(); updateCategorySelect(); updateFilterCats(); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showInfo(jarId) { const jar = db.config.jars.find(j => j.id === jarId); if(jar) { document.getElementById('infoTitle').innerText = jar.name; document.getElementById('infoText').innerText = jar.desc || "Sem descrição."; openModal('modalInfo'); } }
        function editDebtTarget() { openConfig(); }
        function toast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.remove('translate-x-full'); setTimeout(()=>t.classList.add('translate-x-full'), 3000); }
        function maskMoney(i) { let v = i.value.replace(/\D/g,''); v = (v/100).toFixed(2) + ''; v = v.replace(".", ","); v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); i.value = 'R$ ' + v; }
        function parseMoney(s) { return parseFloat(s.replace(/[^0-9,]/g,'').replace(',','.')) || 0; }
        function fmtMoney(n) { return n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        function fmtDate(d) { return d.split('-').reverse().join('/'); }

    </script>
</body>
</html>
