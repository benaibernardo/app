<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Benai - Nutri√ß√£o Cloud</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        (function() {
            // --- CONFIGURA√á√ÉO DA SENHA ---
            const PIN_CORRETO = "16359001"; 
            const type = sessionStorage.getItem("benai_access_type");
            if (type === "master" || type === "guest" || sessionStorage.getItem("benai_access_granted") === "true") return;

            document.write(`
                <style>
                    body { visibility: hidden; overflow: hidden; }
                    #gatekeeper {
                        visibility: visible; position: fixed; inset: 0;
                        background: #0f172a; color: white; z-index: 99999;
                        display: flex; flex-direction: column; align-items: center; justify-content: center;
                        font-family: 'Outfit', sans-serif;
                    }
                    .pin-box { text-align: center; animation: fadeIn 0.5s ease; width: 90%; max-width: 350px; }
                    .pin-inp { 
                        padding: 15px; font-size: 1.5rem; text-align: center; 
                        border-radius: 15px; border: 2px solid rgba(56, 189, 248, 0.3); outline: none; margin-top: 25px;
                        background: rgba(255,255,255,0.05); color: white; letter-spacing: 4px; width: 100%;
                        transition: 0.3s; 
                    }
                    .pin-inp:focus { border-color: #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
                    .pin-msg { color: #f87171; margin-top: 15px; font-weight: 600; font-size: 0.9rem; height: 20px; }
                    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                </style>
                <div id="gatekeeper">
                    <div class="pin-box">
                        <i class="fa-solid fa-shield-halved" style="font-size: 3rem; color: #38bdf8; margin-bottom: 15px;"></i>
                        <h2 style="font-size: 1.5rem; letter-spacing: -1px;">Sistema Protegido</h2>
                        <p style="opacity: 0.6; font-size: 0.85rem;">Insira o c√≥digo de 8 d√≠gitos</p>
                        <input type="password" class="pin-inp" maxlength="8" placeholder="********" inputmode="numeric" autocomplete="off" onkeyup="verifyPin(this)">
                        <div class="pin-msg" id="pin-error"></div>
                    </div>
                </div>
            `);

            window.verifyPin = function(el) {
                if (el.value.length === 8) {
                    if (el.value === PIN_CORRETO) {
                        sessionStorage.setItem("benai_access_granted", "true");
                        location.reload();
                    } else {
                        document.getElementById("pin-error").innerText = "C√≥digo Incorreto";
                        el.value = "";
                        if(navigator.vibrate) navigator.vibrate(200);
                    }
                }
            };
        })();
    </script>

    <style>
        :root {
            --bg: #fdfbf7; --card: #ffffff; --text: #334155;
            --primary: #15803d; --accent: #22c55e; --border: #e2e8f0;
            --danger: #ef4444; --success: #10b981;
            --prot-bg: #eff6ff; --prot-text: #1d4ed8;
            --carb-bg: #fff7ed; --carb-text: #c2410c;
            --fat-bg: #fefce8;  --fat-text: #a16207;
            --veg-bg: #f0fdf4;  --veg-text: #15803d;
            --radius: 20px; --font: 'Plus Jakarta Sans', sans-serif; --font-num: 'Outfit', sans-serif;
            --shadow: 0 8px 30px rgba(0,0,0,0.04);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:var(--font); outline:none; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); padding:20px 20px 100px 20px; font-size:14px; }
        .container { max-width:600px; margin:0 auto; animation:fadeIn 0.5s ease; }

        /* HEADER */
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .logo { font-size:1.4rem; font-weight:800; color:var(--primary); letter-spacing:-0.5px; display:flex; align-items:center; gap:10px; font-family:var(--font-num); }
        .logo i { background:var(--prot-bg); color:var(--primary); padding:8px; border-radius:12px; font-size:1rem; }
        
        .header-actions { display:flex; gap:10px; }
        .action-btn { width:42px; height:42px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:#64748b; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; box-shadow:var(--shadow); position: relative; }
        .action-btn:hover { color:var(--primary); border-color:var(--primary); transform:translateY(-2px); }
        .action-btn.sync { color:var(--accent); background:rgba(34, 197, 94, 0.05); }

        .cloud-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; position:absolute; top:8px; right:8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .cloud-dot.ok { background: var(--success); }
        .cloud-dot.error { background: var(--danger); }
        .cloud-dot.sync { background: var(--accent); animation: pulse 1s infinite; }

        /* VIEWS */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }

        /* CARDS */
        .meta-card { background:linear-gradient(135deg, #15803d 0%, #166534 100%); color:white; border-radius:24px; padding:25px; margin-bottom:25px; box-shadow:0 10px 25px rgba(21, 128, 61, 0.25); position:relative; overflow:hidden; }
        .meta-lbl { font-size:0.85rem; opacity:0.9; font-weight:600; margin-bottom:5px; display:block; text-transform:uppercase; }
        .meta-val { font-size:2.5rem; font-weight:800; line-height:1; font-family:var(--font-num); }
        .meta-sub { display:flex; gap:15px; margin-top:15px; }
        .tag-status { background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:10px; font-weight:700; font-size:0.85rem; backdrop-filter:blur(5px); display:flex; align-items:center; gap:6px; }

        .day-toggle { display:flex; background:white; padding:5px; border-radius:16px; margin-bottom:20px; border:1px solid var(--border); box-shadow:var(--shadow); }
        .toggle-btn { flex:1; padding:12px; text-align:center; font-weight:700; color:#64748b; border-radius:12px; cursor:pointer; font-size:0.9rem; transition:0.2s; }
        .toggle-btn.active { background:var(--primary); color:white; box-shadow:0 4px 10px rgba(21, 128, 61, 0.2); }

        /* MEALS */
        .meal-card { background:var(--card); border-radius:22px; margin-bottom:20px; box-shadow:var(--shadow); border:1px solid var(--border); overflow:hidden; }
        .meal-head { padding:15px 20px; background:#f8fafc; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .mh-left { display:flex; align-items:center; gap:10px; }
        .meal-name { font-weight:800; color:#1e293b; font-size:1rem; }
        .meal-time { font-weight:700; color:#64748b; font-size:0.8rem; background:white; padding:4px 10px; border-radius:8px; border:1px solid var(--border); font-family:var(--font-num); }

        .food-item { padding:14px 20px; border-bottom:1px dashed #f1f5f9; display:flex; justify-content:space-between; align-items:center; }
        .food-item:last-child { border:none; }
        .fi-main { display:flex; align-items:center; gap:12px; }
        .fi-icon { font-size:1.4rem; width:30px; text-align:center; }
        .fi-info { display:flex; flex-direction:column; }
        .fi-name { font-weight:700; color:#334155; font-size:0.95rem; }
        .fi-macro { font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; opacity:0.6; }
        .fi-actions { display:flex; align-items:center; gap:8px; }
        .fi-qty { font-weight:800; padding:6px 12px; border-radius:10px; font-size:0.9rem; min-width:60px; text-align:center; font-family:var(--font-num); }
        
        .prot .fi-qty { background:var(--prot-bg); color:var(--prot-text); }
        .carb .fi-qty { background:var(--carb-bg); color:var(--carb-text); }
        .fat .fi-qty { background:var(--fat-bg); color:var(--fat-text); }
        .veg .fi-qty { background:var(--veg-bg); color:var(--veg-text); }

        .btn-swap { width:32px; height:32px; border-radius:10px; background:white; border:1px solid var(--border); color:#94a3b8; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; }
        .btn-swap:hover { border-color:var(--accent); color:var(--accent); background:#f0fdf4; }

        /* EVOLUTION */
        .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; }
        .stat-card { background:white; padding:15px; border-radius:18px; text-align:center; border:1px solid var(--border); box-shadow:var(--shadow); }
        .stat-inp { width:100%; border:none; font-size:1.8rem; font-weight:800; text-align:center; color:var(--primary); background:transparent; font-family:var(--font-num); }
        
        .json-box { width:100%; height:120px; background:#1e293b; color:#a5b4fc; border-radius:12px; padding:15px; font-family:monospace; font-size:0.85rem; border:none; margin-bottom:15px; resize:none; }
        .btn-full { width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:16px; font-weight:800; font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; box-shadow:0 5px 15px rgba(21, 128, 61, 0.3); }

        /* MODAL */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,31,91,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal-box { background:var(--card); width:90%; max-width:400px; padding:30px; border-radius:24px; animation:slideUp 0.3s; box-shadow:0 25px 60px rgba(0,0,0,0.3); position:relative; }
        .modal-close { position:absolute; top:20px; right:20px; color:#94a3b8; cursor:pointer; font-size:1.4rem; transition:0.2s; }
        .modal-close:hover { color:var(--danger); transform:rotate(90deg); }
        
        .sync-btn { width: 100%; padding: 18px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 16px; background: white; display: flex; align-items: center; gap: 20px; cursor: pointer; transition: 0.2s; text-align: left; }
        .sync-btn:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .sync-btn i { font-size: 1.4rem; width: 30px; text-align: center; }
        .sb-title { font-weight: 700; font-size: 0.95rem; color: var(--primary); display:block; margin-bottom: 2px; }
        .sb-desc { font-size: 0.75rem; color: #94a3b8; }

        /* DOCK */
        .nav-dock { position:fixed; bottom:25px; left:50%; transform:translateX(-50%); background:white; padding:10px 25px; border-radius:25px; display:flex; gap:30px; box-shadow:0 15px 40px rgba(0,0,0,0.1); z-index:100; border:1px solid rgba(0,0,0,0.05); }
        .dock-item { color:#cbd5e1; font-size:1.4rem; cursor:pointer; transition:0.2s; position:relative; padding:5px; }
        .dock-item.active { color:var(--primary); transform:translateY(-5px); }
        .dock-item.active::after { content:''; position:absolute; bottom:-5px; left:50%; transform:translateX(-50%); width:5px; height:5px; background:var(--accent); border-radius:50%; }

        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        @keyframes slideUp { from{transform:translateY(20px); opacity:0;} to{transform:translateY(0); opacity:1;} }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo"><i class="fa-solid fa-leaf"></i> Benai</div>
            <div class="header-actions">
                <button class="action-btn" onclick="finishDay()" title="Salvar Dia"><i class="fa-solid fa-check"></i></button>
                <button class="action-btn sync" onclick="openModal('sync')" title="Nuvem">
                    <i class="fa-solid fa-cloud"></i>
                    <div id="cloudDot" class="cloud-dot"></div>
                </button>
            </div>
        </header>
        
        <div id="view-diet" class="view active">
            <div class="meta-card">
                <div><span class="meta-lbl">Meta Di√°ria</span><div class="meta-val" id="metaKcal">2100</div></div>
                <div class="meta-sub">
                    <div class="tag-status"><i class="fa-solid fa-fire"></i> D√©ficit -550</div>
                    <div class="tag-status"><i class="fa-solid fa-weight-scale"></i> <span id="dispWeight">--.-</span> kg</div>
                </div>
            </div>
            <div class="day-toggle" id="dayButtons"></div>
            <div id="mealList"></div>
        </div>

        <div id="view-evo" class="view">
            <h2 style="margin-bottom:20px; color:var(--primary);">Evolu√ß√£o</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <input type="number" id="inpWeight" class="stat-inp" placeholder="0.0" onchange="updateBio()">
                    <span style="font-size:0.8rem; font-weight:700; color:#64748b;">PESO (kg)</span>
                </div>
                <div class="stat-card">
                    <input type="number" id="inpSteps" class="stat-inp" placeholder="0" style="color:var(--accent);" onchange="updateBio()">
                    <span style="font-size:0.8rem; font-weight:700; color:#64748b;">PASSOS</span>
                </div>
            </div>
            <div style="background:white; padding:15px; border-radius:20px; border:1px solid var(--border); height:250px; margin-bottom:20px;"><canvas id="weightChart"></canvas></div>
            <div id="historyList"></div>
        </div>

        <div id="view-admin" class="view">
            <h2 style="margin-bottom:10px; color:var(--primary);">Avan√ßado</h2>
            <textarea id="jsonInput" class="json-box" placeholder="JSON Raw Data..."></textarea>
            <button class="btn-full" onclick="importFromText()"><i class="fa-solid fa-code"></i> Carregar Texto</button>
            <button class="btn-full" onclick="exportToClipboard()" style="background:#475569;"><i class="fa-solid fa-copy"></i> Copiar Texto</button>
        </div>
    </div>

    <div id="modal-sync" class="modal">
        <div class="modal-box">
            <i class="fa-solid fa-xmark modal-close" onclick="closeModal('sync')"></i>
            <h3 style="color:var(--primary); margin-bottom:5px; font-weight:800; font-family:var(--font-num);">Central de Dados</h3>
            <p style="font-size:0.85rem; color:#64748b; margin-bottom:20px;">GitHub Cloud + Backup Local</p>

            <div style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                <label style="font-size:0.75rem; font-weight:700; color:#64748b; margin-bottom:5px; display:block;">TOKEN DE ACESSO</label>
                <input type="password" id="manualToken" placeholder="ghp_..." style="width:100%; padding:12px; border:1px solid var(--border); border-radius:12px; margin-bottom:10px; background:#f8fafc; color:#334155; outline:none;">
                <button class="sync-btn" onclick="saveManualToken()" style="justify-content:center; padding:12px; margin-bottom:15px;">
                    <i class="fa-solid fa-key"></i> Salvar Token
                </button>
                
                <button class="sync-btn" onclick="forceSync()">
                    <i class="fa-solid fa-cloud-arrow-down" style="color:var(--accent)"></i> 
                    <div><span class="sb-title">For√ßar Download</span><span class="sb-desc">Baixar da Nuvem</span></div>
                </button>
            </div>

            <button class="sync-btn" onclick="exportFile()">
                <i class="fa-solid fa-download" style="color:#334155"></i> 
                <div><span class="sb-title">Baixar Arquivo</span><span class="sb-desc">Salvar .json no celular</span></div>
            </button>

            <button class="sync-btn" onclick="document.getElementById('importFile').click()">
                <i class="fa-solid fa-upload" style="color:#334155"></i> 
                <div><span class="sb-title">Restaurar Arquivo</span><span class="sb-desc">Carregar backup .json</span></div>
            </button>
            
             <button class="sync-btn" style="border-color:var(--danger); color:var(--danger); margin-bottom:0;" onclick="hardReset()">
                <i class="fa-solid fa-trash"></i> 
                <div><span class="sb-title" style="color:var(--danger)">Resetar Tudo</span><span class="sb-desc">Limpar dados locais</span></div>
            </button>
        </div>
    </div>

    <div class="nav-dock">
        <div class="dock-item active" id="btn-diet" onclick="setView('diet')"><i class="fa-solid fa-utensils"></i></div>
        <div class="dock-item" id="btn-evo" onclick="setView('evo')"><i class="fa-solid fa-chart-line"></i></div>
        <div class="dock-item" id="btn-admin" onclick="setView('admin')"><i class="fa-solid fa-sliders"></i></div>
    </div>

    <input type="file" id="importFile" hidden onchange="handleFileImport(this)">

    <script>
        // --- CONSTANTES ---
        const DB_KEY = 'benai_diet_main_db'; 
        const TOKEN_KEY = 'benai_coach_gh_token'; 
        const GIST_DESC = 'BENAI_PERSONAL_DB';
        
        // Estrutura Padr√£o (Fallback)
        const DEFAULT_DATA = { 
            "meta": { "kcal": 2100, "weight": 75.0, "steps": 0 }, 
            "currentDay": "A", 
            "history": [], 
            "days": { 
                "A": { "label": "Padr√£o", "meals": [] } 
            } 
        };

        // Estado Global
        let appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
        let chartInst = null;
        let gistId = null;

        // --- INICIALIZA√á√ÉO ---
        async function init() {
            // 1. Tenta carregar do LocalStorage
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed && parsed.days) appData = parsed;
                } catch(e) { console.error("Dados locais corrompidos", e); }
            }

            // 1.1 Tenta preencher o token se j√° existir
            const t = localStorage.getItem(TOKEN_KEY);
            if(t && document.getElementById('manualToken')) document.getElementById('manualToken').value = t;

            // 2. Renderiza o que tiver
            renderAll();

            // 3. Tenta conectar na Nuvem
            await syncCloud();
        }

        // --- RENDERIZA√á√ÉO ---
        function renderAll() {
            renderDiet();
            renderStats();
            renderChart();
        }

        function renderDiet() {
            if (!appData.meta) appData.meta = DEFAULT_DATA.meta;
            document.getElementById('metaKcal').innerText = appData.meta.kcal || 0;
            document.getElementById('dispWeight').innerText = appData.meta.weight || 0;

            const btnCont = document.getElementById('dayButtons');
            btnCont.innerHTML = '';
            if (!appData.days) appData.days = DEFAULT_DATA.days;
            
            Object.keys(appData.days).forEach(key => {
                const isActive = appData.currentDay === key;
                btnCont.innerHTML += `<div class="toggle-btn ${isActive?'active':''}" onclick="changeDay('${key}')">${appData.days[key].label}</div>`;
            });

            const list = document.getElementById('mealList');
            list.innerHTML = '';
            
            const currentPlan = appData.days[appData.currentDay];
            if (!currentPlan || !currentPlan.meals || currentPlan.meals.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8; font-style:italic;">Nenhuma refei√ß√£o neste dia.</div>';
                return;
            }

            currentPlan.meals.forEach(meal => {
                let foodsHTML = '';
                if(meal.foods) {
                    meal.foods.forEach(f => {
                        const icon = getFoodIcon(f.n, f.t);
                        foodsHTML += `
                        <div class="food-item">
                            <div class="fi-main">
                                <div class="fi-icon">${icon}</div>
                                <div class="fi-info">
                                    <span class="fi-name">${f.n}</span>
                                    <span class="fi-macro ${f.t}">${f.t}</span>
                                </div>
                            </div>
                            <div class="fi-actions">
                                <span class="fi-qty ${f.t}">${f.q}</span>
                            </div>
                        </div>`;
                    });
                }
                list.innerHTML += `
                <div class="meal-card">
                    <div class="meal-head">
                        <div class="mh-left">
                            <span class="meal-icon">${meal.icon || 'üçΩÔ∏è'}</span>
                            <span class="meal-name">${meal.name}</span>
                        </div>
                        <span class="meal-time">${meal.time}</span>
                    </div>
                    <div>${foodsHTML}</div>
                </div>`;
            });
        }

        function renderStats() {
            document.getElementById('inpWeight').value = appData.meta.weight;
            document.getElementById('inpSteps').value = appData.meta.steps || 0;
            
            const hList = document.getElementById('historyList');
            hList.innerHTML = '';
            if(appData.history && appData.history.length > 0) {
                [...appData.history].reverse().slice(0, 10).forEach(h => {
                    hList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:12px; border-bottom:1px solid #f1f5f9; color:#475569;"><span>${h.date}</span><span><b>${h.weight}</b> kg</span></div>`;
                });
            }
        }

        function renderChart() {
            const ctx = document.getElementById('weightChart');
            if(!appData.history) return;
            const recent = appData.history.slice(-7); 
            
            if(chartInst) chartInst.destroy();
            chartInst = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: recent.map(h => h.date), 
                    datasets: [{ 
                        label: 'Peso', 
                        data: recent.map(h => h.weight), 
                        borderColor: '#15803d', 
                        backgroundColor: 'rgba(21, 128, 61, 0.1)', 
                        tension: 0.4, 
                        fill: true 
                    }] 
                },
                options: { 
                    responsive:true, 
                    maintainAspectRatio:false, 
                    plugins:{legend:{display:false}}, 
                    scales:{y:{suggestedMin:60, suggestedMax:100}} 
                }
            });
        }

        // --- A√á√ïES ---
        function changeDay(key) {
            appData.currentDay = key;
            save();
            renderDiet();
        }

        function updateBio() {
            const w = parseFloat(document.getElementById('inpWeight').value);
            const s = parseInt(document.getElementById('inpSteps').value);
            if(w) appData.meta.weight = w;
            if(s) appData.meta.steps = s;
            save();
            renderDiet();
        }

        function finishDay() {
            if(!confirm("Concluir o dia e salvar hist√≥rico?")) return;
            const today = new Date().toLocaleDateString('pt-BR').substring(0,5); // DD/MM
            if(!appData.history) appData.history = [];
            appData.history = appData.history.filter(h => h.date !== today);
            appData.history.push({ date: today, weight: appData.meta.weight, steps: appData.meta.steps });
            save();
            renderChart();
            renderStats();
            alert("Hist√≥rico Salvo!");
        }

        function getFoodIcon(name, type) { 
            const n = name.toLowerCase(); 
            if(n.includes('ovo')) return 'ü•ö'; 
            if(n.includes('frango') || n.includes('carne') || n.includes('pat√™')) return 'ü•©'; 
            if(n.includes('peixe') || n.includes('sardinha')) return 'üêü'; 
            if(n.includes('arroz')) return 'üçö'; 
            if(n.includes('batata')) return 'ü•î'; 
            if(n.includes('p√£o')) return 'üçû'; 
            if(n.includes('banana') || n.includes('fruta')) return 'üçé'; 
            if(n.includes('caf√©')) return '‚òï'; 
            if(n.includes('iogurte') || n.includes('leite')) return 'ü•õ'; 
            return 'üçΩÔ∏è'; 
        }

        // --- SISTEMA DE NUVEM ---
        function updateStatus(status) {
            const el = document.getElementById('cloudDot');
            if(el) el.className = 'cloud-dot ' + status;
        }

        function saveManualToken() {
            const t = document.getElementById('manualToken').value.trim();
            if(t) {
                localStorage.setItem(TOKEN_KEY, t);
                alert("Token salvo! Tentando conectar...");
                syncCloud();
            }
        }

        async function syncCloud() {
            const token = localStorage.getItem(TOKEN_KEY);
            if(!token) { updateStatus('error'); return; }
            
            updateStatus('sync');
            try {
                if(!gistId) {
                    const s = await fetch('https://api.github.com/gists', { headers: { 'Authorization': `token ${token}` } });
                    const gists = await s.json();
                    const found = gists.find(g => g.description === GIST_DESC);
                    if(found) gistId = found.id;
                }

                if(gistId) {
                    const r = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { 'Authorization': `token ${token}` } });
                    const gistData = await r.json();
                    if(gistData.files && gistData.files["diet.json"]) {
                        const cloudContent = JSON.parse(gistData.files["diet.json"].content);
                        if(cloudContent && cloudContent.days) {
                            appData = cloudContent;
                            saveLocal();
                            renderAll();
                        }
                    } else { await pushCloud(); }
                    updateStatus('ok');
                } else { await pushCloud(); }
            } catch(e) {
                console.error(e);
                updateStatus('error');
            }
        }

        async function pushCloud() {
            const token = localStorage.getItem(TOKEN_KEY);
            if(!token) return;
            
            updateStatus('sync');
            try {
                const url = gistId ? `https://api.github.com/gists/${gistId}` : 'https://api.github.com/gists';
                const method = gistId ? 'PATCH' : 'POST';
                const payload = {
                    description: GIST_DESC,
                    public: false,
                    files: { "diet.json": { content: JSON.stringify(appData) } }
                };

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if(res.ok) {
                    if(!gistId) { const j = await res.json(); gistId = j.id; }
                    updateStatus('ok');
                } else { updateStatus('error'); }
            } catch(e) {
                console.error(e);
                updateStatus('error');
            }
        }

        function forceSync() {
            if(confirm("Isso substituir√° os dados locais pela vers√£o da Nuvem. Continuar?")) {
                syncCloud();
                closeModal('sync');
            }
        }

        function saveLocal() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); }
        function save() { saveLocal(); pushCloud(); }

        // Modais e Utils
        function openModal(id) { document.getElementById('modal-'+id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById('modal-'+id).style.display = 'none'; }
        
        function setView(vId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            document.getElementById('view-'+vId).classList.add('active');
            document.getElementById('btn-'+vId).classList.add('active');
        }

        function exportFile() {
            const blob = new Blob([JSON.stringify(appData)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "benai_diet_backup.json";
            a.click();
        }

        function handleFileImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.days) {
                        appData = json;
                        save();
                        renderAll();
                        alert("Backup restaurado com sucesso!");
                    } else { alert("Arquivo inv√°lido (estrutura incorreta)."); }
                } catch(err) { alert("Erro ao ler arquivo JSON."); }
            };
            reader.readAsText(file);
        }

        function hardReset() {
            if(confirm("Tem certeza? Isso apagar√° TUDO deste dispositivo.")) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        function exportToClipboard() {
            document.getElementById('jsonInput').value = JSON.stringify(appData, null, 2);
            document.getElementById('jsonInput').select();
            document.execCommand('copy');
            alert("JSON copiado para √°rea de transfer√™ncia!");
        }
        function importFromText() {
            try {
                const txt = document.getElementById('jsonInput').value;
                const json = JSON.parse(txt);
                if(json.days) {
                    appData = json;
                    save();
                    renderAll();
                    alert("Dados atualizados via texto!");
                } else { alert("Estrutura JSON inv√°lida."); }
            } catch(e) { alert("Erro de sintaxe no JSON."); }
        }

        init();
    </script>
</body>
</html>

