<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Benai - Nutri√ß√£o</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script>
        (function() {
            // --- CONFIGURA√á√ÉO DA SENHA ---
            const PIN_CORRETO = "16359001"; 
            // -----------------------------

            if (sessionStorage.getItem("benai_access_granted") === "true") return;

            document.write(`
                <style>
                    body { visibility: hidden; overflow: hidden; }
                    #gatekeeper {
                        visibility: visible; position: fixed; inset: 0;
                        background: #0f172a; color: white; z-index: 99999;
                        display: flex; flex-direction: column; align-items: center; justify-content: center;
                        font-family: 'Outfit', sans-serif;
                    }
                    .pin-box { text-align: center; animation: fadeIn 0.5s ease; width: 90%; max-width: 350px; }
                    .pin-inp { 
                        padding: 15px; font-size: 1.5rem; text-align: center; 
                        border-radius: 15px; border: 2px solid rgba(56, 189, 248, 0.3); outline: none; margin-top: 25px;
                        background: rgba(255,255,255,0.05); color: white; letter-spacing: 4px; width: 100%;
                        transition: 0.3s;
                    }
                    .pin-inp:focus { border-color: #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
                    .pin-msg { color: #f87171; margin-top: 15px; font-weight: 600; font-size: 0.9rem; height: 20px; }
                    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                </style>
                <div id="gatekeeper">
                    <div class="pin-box">
                        <i class="fa-solid fa-shield-halved" style="font-size: 3rem; color: #38bdf8; margin-bottom: 15px;"></i>
                        <h2 style="font-size: 1.5rem; letter-spacing: -1px;">Sistema Protegido</h2>
                        <p style="opacity: 0.6; font-size: 0.85rem;">Insira o c√≥digo de 8 d√≠gitos</p>
                        <input type="password" class="pin-inp" maxlength="8" placeholder="********" inputmode="numeric" autocomplete="off" onkeyup="verifyPin(this)">
                        <div class="pin-msg" id="pin-error"></div>
                    </div>
                </div>
            `);

            window.verifyPin = function(el) {
                if (el.value.length === 8) {
                    if (el.value === PIN_CORRETO) {
                        sessionStorage.setItem("benai_access_granted", "true");
                        location.reload();
                    } else {
                        document.getElementById("pin-error").innerText = "C√≥digo Incorreto";
                        el.value = "";
                        if(navigator.vibrate) navigator.vibrate(200);
                    }
                }
            };
        })();
    </script>
    <style>
        :root {
            /* TEMA: Clean Nutrition */
            --bg: #fdfbf7;       
            --card: #ffffff;     
            --text: #334155;     
            --primary: #15803d; 
            --accent: #22c55e;
            --border: #e2e8f0;
            --danger: #ef4444;
            
            /* Cores Macros */
            --prot-bg: #eff6ff; --prot-text: #1d4ed8;
            --carb-bg: #fff7ed; --carb-text: #c2410c;
            --fat-bg: #fefce8;  --fat-text: #a16207;
            --veg-bg: #f0fdf4;  --veg-text: #15803d;

            --radius: 20px;
            --font: 'Plus Jakarta Sans', sans-serif;
            --font-num: 'Outfit', sans-serif;
            --shadow: 0 8px 30px rgba(0,0,0,0.04);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:var(--font); outline:none; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg); color:var(--text); padding:20px; padding-bottom:110px; font-size:14px; }
        .container { max-width:600px; margin:0 auto; animation:fadeIn 0.6s ease; }

        /* HEADER */
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .logo { font-size:1.3rem; font-weight:800; color:var(--primary); letter-spacing:-0.5px; display:flex; align-items:center; gap:10px; font-family:var(--font-num); }
        .logo i { background:var(--prot-bg); color:var(--primary); padding:8px; border-radius:12px; font-size:1rem; }
        
        .header-actions { display:flex; gap:8px; }
        .action-btn { width:40px; height:40px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:#64748b; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; box-shadow:var(--shadow); }
        .action-btn:hover { color:var(--primary); border-color:var(--primary); transform:translateY(-2px); }
        .action-btn.sync { color:var(--accent); border-color:rgba(34, 197, 94, 0.3); background:rgba(34, 197, 94, 0.05); }

        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }

        /* CARDS */
        .meta-card { background:linear-gradient(135deg, #15803d 0%, #166534 100%); color:white; border-radius:24px; padding:25px; margin-bottom:25px; box-shadow:0 10px 25px rgba(21, 128, 61, 0.25); position:relative; overflow:hidden; }
        .meta-lbl { font-size:0.85rem; opacity:0.9; font-weight:600; margin-bottom:5px; display:block; letter-spacing:0.5px; text-transform:uppercase; }
        .meta-val { font-size:2.5rem; font-weight:800; line-height:1; letter-spacing:-1px; font-family:var(--font-num); }
        .meta-sub { display:flex; gap:15px; margin-top:15px; }
        .tag-status { background:rgba(255,255,255,0.2); padding:6px 12px; border-radius:10px; font-weight:700; font-size:0.85rem; backdrop-filter:blur(5px); display:flex; align-items:center; gap:6px; }

        .day-toggle { display:flex; background:white; padding:5px; border-radius:16px; margin-bottom:20px; border:1px solid var(--border); box-shadow:var(--shadow); }
        .toggle-btn { flex:1; padding:12px; text-align:center; font-weight:700; color:#64748b; border-radius:12px; cursor:pointer; font-size:0.9rem; transition:0.2s; }
        .toggle-btn.active { background:var(--primary); color:white; box-shadow:0 4px 10px rgba(21, 128, 61, 0.2); }

        /* MEALS */
        .meal-card { background:var(--card); border-radius:22px; margin-bottom:20px; box-shadow:var(--shadow); border:1px solid var(--border); overflow:hidden; }
        .meal-head { padding:15px 20px; background:#f8fafc; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .mh-left { display:flex; align-items:center; gap:10px; }
        .meal-icon { font-size:1.2rem; }
        .meal-name { font-weight:800; color:#1e293b; font-size:1rem; }
        .meal-time { font-weight:700; color:#64748b; font-size:0.8rem; background:white; padding:4px 10px; border-radius:8px; border:1px solid var(--border); font-family:var(--font-num); }

        .food-item { padding:14px 20px; border-bottom:1px dashed #f1f5f9; display:flex; justify-content:space-between; align-items:center; }
        .food-item:last-child { border:none; }
        .fi-main { display:flex; align-items:center; gap:12px; }
        .fi-icon { font-size:1.4rem; width:30px; text-align:center; }
        .fi-info { display:flex; flex-direction:column; }
        .fi-name { font-weight:700; color:#334155; font-size:0.95rem; }
        .fi-macro { font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; opacity:0.6; }
        .fi-actions { display:flex; align-items:center; gap:8px; }
        .fi-qty { font-weight:800; padding:6px 12px; border-radius:10px; font-size:0.9rem; min-width:60px; text-align:center; font-family:var(--font-num); }
        
        .prot .fi-qty { background:var(--prot-bg); color:var(--prot-text); }
        .carb .fi-qty { background:var(--carb-bg); color:var(--carb-text); }
        .fat .fi-qty { background:var(--fat-bg); color:var(--fat-text); }
        .veg .fi-qty { background:var(--veg-bg); color:var(--veg-text); }

        .btn-swap { width:32px; height:32px; border-radius:10px; background:white; border:1px solid var(--border); color:#94a3b8; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.2s; }
        .btn-swap:hover { border-color:var(--accent); color:var(--accent); background:#f0fdf4; }

        /* EVOLUTION & ADMIN */
        .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; }
        .stat-card { background:white; padding:15px; border-radius:18px; text-align:center; border:1px solid var(--border); box-shadow:var(--shadow); }
        .stat-inp { width:100%; border:none; font-size:1.8rem; font-weight:800; text-align:center; color:var(--primary); background:transparent; font-family:var(--font-num); }
        
        .json-box { width:100%; height:120px; background:#1e293b; color:#a5b4fc; border-radius:12px; padding:15px; font-family:monospace; font-size:0.85rem; border:none; margin-bottom:15px; resize:none; }
        .btn-full { width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:16px; font-weight:800; font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:10px; box-shadow:0 5px 15px rgba(21, 128, 61, 0.3); }

        /* MODAL SYNC (PADR√ÉO) */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,31,91,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal-box { background:var(--card); width:90%; max-width:400px; padding:30px; border-radius:24px; animation:slideUp 0.3s; box-shadow:0 25px 60px rgba(0,0,0,0.3); position:relative; }
        .modal-close { position:absolute; top:20px; right:20px; color:#94a3b8; cursor:pointer; font-size:1.4rem; transition:0.2s; }
        .modal-close:hover { color:var(--danger); transform:rotate(90deg); }
        
        .modal-head { margin-bottom: 25px; }
        .modal-head h3 { font-family: var(--font-num); font-weight: 800; font-size: 1.3rem; color: var(--primary); margin: 0 0 5px 0; }
        .modal-head p { font-size: 0.85rem; color: #64748b; margin: 0; }

        .sync-btn { 
            width: 100%; padding: 18px 20px; margin-bottom: 15px;
            border: 1px solid #e2e8f0; border-radius: 16px; background: white;
            display: flex; align-items: center; gap: 20px;
            cursor: pointer; transition: 0.2s; text-align: left;
        }
        .sync-btn:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .sync-btn i { font-size: 1.4rem; width: 30px; text-align: center; }
        
        .sb-down i { color: var(--accent); }
        .sb-share i { color: #25D366; }
        .sb-up i { color: var(--primary); }
        
        .sb-reset { border-color: #fee2e2; color: var(--danger); background: #fffbfb; margin-top: 20px; }
        .sb-reset:hover { background: #fef2f2; border-color: var(--danger); }
        .sb-reset i { color: var(--danger); }

        .sb-txt { display: flex; flex-direction: column; }
        .sb-title { font-weight: 700; font-size: 0.95rem; color: var(--primary); margin-bottom: 2px; }
        .sb-desc { font-size: 0.75rem; color: #94a3b8; }
        .sb-reset .sb-title { color: var(--danger); }
        .sb-reset .sb-desc { color: #fca5a5; }

        /* MODAL SUBS (Estilo Simples) */
        #modalSubs { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
        .sub-opt { padding:15px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }

        /* DOCK */
        .nav-dock { position:fixed; bottom:25px; left:50%; transform:translateX(-50%); background:white; padding:10px 25px; border-radius:25px; display:flex; gap:30px; box-shadow:0 15px 40px rgba(0,0,0,0.1); z-index:100; border:1px solid rgba(0,0,0,0.05); }
        .dock-item { color:#cbd5e1; font-size:1.4rem; cursor:pointer; transition:0.2s; position:relative; padding:5px; }
        .dock-item.active { color:var(--primary); transform:translateY(-5px); }
        .dock-item.active::after { content:''; position:absolute; bottom:-5px; left:50%; transform:translateX(-50%); width:5px; height:5px; background:var(--accent); border-radius:50%; }

        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        @keyframes slideUp { from{transform:translateY(20px); opacity:0;} to{transform:translateY(0); opacity:1;} }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo"><i class="fa-solid fa-leaf"></i> Benai</div>
            <div class="header-actions">
                <button class="action-btn" onclick="finishDay()" title="Concluir Dia"><i class="fa-solid fa-check"></i></button>
                <button class="action-btn sync" onclick="openModal('sync')" title="Central de Dados"><i class="fa-solid fa-cloud"></i></button>
            </div>
        </header>
        
        <div id="view-diet" class="view active">
            <div class="meta-card">
                <div><span class="meta-lbl">Meta Di√°ria (Jan)</span><div class="meta-val" id="metaKcal">2100</div></div>
                <div class="meta-sub">
                    <div class="tag-status"><i class="fa-solid fa-fire"></i> D√©ficit -550</div>
                    <div class="tag-status"><i class="fa-solid fa-weight-scale"></i> <span id="dispWeight">76.5</span> kg</div>
                </div>
            </div>
            <div class="day-toggle" id="dayButtons"></div>
            <div id="mealList"></div>
        </div>

        <div id="view-evo" class="view">
            <h2 style="margin-bottom:20px; color:var(--primary);">Sua Evolu√ß√£o</h2>
            <div class="stat-grid">
                <div class="stat-card">
                    <input type="number" id="inpWeight" class="stat-inp" value="76.5" onchange="updateBio()">
                    <span style="font-size:0.8rem; font-weight:700; color:#64748b; text-transform:uppercase;">Peso Atual (kg)</span>
                </div>
                <div class="stat-card">
                    <input type="number" id="inpSteps" class="stat-inp" value="0" style="color:var(--accent);" onchange="updateBio()">
                    <span style="font-size:0.8rem; font-weight:700; color:#64748b; text-transform:uppercase;">Passos Hoje</span>
                </div>
            </div>
            <div style="background:white; padding:15px; border-radius:20px; border:1px solid var(--border); height:250px; margin-bottom:20px;"><canvas id="weightChart"></canvas></div>
            <h3 style="font-size:1rem; color:#64748b; margin-bottom:10px;">Hist√≥rico</h3>
            <div id="historyList"></div>
        </div>

        <div id="view-admin" class="view">
            <h2 style="margin-bottom:10px; color:var(--primary);">Gest√£o Avan√ßada</h2>
            <p style="margin-bottom:15px; color:#64748b;">Editor JSON manual (para desenvolvedores).</p>
            <textarea id="jsonInput" class="json-box" placeholder="Cole JSON aqui..."></textarea>
            <button class="btn-full" onclick="importPlan()"><i class="fa-solid fa-code"></i> Atualizar via Texto</button>
            <button class="btn-full" onclick="exportPlanClipboard()" style="background:#475569;"><i class="fa-solid fa-copy"></i> Copiar Texto</button>
        </div>
    </div>

    <div id="modal-sync" class="modal">
        <div class="modal-box">
            <i class="fa-solid fa-xmark modal-close" onclick="closeModal('sync')"></i>
            
            <div class="modal-head">
                <h3>Central de Dados</h3>
                <p>Sincronize entre PC e Celular via arquivo.</p>
            </div>
            
            <button class="sync-btn sb-down" onclick="exportData()">
                <i class="fa-solid fa-download"></i> 
                <div class="sb-txt">
                    <span class="sb-title">Baixar Arquivo JSON</span>
                    <span class="sb-desc">Para salvar no PC</span>
                </div>
            </button>

            <button class="sync-btn sb-share" onclick="shareData()">
                <i class="fa-brands fa-whatsapp"></i> 
                <div class="sb-txt">
                    <span class="sb-title">Compartilhar (Mobile)</span>
                    <span class="sb-desc">Enviar para WhatsApp/Drive</span>
                </div>
            </button>

            <button class="sync-btn sb-up" onclick="document.getElementById('importFile').click()">
                <i class="fa-solid fa-upload"></i> 
                <div class="sb-txt">
                    <span class="sb-title">Restaurar Backup</span>
                    <span class="sb-desc">Carregar arquivo JSON</span>
                </div>
            </button>
            
            <button class="sync-btn sb-reset" onclick="hardReset()">
                <i class="fa-solid fa-trash"></i> 
                <div class="sb-txt">
                    <span class="sb-title">Resetar Tudo</span>
                    <span class="sb-desc">Cuidado! Apaga todos os dados.</span>
                </div>
            </button>
        </div>
    </div>

    <div id="modalSubs">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="color:var(--primary); margin:0;">Substituir</h3>
                <i class="fa-solid fa-xmark" onclick="closeModal('modalSubs')" style="cursor:pointer; font-size:1.5rem; color:#94a3b8;"></i>
            </div>
            <div id="subsList"></div>
        </div>
    </div>

    <div class="nav-dock">
        <div class="dock-item active" id="btn-diet" onclick="setView('diet')"><i class="fa-solid fa-utensils"></i></div>
        <div class="dock-item" id="btn-evo" onclick="setView('evo')"><i class="fa-solid fa-chart-line"></i></div>
        <div class="dock-item" id="btn-admin" onclick="setView('admin')"><i class="fa-solid fa-sliders"></i></div>
    </div>

    <input type="file" id="importFile" hidden onchange="importData(this)">

    <script>
        // CHAVE MESTRA FIXA
        const KEY = 'benai_diet_main_db'; 
        const OLD_KEYS = ['benai_diet_v4', 'benai_v4']; // Lista de migra√ß√£o

        const DEFAULT_DATA = { "meta": { "kcal": 2100, "deficit": 550, "weight": 76.5, "steps": 0 }, "currentDay": "A", "history": [], "days": { "A": { "label": "üè† Principal", "meals": [ { "time": "06:00", "name": "Caf√© da Manh√£", "icon": "‚òï", "foods": [ { "n": "Ovos Inteiros", "q": "3 un", "t": "prot" }, { "n": "Tapioca (Goma)", "q": "50g", "t": "carb" }, { "n": "Requeij√£o Light", "q": "20g", "t": "fat" }, { "n": "Caf√© + Leite", "q": "250ml", "t": "veg" } ] }, { "time": "09:00", "name": "Pr√©-Treino (Bowl)", "icon": "‚ö°", "foods": [ { "n": "Iogurte Natural", "q": "170g", "t": "prot" }, { "n": "Banana Prata", "q": "1 un", "t": "carb" }, { "n": "Farelo de Aveia", "q": "20g", "t": "carb" }, { "n": "Leite em P√≥", "q": "15g", "t": "prot" }, { "n": "Chia + Cacau", "q": "10g", "t": "fat" } ] }, { "time": "12:00", "name": "Almo√ßo (P√≥s-Treino)", "icon": "üçó", "foods": [ { "n": "Frango/Carne (Pronto)", "q": "140g", "t": "prot" }, { "n": "Arroz Cozido", "q": "250g", "t": "carb" }, { "n": "Vegetais Cozidos", "q": "200g", "t": "veg" }, { "n": "Salada Folhas", "q": "Livre", "t": "veg" } ] }, { "time": "16:00", "name": "Lanche Tarde", "icon": "ü•û", "foods": [ { "n": "Tapioca (Goma)", "q": "50g", "t": "carb" }, { "n": "Ovos Mexidos", "q": "2 un", "t": "prot" }, { "n": "Requeij√£o Light", "q": "10g", "t": "fat" }, { "n": "Fruta", "q": "1 un", "t": "veg" } ] }, { "time": "19:30", "name": "Jantar (Pat√™)", "icon": "ü•™", "foods": [ { "n": "P√£o Integral", "q": "2 fat", "t": "carb" }, { "n": "Pat√™ de Frango", "q": "120g", "t": "prot" }, { "n": "RECEITA DO PAT√ä:", "q": "Info", "t": "fat" }, { "n": "Base:", "q": "600g Frango", "t": "veg" }, { "n": "Liga:", "q": "1 Pote Req.", "t": "veg" } ] } ] }, "B": { "label": "üîÑ Varia√ß√£o", "meals": [ { "time": "06:00", "name": "Op√ß√£o P√£o", "icon": "üçû", "foods": [ { "n": "P√£o Franc√™s s/ miolo", "q": "1 un", "t": "carb" }, { "n": "Frango Desfiado", "q": "100g", "t": "prot" }, { "n": "Requeij√£o Light", "q": "20g", "t": "fat" } ] }, { "time": "09:00", "name": "Op√ß√£o Vitamina", "icon": "ü•§", "foods": [ { "n": "Leite Semidesn.", "q": "250ml", "t": "prot" }, { "n": "Banana Prata", "q": "1 un", "t": "carb" }, { "n": "Aveia", "q": "30g", "t": "carb" }, { "n": "Ovo Cozido (Comer)", "q": "1 un", "t": "prot" } ] }, { "time": "12:00", "name": "Op√ß√£o Batata", "icon": "ü•©", "foods": [ { "n": "Carne Moida/Suina", "q": "140g", "t": "prot" }, { "n": "Batata Inglesa", "q": "350g", "t": "carb" }, { "n": "Vegetais", "q": "Livre", "t": "veg" } ] }, { "time": "16:00", "name": "Op√ß√£o Sandu√≠che", "icon": "ü•™", "foods": [ { "n": "P√£o Integral", "q": "2 fat", "t": "carb" }, { "n": "Pat√™ de Frango", "q": "100g", "t": "prot" }, { "n": "Fruta", "q": "1 un", "t": "veg" } ] }, { "time": "19:30", "name": "Jantar (Sardinha)", "icon": "üêü", "foods": [ { "n": "P√£o Integral", "q": "2 fat", "t": "carb" }, { "n": "Sardinha (Drenada)", "q": "2 latas", "t": "prot" }, { "n": "Milho/Vegetais", "q": "A gosto", "t": "veg" } ] } ] } } };
        const FOOD_DB = { 'prot': [ {n:'Ovos (3un)', q:'3 un'}, {n:'Frango (100g)', q:'100g'}, {n:'Sardinha (2 latas)', q:'170g'}, {n:'Leite em P√≥', q:'15g'} ], 'carb': [ {n:'Tapioca', q:'50g'}, {n:'P√£o Franc√™s', q:'1 un'}, {n:'Arroz', q:'250g'}, {n:'Batata', q:'350g'}, {n:'Aveia', q:'20g'}, {n:'Banana', q:'1 un'} ], 'fat': [ {n:'Requeij√£o', q:'20g'}, {n:'Azeite', q:'5ml'}, {n:'Chia', q:'1 col'} ], 'veg': [ {n:'Br√≥colis', q:'Livre'}, {n:'Salada', q:'Livre'} ] };

        let data = DEFAULT_DATA;
        let chartInstance = null;
        let subCtx = null;

        function getFoodIcon(name, type) { const n = name.toLowerCase(); if(n.includes('ovo')) return 'ü•ö'; if(n.includes('frango') || n.includes('pat√™')) return 'üçó'; if(n.includes('carne')) return 'ü•©'; if(n.includes('peixe') || n.includes('sardinha')) return 'üêü'; if(n.includes('arroz')) return 'üçö'; if(n.includes('batata')) return 'ü•î'; if(n.includes('p√£o')) return 'üçû'; if(n.includes('tapioca')) return 'ü•û'; if(n.includes('banana')) return 'üçé'; if(n.includes('caf√©')) return '‚òï'; if(n.includes('iogurte')) return 'ü•õ'; if(type === 'prot') return 'üçó'; if(type === 'carb') return '‚ö°'; if(type === 'fat') return 'üíß'; return 'üçΩÔ∏è'; }

        function init() {
            // MIGRATION CHECK
            let saved = localStorage.getItem(KEY);
            if(!saved) {
                // Tenta migrar automaticamente
                for(let k of OLD_KEYS) {
                    const old = localStorage.getItem(k);
                    if(old) {
                        saved = old;
                        localStorage.setItem(KEY, saved); // Salva na nova
                        console.log("Dados migrados de " + k);
                        break;
                    }
                }
            }
            
            if(saved) {
                try { data = JSON.parse(saved); } catch(e) { console.error(e); }
            }
            
            renderDiet(); updateBio(); renderChart();
        }

        function save() { localStorage.setItem(KEY, JSON.stringify(data)); }

        function renderDiet() {
            document.getElementById('metaKcal').innerText = data.meta.kcal;
            document.getElementById('dispWeight').innerText = data.meta.weight;
            
            const btnCont = document.getElementById('dayButtons');
            btnCont.innerHTML = '';
            Object.keys(data.days).forEach(key => {
                const isActive = data.currentDay === key;
                btnCont.innerHTML += `<div class="toggle-btn ${isActive?'active':''}" onclick="setDay('${key}')">${data.days[key].label}</div>`;
            });

            const list = document.getElementById('mealList');
            list.innerHTML = '';
            const plan = data.days[data.currentDay];

            if(!plan.meals.length) { list.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;">Sem dados.</div>'; return; }

            plan.meals.forEach((meal, mIdx) => {
                let foodsHTML = '';
                meal.foods.forEach((f, fIdx) => {
                    const icon = getFoodIcon(f.n, f.t);
                    const showSwap = FOOD_DB[f.t] ? '' : 'display:none;';
                    foodsHTML += `<div class="food-item"><div class="fi-main"><div class="fi-icon">${icon}</div><div class="fi-info"><span class="fi-name">${f.n}</span><span class="fi-macro ${f.t}">${f.t}</span></div></div><div class="fi-actions"><span class="fi-qty ${f.t}">${f.q}</span><div class="btn-swap" style="${showSwap}" onclick="openSubs('${f.t}', ${mIdx}, ${fIdx})"><i class="fa-solid fa-rotate"></i></div></div></div>`;
                });
                list.innerHTML += `<div class="meal-card"><div class="meal-head"><div class="mh-left"><span class="meal-icon">${meal.icon || 'üçΩÔ∏è'}</span><span class="meal-name">${meal.name}</span></div><span class="meal-time">${meal.time}</span></div><div>${foodsHTML}</div></div>`;
            });
        }

        function setDay(key) { data.currentDay = key; save(); renderDiet(); }
        function updateBio() {
            const w = parseFloat(document.getElementById('inpWeight').value);
            const s = parseInt(document.getElementById('inpSteps').value);
            if(w) data.meta.weight = w;
            if(s) data.meta.steps = s;
            save();
        }
        function finishDay() {
            if(!confirm("Salvar dia?")) return;
            data.history.push({ date: new Date().toLocaleDateString('pt-BR').substring(0,5), weight: data.meta.weight, steps: data.meta.steps });
            save(); renderChart(); alert("Salvo!");
        }
        function renderChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const hist = data.history.slice(-7);
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: hist.map(h => h.date), datasets: [{ label: 'Peso', data: hist.map(h => h.weight), borderColor: '#15803d', backgroundColor: 'rgba(21, 128, 61, 0.1)', tension: 0.4, fill: true }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{suggestedMin:70, suggestedMax:80}} }
            });
            const hList = document.getElementById('historyList');
            hList.innerHTML = '';
            [...data.history].reverse().slice(0,5).forEach(h => { hList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #f1f5f9; color:#475569;"><span>${h.date}</span><span>${h.weight}kg</span></div>`; });
        }
        function openSubs(type, mIdx, fIdx) {
            subCtx = { m: mIdx, f: fIdx };
            const list = document.getElementById('subsList');
            list.innerHTML = '';
            if(FOOD_DB[type]) {
                FOOD_DB[type].forEach(i => {
                    const ic = getFoodIcon(i.n, type);
                    list.innerHTML += `<div class="sub-opt" onclick="applySub('${i.n}', '${i.q}')"><span style="display:flex; gap:10px; align-items:center;"><span>${ic}</span> ${i.n}</span><strong style="color:var(--primary);">${i.q}</strong></div>`;
                });
            }
            document.getElementById('modalSubs').style.display='flex';
        }
        function applySub(n, q) {
            const {m, f} = subCtx;
            data.days[data.currentDay].meals[m].foods[f].n = n;
            data.days[data.currentDay].meals[m].foods[f].q = q;
            save(); renderDiet(); closeModal('modalSubs');
        }
        function setView(v) {
            document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.dock-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.getElementById('btn-'+v).classList.add('active');
        }
        
        // SYNC (PADRONIZADO)
        function openModal(id) { 
            const m = document.getElementById('modal-'+id); 
            if(m) m.style.display='flex'; 
        }
        function closeModal(id) { 
            const m = document.getElementById(id.startsWith('modal') ? id : 'modal-'+id); 
            if(m) m.style.display='none'; 
        }
        
        function exportData() {
            const d = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const a = document.createElement('a'); a.href = d; a.download = "benai_diet_backup.json"; a.click();
        }
        function shareData() {
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const file = new File([blob], "benai_diet.json", { type: 'application/json' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                navigator.share({ files: [file], title: 'Backup Dieta Benai' });
            } else { alert("Use o bot√£o Baixar."); }
        }
        function importData(input) {
            const f = input.files[0]; if(!f) return;
            const reader = new FileReader();
            reader.onload = e => { 
                try { data = JSON.parse(e.target.result); save(); location.reload(); } catch(err) { alert("Erro ao importar"); } 
            };
            reader.readAsText(f);
        }
        function hardReset() { if(confirm("Apagar tudo?")) { localStorage.removeItem(KEY); location.reload(); } }

        function triggerRestore() { document.getElementById('importFile').click(); }
        
        function exportPlanClipboard() {
            document.getElementById('jsonInput').value = JSON.stringify(data, null, 2);
            document.getElementById('jsonInput').select();
            document.execCommand('copy');
            alert("Copiado!");
        }
        function importPlan() {
            try { data = JSON.parse(document.getElementById('jsonInput').value); save(); init(); alert("Atualizado!"); setView('diet'); } catch(e) { alert("JSON Inv√°lido"); }
        }

        init();
    </script>
</body>
</html>