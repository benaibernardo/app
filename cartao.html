
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Benai & Talita | Controle Gastos</title>
    <link rel="icon" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home/54.png" type="image/png">
    
    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&family=Patrick+Hand&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* PALETA KAWAII PASTEL */
            --bg-cream: #fffdf5;
            --bg-dots: #e8e1d5;
            
            --card-white: #ffffff;
            
            --blue-soft: #dbeafe; --blue-strong: #3b82f6; --blue-border: #93c5fd;
            --pink-soft: #fce7f3; --pink-strong: #ec4899; --pink-border: #f9a8d4;
            --yellow-soft: #fef9c3; --yellow-strong: #eab308; --yellow-border: #fde047;
            --green-soft: #dcfce7; --green-strong: #22c55e; --green-border: #86efac;
            --purple-soft: #f3e8ff; --purple-strong: #a855f7; --purple-border: #d8b4fe;
            
            /* Telegram Color */
            --telegram-blue: #229ED9;
            --telegram-dark: #1b7fbf;

            --text-main: #475569;
            --text-light: #94a3b8;
            
            --font-main: 'Nunito', sans-serif;
            --font-cute: 'Fredoka', sans-serif;
            --font-hand: 'Patrick Hand', cursive; 
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg-cream);
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            background-image: radial-gradient(var(--bg-dots) 1.5px, transparent 1.5px);
            background-size: 24px 24px;
        }

        h1, h2, h3, h4, .font-cute { font-family: var(--font-cute); letter-spacing: 0.5px; }
        .font-hand { font-family: var(--font-hand); }

        /* --- UI ELEMENTS --- */
        .cute-card {
            background: var(--card-white);
            border-radius: 30px;
            box-shadow: 0 8px 0px rgba(0,0,0,0.03), 0 4px 15px rgba(0,0,0,0.05);
            border: 3px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .cute-card:hover { transform: translateY(-4px); }
        
        .cute-btn {
            border-radius: 20px; 
            font-weight: 800; 
            font-family: var(--font-cute);
            transition: all 0.1s; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            border-bottom-width: 5px;
            position: relative;
            top: 0;
        }
        .cute-btn:active { border-bottom-width: 0px; top: 5px; transform: scale(0.98); }

        .btn-psyduck { 
            background: var(--yellow-soft); 
            color: #854d0e; 
            border: 2px solid var(--yellow-border);
            border-bottom: 5px solid var(--yellow-strong); 
        }
        
        .btn-action-pay {
            background: var(--green-soft); color: var(--green-strong);
            border: 2px solid var(--green-border); border-bottom: 5px solid var(--green-strong);
        }
        .btn-action-reopen {
            background: #ffedd5; color: #ea580c;
            border: 2px solid #fdba74; border-bottom: 5px solid #ea580c;
        }

        /* --- PSYDUCK ROAD --- */
        .psy-road-container {
            position: relative; height: 160px; margin-top: 10px; margin-bottom: 10px;
            padding: 0 10px; z-index: 10;
        }
        .cloud-bg { position: absolute; opacity: 0.6; z-index: 0; animation: floatCloud 6s infinite ease-in-out alternate; }
        @keyframes floatCloud { from { transform: translateX(0); } to { transform: translateX(10px); } }

        .psy-track {
            position: absolute; bottom: 45px; left: 15px; right: 15px; height: 24px;
            background: #ecfdf5; border-radius: 12px; overflow: hidden;
            border: 3px solid white; box-shadow: 0 6px 0px #d1fae5;
        }
        
        .psy-progress-fill {
            height: 100%; width: 0%; 
            background: repeating-linear-gradient(45deg, #4ade80, #4ade80 10px, #86efac 10px, #86efac 20px);
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 8px;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.1);
        }
        
        .psy-avatar-wrapper {
            position: absolute; bottom: 40px; left: 0; 
            transition: left 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center;
            width: 100px;
        }
        .psy-img {
            width: 85px; height: 85px; 
            filter: drop-shadow(0 4px 0px rgba(0,0,0,0.1));
            transition: all 0.5s ease;
            animation: bounceIdle 2s infinite;
        }
        @keyframes bounceIdle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .start-marker { position: absolute; left: -5px; bottom: 40px; z-index: 15; }
        .pokeball-img { width: 35px; filter: drop-shadow(0 3px 0 rgba(0,0,0,0.1)); }

        .end-marker { position: absolute; right: -15px; bottom: 30px; z-index: 15; display: flex; flex-direction: column; align-items: center; }
        .snorlax-img { width: 70px; filter: drop-shadow(0 3px 0 rgba(0,0,0,0.1)); }
        
        /* Bal√£o do Snorlax (Chamativo) */
        .limit-bubble-snorlax {
            background: #f43f5e; /* Vibrant Pink/Red */
            color: white; padding: 6px 12px; border-radius: 12px;
            font-size: 0.75rem; font-weight: 800; margin-bottom: -5px; white-space: nowrap;
            position: relative; margin-left: -30px; border: 2px solid white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); animation: pulseBubble 2s infinite;
        }
        .limit-bubble-snorlax::after {
            content: ''; position: absolute; bottom: -6px; left: 70%;
            border-width: 6px 6px 0; border-style: solid; border-color: #f43f5e transparent transparent transparent;
        }
        @keyframes pulseBubble { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .cartoon-bubble {
            background: white; border: 3px solid var(--text-main);
            padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800;
            color: var(--text-main); margin-bottom: -5px; white-space: nowrap;
            position: relative; box-shadow: 3px 3px 0px rgba(0,0,0,0.1);
            animation: floatBubble 3s infinite ease-in-out;
            z-index: 25; font-family: var(--font-cute);
        }
        .cartoon-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            border-width: 8px 8px 0; border-style: solid; border-color: var(--text-main) transparent transparent transparent;
        }
        @keyframes floatBubble { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-4px);} }

        /* --- LISTA --- */
        .tx-item {
            padding: 14px; border-radius: 24px; background: white; margin-bottom: 12px;
            border: 3px solid #f1f5f9; box-shadow: 0 4px 0 #cbd5e1;
            transition: 0.2s; position: relative; overflow: visible; cursor: pointer;
            display: flex; align-items: center; gap: 12px;
        }
        .tx-item:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }
        
        .tx-unpaid { background: #fff1f2; border-color: #fecaca; box-shadow: 0 4px 0 #fca5a5; }
        .tx-unpaid .tx-amount { color: #be123c; }
        .tx-paid { background: #f0fdf4; border-color: #bbf7d0; box-shadow: 0 4px 0 #86efac; }
        .tx-paid .tx-amount { color: #15803d; }
        .tx-other { background: #f8fafc; border-color: #e2e8f0; box-shadow: 0 4px 0 #cbd5e1; border-left-width: 6px; border-left-color: #94a3b8; }

        .tx-date-box {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 52px; height: 52px; background: white; border-radius: 18px;
            flex-shrink: 0; border: 3px solid #f1f5f9; 
        }
        .tx-unpaid .tx-date-box { border-color: #fecaca; }
        .tx-paid .tx-date-box { border-color: #bbf7d0; }

        .tx-day { font-size: 1.2rem; font-weight: 900; color: var(--text-main); line-height: 1; font-family: var(--font-cute); }
        .tx-month { font-size: 0.65rem; font-weight: 800; color: var(--text-light); text-transform: uppercase; margin-top: 2px; }

        .tx-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .tx-line-1 { display: flex; align-items: center; gap: 6px; overflow: hidden; white-space: nowrap; margin-bottom: 4px; }
        .tx-loc { font-size: 0.9rem; font-weight: 800; color: var(--text-main); font-family: var(--font-cute); }
        .tx-route { font-size: 0.8rem; font-weight: 800; color: #0284c7; display:flex; align-items:center; gap:4px; font-family: var(--font-cute); }
        .tx-desc { font-size: 0.8rem; font-weight: 600; color: var(--text-light); overflow: hidden; text-overflow: ellipsis; font-family: var(--font-hand); }
        
        .cat-badge { 
            font-size: 0.65rem; padding: 3px 8px; border-radius: 10px; font-weight: 800; 
            text-transform: uppercase; color: white; display: inline-flex; align-items: center; gap: 4px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1); 
        }
        
        .cartoon-bar { display: flex; gap: 3px; align-items: center; margin-top: 6px; }
        .cb-pill { width: 10px; height: 8px; border-radius: 4px; background: #e2e8f0; transition: 0.2s; border: 1px solid white; }
        .cb-pill.paid { background: #4ade80; border-color: #22c55e; }
        .cb-pill.current { background: #facc15; transform: scale(1.3); border-color: #ca8a04; }
        .cb-pill.future { background: #cbd5e1; }
        .cb-text { font-size: 0.6rem; font-weight: 800; color: var(--text-light); margin-left: 6px; }

        .tx-right { text-align: right; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; min-width: 80px; }
        .tx-amount { font-family: var(--font-cute); font-weight: 800; font-size: 1.1rem; letter-spacing: -0.5px; }
        .pm-icon-only { font-size: 1.1rem; margin-top: 4px; color: var(--text-light); opacity: 0.7; }

        /* INPUTS & BUTTONS */
        .cute-input {
            width: 100%; padding: 14px; border-radius: 18px; border: 3px solid #f1f5f9;
            background: #fdfdfd; font-family: var(--font-main); font-weight: 700;
            color: var(--text-main); outline: none; transition: 0.3s; font-size: 0.95rem;
        }
        .cute-input:focus { border-color: var(--purple-border); background: #faf5ff; }

        .head-btn {
            width: 44px; height: 44px; border-radius: 16px; display: flex; align-items: center; justify-content: center;
            color: white; transition: 0.2s; border-bottom-width: 4px; position: relative; top: 0;
        }
        .head-btn:active { border-bottom-width: 0; top: 4px; }

        /* Updated Colors */
        .hb-report { background: var(--telegram-blue); border-color: var(--telegram-dark); }
        .hb-cloud { background: #0ea5e9; border-color: #0369a1; }
        .hb-config { background: #94a3b8; border-color: #64748b; }
        
        .hb-add { 
            background: var(--yellow-soft); color: #854d0e; width: auto; padding: 0 20px; 
            font-weight: 900; font-family: var(--font-cute); 
            border: 2px solid var(--yellow-border);
            border-bottom: 5px solid var(--yellow-strong);
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(253, 224, 71, 0.4);
        }
        .hb-add:active { border-bottom-width: 0; top: 5px; box-shadow: none; }

        /* POKEBALL BUTTON */
        .pokeball-btn {
            width: 60px; height: 60px;
            background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
            background-size: cover; background-position: center;
            border-radius: 50%; border: none; cursor: pointer;
            transition: transform 0.2s; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            margin-top: 20px;
        }
        .pokeball-btn:hover { transform: scale(1.1) rotate(15deg); }
        .pokeball-btn:active { transform: scale(0.95); }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(51, 65, 85, 0.6); backdrop-filter: blur(8px); z-index: 50; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { 
            background: white; width: 100%; max-width: 500px; 
            border-radius: 35px; padding: 30px; position: relative; 
            animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            max-height: 90vh; overflow-y: auto; 
            border: 4px solid #f1f5f9;
        }
        @keyframes bounceIn { from{transform:scale(0.8);opacity:0} to{transform:scale(1);opacity:1} }

        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; }
        .filter-item { 
            flex-shrink: 0; background: white; border: 2px solid #f1f5f9; 
            padding: 8px 14px; border-radius: 12px; font-size: 0.75rem; font-weight: 800;
            color: var(--text-light); min-width: 100px; transition: 0.2s;
        }
        .filter-item:focus { border-color: var(--blue-border); color: var(--blue-strong); }
        
        #gatekeeper { position: fixed; inset: 0; z-index: 10000; background: #fffbeb; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background-image: radial-gradient(#fbbf24 1px, transparent 1px); background-size: 20px 20px; }
        #cloud-shield { position: fixed; inset: 0; z-index: 9999; background: #0f172a; color: white; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="cloud-shield">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-white mb-4"></div>
        <h2 class="font-cute font-bold text-xl">Sincronizando...</h2>
    </div>

    <!-- GATEKEEPER -->
    <div id="gatekeeper">
        <div class="mb-8 relative">
            <div class="absolute -top-10 -right-10 text-5xl animate-bounce">üíñ</div>
            <div class="absolute -bottom-4 -left-10 text-4xl animate-bounce" style="animation-delay:0.5s">‚ú®</div>
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/54.png" class="w-40 h-40 drop-shadow-2xl hover:scale-110 transition duration-500" alt="Psyduck">
        </div>
        <h1 class="text-4xl font-cute font-black text-slate-700 mb-8">Benai & Talita</h1>
        
        <input type="password" id="passInput" class="cute-input text-center text-xl tracking-[0.5em] w-64 mb-6 shadow-sm border-amber-200 focus:border-amber-400 bg-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" onkeyup="if(event.key==='Enter') attemptLogin()">
        <button onclick="attemptLogin()" class="cute-btn btn-psyduck w-64 py-4 text-sm shadow-xl text-amber-900">ENTRAR</button>
        <p id="loginError" class="text-red-400 font-bold text-xs mt-4 h-4"></p>
        
        <button class="pokeball-btn" onclick="openGatekeeperConfig()" title="Configura√ß√µes"></button>
    </div>

    <!-- APP CONTENT -->
    <div id="app-content" style="display: none;">
        
        <!-- HEADER -->
        <header class="max-w-4xl mx-auto px-4 pt-6 pb-2">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/home/54.png" class="w-14 h-14 drop-shadow-md">
                    <div>
                        <h1 class="font-cute font-black text-2xl text-slate-700 leading-none">Nossas Contas</h1>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Benai & Talita</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openReportModal()" class="head-btn hb-report"><i class="fa-brands fa-telegram text-xl"></i></button>
                    <button onclick="openConfig()" class="head-btn hb-config"><i data-lucide="settings-2" class="w-6 h-6"></i></button>
                    <button onclick="openCloudModal()" class="head-btn hb-cloud relative">
                        <div id="cloudStatusDot" class="w-3 h-3 rounded-full bg-slate-300 absolute top-2 right-2 border-2 border-white shadow-sm"></div>
                        <i data-lucide="cloud" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 pb-24">
            
            <!-- PSYDUCK ROAD (MOVED TOP) -->
            <div class="psy-road-container">
                <div class="cloud-bg text-4xl" style="top:10px; left:10%; animation-delay:0s">‚òÅÔ∏è</div>
                <div class="cloud-bg text-3xl" style="top:30px; right:20%; animation-delay:1.5s">‚òÅÔ∏è</div>
                <div class="cloud-bg text-2xl" style="top:60px; left:30%; animation-delay:3s">‚òÅÔ∏è</div>

                <div class="start-marker">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="pokeball-img">
                </div>
                <div class="end-marker">
                    <!-- Snorlax Bubble Updated -->
                    <div id="limit-bubble" class="limit-bubble-snorlax">Meta: R$ 4.000,00</div>
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/143.png" class="snorlax-img">
                </div>

                <div class="psy-track">
                    <div id="psy-fill" class="psy-progress-fill"></div>
                </div>
                
                <div id="psy-wrapper" class="psy-avatar-wrapper">
                    <div id="psy-bubble" class="cartoon-bubble">Psy?</div>
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/54.png" class="psy-img">
                </div>
            </div>

            <!-- DATE & ACTION (MOVED DOWN & CENTERED) -->
            <div class="flex justify-center items-center gap-4 mb-6">
                <div class="flex items-center gap-2 bg-white p-2 rounded-2xl shadow-sm border-2 border-slate-100">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-sky-400 hover:bg-sky-50 rounded-full transition"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="month-display" class="font-cute font-bold text-xl text-slate-700 uppercase w-36 text-center">JAN 2026</span>
                    <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-sky-400 hover:bg-sky-50 rounded-full transition"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <button onclick="openAddModal()" class="hb-add h-12 rounded-xl flex items-center gap-2 px-6">
                    <i data-lucide="plus" class="w-5 h-5"></i> NOVO
                </button>
            </div>

            <!-- TOTALS CARD -->
            <div class="cute-card p-6 bg-gradient-to-br from-white to-slate-50 relative z-20 mb-8">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <p class="text-[10px] font-bold text-indigo-300 uppercase tracking-widest mb-1 flex items-center gap-1"><i class="fa-solid fa-star text-yellow-400"></i> Fatura Atual</p>
                        <h2 id="total-invoice" class="font-cute font-black text-5xl text-indigo-500 drop-shadow-sm">R$ 0,00</h2>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <button id="btn-pay-toggle" onclick="toggleInvoicePaid()" class="cute-btn btn-action-pay px-4 py-2 text-xs mb-2">
                            <i class="fa-solid fa-check-double"></i> Pagar Fatura
                        </button>
                        <div class="text-[10px] font-bold text-slate-400 uppercase bg-slate-100 px-2 py-1 rounded-lg">Total Geral: <span id="total-general" class="text-slate-600">R$ 0,00</span></div>
                    </div>
                </div>

                <!-- SPLIT VISUAL -->
                <div class="flex gap-4">
                    <div class="flex-1 bg-sky-50 rounded-2xl p-4 border-2 border-sky-100 relative overflow-hidden shadow-sm hover:scale-105 transition duration-300">
                        <div class="absolute -right-2 -bottom-2 text-6xl opacity-10 rotate-12">üíô</div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-xl bg-sky-200 flex items-center justify-center text-xs font-black text-sky-600 border-2 border-white shadow-sm">B</div>
                            <span class="text-[10px] font-black text-sky-400 uppercase tracking-wider">Benai</span>
                        </div>
                        <p id="val-benai" class="font-cute font-black text-xl text-sky-600">R$ 0,00</p>
                    </div>
                    <div class="flex-1 bg-orange-50 rounded-2xl p-4 border-2 border-orange-100 relative overflow-hidden shadow-sm hover:scale-105 transition duration-300">
                        <div class="absolute -right-2 -bottom-2 text-6xl opacity-10 rotate-12">üß°</div>
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 rounded-xl bg-orange-200 flex items-center justify-center text-xs font-black text-orange-600 border-2 border-white shadow-sm">T</div>
                            <span class="text-[10px] font-black text-orange-400 uppercase tracking-wider">Talita</span>
                        </div>
                        <p id="val-talita" class="font-cute font-black text-xl text-orange-600">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <!-- FILTERS -->
            <div class="filter-scroll no-scrollbar">
                <input id="searchInp" class="filter-item w-32 focus:w-48" placeholder="üîç Buscar..." onkeyup="render()">
                <select id="filt-date" class="filter-item" onchange="render()"><option value="all">üìÖ Data: Todas</option></select>
                <select id="filt-cat" class="filter-item" onchange="render()"><option value="all">üìÅ Categoria: Todas</option></select>
                <select id="filt-pay" class="filter-item" onchange="render()"><option value="all">üí≥ Pagamento: Todos</option><option value="credit">Cr√©dito</option><option value="pix">Pix/Dinheiro</option></select>
                <select id="filt-who" class="filter-item" onchange="render()"><option value="all">üë§ Quem Pagou: Todos</option><option value="benai">üíô Benai</option><option value="talita">üß° Talita</option></select>
            </div>

            <!-- LIST -->
            <div id="transList" class="pb-10 min-h-[200px] space-y-3 mt-4">
                <!-- JS Rendered -->
            </div>

        </main>
    </div>

    <!-- MODAL ADD/EDIT -->
    <div id="modalAdd" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-cute font-black text-2xl text-slate-700" id="formTitle">Nova Aventura</h3>
                <button onclick="closeModals()" class="bg-slate-100 p-2 rounded-full hover:bg-red-100 hover:text-red-500 transition"><i data-lucide="x"></i></button>
            </div>
            
            <form onsubmit="event.preventDefault(); saveTrans();" class="space-y-4">
                <input type="hidden" id="editId">
                <div class="bg-yellow-50 p-5 rounded-3xl border-2 border-yellow-100 flex flex-col items-center">
                    <label class="text-[10px] font-bold text-yellow-600 uppercase tracking-widest mb-1">Quanto Custou?</label>
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-cute text-yellow-400 font-bold">R$</span>
                        <input id="formVal" type="tel" class="bg-transparent font-cute font-black text-4xl text-yellow-600 w-40 text-center outline-none placeholder-yellow-200" placeholder="0,00" oninput="maskMoney(this)" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">Data</label><input id="formDate" type="date" class="cute-input text-xs" required></div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">Categoria</label>
                        <div class="flex gap-2">
                            <select id="formCat" class="cute-input text-xs w-full" onchange="toggleTransportFields()"></select>
                            <button type="button" onclick="openCatManager()" class="w-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400 border-2 border-slate-200 hover:bg-slate-200"><i class="fa-solid fa-gear"></i></button>
                        </div>
                    </div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">Local</label><input id="formLoc" class="cute-input" placeholder="Ex: Shopping Palladium"></div>
                <div id="transportFields" class="grid grid-cols-2 gap-3 hidden bg-sky-50 p-4 rounded-2xl border-2 border-sky-100">
                    <div><label class="text-[9px] font-bold text-sky-400 uppercase block mb-1 ml-1">De Onde?</label><input id="formOrig" class="cute-input text-xs border-sky-100" placeholder="Casa"></div>
                    <div><label class="text-[9px] font-bold text-sky-400 uppercase block mb-1 ml-1">Para Onde?</label><input id="formDest" class="cute-input text-xs border-sky-100" placeholder="Trabalho"></div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">O que foi?</label><input id="formDesc" class="cute-input" placeholder="Ex: Jantar, Cinema..." required></div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">Pagamento</label>
                    <select id="formMethod" class="cute-input" onchange="togglePaymentFields()"><option value="credit">üí≥ Cart√£o de Cr√©dito</option><option value="pix">üí† Pix</option><option value="debit">üí≥ D√©bito</option><option value="cash">üíµ Dinheiro</option></select>
                </div>
                <div id="creditFields" class="p-4 bg-indigo-50 rounded-2xl border-2 border-indigo-100 hidden">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-indigo-300 uppercase block mb-1 ml-1">Tipo Cart√£o</label><select id="formCardType" class="cute-input text-xs bg-white border-indigo-100"><option value="physical">F√≠sico</option><option value="virtual">Virtual</option></select></div>
                        <div>
                            <label class="text-[10px] font-bold text-indigo-300 uppercase block mb-1 ml-1">Parcelas</label>
                            <select id="formInst" class="cute-input text-xs bg-white border-indigo-100">
                                <option value="1">√Ä Vista (1x)</option><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option><option value="5">5x</option><option value="6">6x</option><option value="7">7x</option><option value="8">8x</option><option value="9">9x</option><option value="10">10x</option><option value="11">11x</option><option value="12">12x</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="whoPaidField" class="hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">Quem Pagou?</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer"><input type="radio" name="whoPaid" value="benai" class="peer hidden" checked><div class="p-4 rounded-2xl border-2 border-slate-100 text-center text-xs font-bold text-slate-400 peer-checked:border-sky-400 peer-checked:bg-sky-50 peer-checked:text-sky-600 transition shadow-sm hover:bg-slate-50">BENAI üíô</div></label>
                        <label class="flex-1 cursor-pointer"><input type="radio" name="whoPaid" value="talita" class="peer hidden"><div class="p-4 rounded-2xl border-2 border-slate-100 text-center text-xs font-bold text-slate-400 peer-checked:border-orange-400 peer-checked:bg-orange-50 peer-checked:text-orange-600 transition shadow-sm hover:bg-slate-50">TALITA üß°</div></label>
                    </div>
                </div>
                <button type="submit" class="cute-btn btn-psyduck w-full py-4 text-sm mt-4 text-amber-900 shadow-lg">SALVAR AVENTURA</button>
                <button type="button" id="btnDel" onclick="delTrans()" class="hidden w-full text-center text-red-300 hover:text-red-500 text-xs font-bold mt-4 uppercase tracking-widest transition">Excluir Registro</button>
            </form>
        </div>
    </div>

    <!-- OTHER MODALS (CAT MANAGER, REPORT, CONFIG, CLOUD) -->
    <div id="modalCatManager" class="modal-overlay" style="z-index: 60;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4"><h3 class="font-cute font-bold text-xl text-slate-700">Categorias</h3><button onclick="document.getElementById('modalCatManager').style.display='none'"><i data-lucide="x" class="text-slate-400 hover:text-red-400"></i></button></div>
            <div class="flex gap-2 mb-4"><input id="newCatName" class="cute-input py-2 text-sm" placeholder="Nova Categoria..."><button onclick="addCat()" class="bg-sky-400 text-white rounded-xl px-4 font-bold border-b-4 border-sky-600 active:border-b-0 active:translate-y-1 transition"><i class="fa-solid fa-plus"></i></button></div>
            <div id="catList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <button onclick="document.getElementById('modalCatManager').style.display='none'" class="mt-4 text-xs font-bold text-slate-400 w-full hover:text-slate-600">FECHAR</button>
        </div>
    </div>

    <div id="modalReport" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="absolute top-4 right-4"><button onclick="closeModals()"><i data-lucide="x" class="text-slate-400 hover:text-red-400"></i></button></div>
            <div class="w-20 h-20 bg-sky-100 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-sm border-4 border-white animate-bounce">üíå</div>
            <h3 class="font-cute font-black text-2xl text-slate-700">Relat√≥rio Fofinho</h3>
            <p class="text-xs text-slate-400 mb-6 font-bold uppercase tracking-wide">Resumo Mensal</p>
            <div class="bg-slate-50 p-5 rounded-2xl text-left mb-4 border-2 border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Calculado com Amor</p>
                <div class="flex justify-between text-sm font-bold text-slate-600 border-b border-slate-200 pb-2 mb-2"><span>Fatura Total:</span><span id="rep-total" class="text-indigo-500">R$ 0,00</span></div>
                <div class="flex justify-between text-base font-black text-orange-500"><span>Parte da Talita:</span><span id="rep-share">R$ 0,00</span></div>
            </div>
            <textarea id="repMsg" class="cute-input text-sm h-24 mb-4 resize-none" placeholder="Escreva uma mensagem fofinha..."></textarea>
            <button onclick="sendTelegram()" class="cute-btn w-full py-4 bg-sky-400 text-white border-b-4 border-sky-600 hover:bg-sky-500 transition" style="background:var(--telegram-blue); border-color:var(--telegram-dark);"><i class="fa-brands fa-telegram"></i> ENVIAR NO TELEGRAM</button>
        </div>
    </div>

    <div id="modalConfig" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6"><h3 class="font-cute font-bold text-2xl text-slate-700">Ajustes</h3><button onclick="closeModals()"><i data-lucide="x" class="text-slate-400 hover:text-red-400"></i></button></div>
            <div class="space-y-5">
                <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">M√™s de Refer√™ncia</label><input id="cfgMonthSelect" type="month" class="cute-input" onchange="loadConfigForMonth()"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">Limite do Cart√£o</label><input id="cfgLimit" type="number" class="cute-input" placeholder="4000"></div>
                <div><label class="text-[10px] font-bold text-slate-400 uppercase block mb-1 ml-2">Telegram Talita (@)</label><div class="relative"><span class="absolute left-4 top-4 text-slate-400 font-bold">@</span><input id="cfgTele" type="text" class="cute-input pl-8"></div></div>
                <button onclick="saveConfig()" class="cute-btn btn-action-pay w-full py-4 mt-2 text-white bg-slate-700 border-slate-900">SALVAR AJUSTES</button>
            </div>
        </div>
    </div>

    <div id="modalCloud" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="flex justify-between items-center mb-4"><h3 class="font-cute font-bold text-2xl text-slate-700">Nuvem</h3><button onclick="closeModals()"><i data-lucide="x" class="text-slate-400 hover:text-red-400"></i></button></div>
            <input type="password" id="ghToken" class="cute-input text-center text-xs mb-4 border-dashed" placeholder="Token GitHub">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="saveToken()" class="cute-btn py-3 text-xs bg-slate-800 text-white border-b-4 border-black">SALVAR</button>
                <button onclick="forceSync()" class="cute-btn py-3 text-xs bg-sky-100 text-sky-600 border-b-4 border-sky-200">SYNC AGORA</button>
            </div>
            <div class="border-t-2 border-slate-100 pt-4 space-y-3">
                <button onclick="exportData()" class="cute-btn w-full py-3 bg-emerald-50 text-emerald-600 text-xs border-2 border-emerald-100 border-b-4"><i class="fa-solid fa-download"></i> BAIXAR BACKUP</button>
                <label class="cute-btn w-full py-3 bg-indigo-50 text-indigo-600 text-xs border-2 border-indigo-100 border-b-4 cursor-pointer"><i class="fa-solid fa-upload"></i> RESTAURAR BACKUP <input type="file" hidden onchange="importData(this)"></label>
                <label class="cute-btn w-full py-3 bg-amber-50 text-amber-700 text-xs border-2 border-amber-100 border-b-4 cursor-pointer"><i class="fa-solid fa-file-import"></i> IMPORTAR LEGADO <input type="file" hidden onchange="importLegacyData(this)"></label>
            </div>
        </div>
    </div>

    <div id="gk-config-modal" class="modal-overlay" style="z-index: 10001;">
        <div class="modal-content text-center">
            <div class="flex justify-between items-center mb-4"><h3 class="font-cute font-bold text-lg">Configura√ß√£o Inicial</h3><button onclick="document.getElementById('gk-config-modal').style.display='none'"><i data-lucide="x" class="text-slate-400"></i></button></div>
            <input type="password" id="gk-token" class="cute-input text-center mb-4" placeholder="GitHub Token Global">
            <button onclick="saveTokenGK()" class="cute-btn btn-psyduck w-full py-3 text-amber-900">SALVAR</button>
            <button onclick="document.getElementById('gk-config-modal').style.display='none'" class="mt-4 text-xs font-bold text-slate-400 hover:text-slate-600">CANCELAR</button>
        </div>
    </div>

    <script>
        // --- CORE ---
        const DB_KEY = 'BENAI_CARD_V3_PSYDUCK';
        const TOKEN_KEY = 'BENAI_GLOBAL_TOKEN';
        const GIST_DESC = 'BENAI_CARD_DB';
        const GIST_FILENAME = 'card_psy_db.json';
        const MASTER_PIN = "16359001";

        let db = { 
            config: { limits: {}, telegramUser: '' }, 
            categories: ['Alimenta√ß√£o','Mercado','Transporte','Lazer','Compras','Viagem','Sa√∫de','Assinaturas','Outros'], 
            transactions: [],
            paidMonths: [] 
        };
        let curDate = new Date();
        let gistId = null;

        const PSY_PHRASES = [
            ["Psy... tudo zen!", "Psy-controlado!", "Psy-tranquilo...", "Psy-f√°cil!"],
            ["Psy-hm?", "Psy-contas...", "Psy-d√∫vida!", "Psy-calma!"],
            ["Psy-ai!", "Psy-cabe√ßa...", "Psy-socorro!", "Psy-doeu!"],
            ["PSY-AAAAH!", "PSY-POBREZA!", "PSY-EXPLODIU!", "PSY-SOCIO!"]
        ];

        const getCatColor = (cat) => {
            const colors = ['#fca5a5', '#fdba74', '#fde047', '#bef264', '#6ee7b7', '#67e8f9', '#93c5fd', '#f0abfc', '#fda4af'];
            let hash = 0; for (let i = 0; i < cat.length; i++) hash = cat.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };
        
        const getCatIcon = (cat) => {
            const c = cat.toLowerCase();
            if(c.includes('aliment') || c.includes('restaurante')) return 'fa-solid fa-utensils';
            if(c.includes('mercado') || c.includes('compra')) return 'fa-solid fa-cart-shopping';
            if(c.includes('transporte') || c.includes('uber') || c.includes('gasolina')) return 'fa-solid fa-car';
            if(c.includes('lazer') || c.includes('cinema')) return 'fa-solid fa-gamepad';
            if(c.includes('viagem')) return 'fa-solid fa-plane';
            if(c.includes('sa√∫de') || c.includes('farm√°cia')) return 'fa-solid fa-heart-pulse';
            if(c.includes('assinatura') || c.includes('streaming')) return 'fa-solid fa-tv';
            return 'fa-solid fa-tag';
        };

        const getPaymentIcon = (method, cardType) => {
            if(method === 'credit') return `<i class="fa-regular fa-credit-card text-[#334155]"></i>`;
            if(method === 'debit') return `<i class="fa-solid fa-credit-card text-[#1e40af]"></i>`;
            if(method === 'pix') return `<i class="fa-brands fa-pix text-[#0f766e]"></i>`;
            return `<i class="fa-solid fa-money-bill text-[#15803d]"></i>`;
        };

        window.onload = () => {
            lucide.createIcons();
            const t = localStorage.getItem(TOKEN_KEY);
            if(t) { document.getElementById('ghToken').value = t; document.getElementById('gk-token').value = t; }
            checkAuth();
        };

        function checkAuth() {
            if (sessionStorage.getItem("benai_auth") === "true") {
                document.getElementById('gatekeeper').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                initApp();
            }
        }

        function attemptLogin() {
            const p = document.getElementById('passInput').value.trim();
            if (p === MASTER_PIN) {
                sessionStorage.setItem("benai_auth", "true");
                checkAuth();
            } else {
                const err = document.getElementById('loginError');
                err.innerText = "SENHA INCORRETA";
                setTimeout(()=>err.innerText="", 2000);
            }
        }

        async function initApp() {
            const shield = document.getElementById('cloud-shield');
            let loaded = false;
            const token = localStorage.getItem(TOKEN_KEY);

            if(token) {
                updateStatus('sync');
                shield.style.display = 'flex';
                try { loaded = await forceCloudLoad(); } catch(e) { updateStatus('error'); }
            }

            if(!loaded) {
                const saved = localStorage.getItem(DB_KEY);
                if(saved) try { db = JSON.parse(saved); } catch(e) {}
                updateStatus('offline');
            }
            
            if(!db.paidMonths) db.paidMonths = [];

            shield.style.display = 'none';
            setupUI();
            render();
        }

        function setupUI() {
            document.getElementById('formDate').value = new Date().toISOString().split('T')[0];
            updateCatSelects();
        }

        function updateCatSelects() {
            const f = document.getElementById('filt-cat');
            const s = document.getElementById('formCat');
            const currentF = f.value;
            f.innerHTML = '<option value="all">üìÅ Categoria: Todas</option>';
            s.innerHTML = '';
            
            db.categories.sort().forEach(c => {
                f.add(new Option(c, c));
                s.add(new Option(c, c));
            });
            f.value = currentF;
        }

        function render() {
            updateHeader();
            const mStr = getMonthKey(curDate);
            const data = getMonthData(curDate);
            const budget = db.config.limits[mStr] || 4000;
            const isMonthPaid = db.paidMonths.includes(mStr);

            let totalCredit = 0;
            let totalGeneral = 0;
            let totalPaidByBenai = 0; 
            let totalPaidByTalita = 0;
            let sharedTotal = 0;
            let hasCreditItems = false;

            const list = document.getElementById('transList');
            list.innerHTML = '';
            
            const term = document.getElementById('searchInp').value.toLowerCase();
            const cf = document.getElementById('filt-cat').value; 
            const pf = document.getElementById('filt-pay').value; 
            const wf = document.getElementById('filt-who').value; 
            const df = document.getElementById('filt-date').value;

            const dFilter = document.getElementById('filt-date');
            const currentD = dFilter.value;
            dFilter.innerHTML = '<option value="all">üìÖ Data: Todas</option>';
            const distinctDates = [...new Set(data.map(t => t.date))].sort();
            distinctDates.forEach(d => {
                const [y, m, day] = d.split('-');
                dFilter.add(new Option(`${day}/${m}`, d));
            });
            dFilter.value = currentD;

            data.sort((a,b) => b.date.localeCompare(a.date));

            data.forEach(t => {
                const isCredit = t.type === 'credit';
                
                if(term && !t.desc.toLowerCase().includes(term) && !t.loc?.toLowerCase().includes(term)) return;
                if(cf!=='all' && t.cat!==cf) return;
                if(pf === 'credit' && !isCredit) return;
                if(pf === 'pix' && isCredit) return;
                if(wf === 'benai' && t.whoPaid !== 'benai') return;
                if(wf === 'talita' && t.whoPaid !== 'talita') return;
                if(df!=='all' && t.date !== df) return;

                const val = t.instVal || t.val;
                totalGeneral += val;
                sharedTotal += val;

                if (isCredit) {
                    totalCredit += val;
                    totalPaidByBenai += val; 
                    hasCreditItems = true;
                } else {
                    if (t.whoPaid === 'talita') totalPaidByTalita += val;
                    else totalPaidByBenai += val;
                }

                const div = document.createElement('div');
                let statusClass = 'tx-item';
                let isItemPaid = t.paid; 
                if (isCredit) { isItemPaid = isMonthPaid; }

                if (isCredit) { statusClass += isItemPaid ? ' tx-paid' : ' tx-unpaid'; } else { statusClass += ' tx-other'; }

                div.className = statusClass;
                
                let whoBadge = '';
                if(!isCredit) {
                    whoBadge = t.whoPaid === 'talita' 
                        ? '<span class="text-[9px] bg-orange-100 text-orange-600 px-2 py-1 rounded-full font-bold shadow-sm">TALITA</span>'
                        : '<span class="text-[9px] bg-sky-100 text-sky-600 px-2 py-1 rounded-full font-bold shadow-sm">BENAI</span>';
                }

                const catColor = getCatColor(t.cat);
                const catIcon = getCatIcon(t.cat);
                const methodIcon = getPaymentIcon(t.method, t.cardType);
                const day = t.date.split('-')[2];
                const monthNum = t.date.split('-')[1];
                const months = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
                const monthStr = months[parseInt(monthNum)-1];

                let mainLoc = t.loc || 'Local';
                let isRoute = false;
                if(t.orig && t.dest) {
                    mainLoc = `${t.orig} <i class="fa-solid fa-arrow-right text-[10px] mx-1 text-slate-300"></i> ${t.dest}`;
                    isRoute = true;
                }

                div.innerHTML = `
                    <div class="tx-date-box">
                        <span class="tx-day">${day}</span>
                        <span class="tx-month">${monthStr}</span>
                    </div>
                    
                    <div class="tx-content">
                        <div class="tx-line-1">
                            <span class="${isRoute ? 'tx-route' : 'tx-loc'}">${mainLoc}</span>
                            <span class="text-slate-200 mx-1">|</span>
                            <span class="tx-desc">${t.desc}</span>
                        </div>
                        <div class="tx-line-2">
                            <span class="cat-badge" style="background:${catColor};">
                                <i class="${catIcon} text-[9px]"></i> ${t.cat}
                            </span>
                            ${whoBadge}
                        </div>
                        ${t.inst > 1 ? renderCartoonBar(t.curInst, t.inst) : ''}
                    </div>

                    <div class="tx-right">
                        <div class="tx-amount">R$ ${fmt(val)}</div>
                        <div class="pm-icon-only">${methodIcon}</div>
                    </div>
                `;
                
                div.onclick = (e) => { editTrans(t.id); };
                list.appendChild(div);
            });

            const pct = Math.min((totalCredit/budget)*100, 100);
            updatePsyduck(pct);

            const talitaFairShare = sharedTotal / 2;
            const talitaTransferAmount = talitaFairShare - totalPaidByTalita;
            
            window.reportData = { totalInvoice: totalCredit, talitaShare: Math.max(0, talitaTransferAmount) };

            document.getElementById('total-invoice').innerText = `R$ ${fmt(totalCredit)}`;
            document.getElementById('total-general').innerText = `R$ ${fmt(totalGeneral)}`;
            document.getElementById('val-benai').innerText = `R$ ${fmt(totalCredit - window.reportData.talitaShare)}`; 
            document.getElementById('val-talita').innerText = `R$ ${fmt(window.reportData.talitaShare)}`;
            
            document.getElementById('limit-bubble').innerText = `Meta: R$ ${fmt(budget)}`;
            
            const btnPay = document.getElementById('btn-pay-toggle');
            if (!hasCreditItems) {
                btnPay.style.display = 'none';
            } else {
                btnPay.style.display = 'flex';
                if (isMonthPaid) {
                    btnPay.className = "cute-btn btn-action-reopen px-4 py-2 text-xs mb-2";
                    btnPay.innerHTML = '<i class="fa-solid fa-rotate-left"></i> Reabrir Fatura';
                } else {
                    btnPay.className = "cute-btn btn-action-pay px-4 py-2 text-xs mb-2";
                    btnPay.innerHTML = '<i class="fa-solid fa-check-double"></i> Pagar Fatura';
                }
            }

            if(window.lucide) lucide.createIcons();
        }

        function updatePsyduck(pct) {
            const wrapper = document.getElementById('psy-wrapper');
            const bar = document.getElementById('psy-fill');
            const bubble = document.getElementById('psy-bubble');
            
            wrapper.style.left = `${pct}%`;
            bar.style.width = `${pct}%`;
            
            let stateIdx = 0;
            if (pct > 85) stateIdx = 3;
            else if (pct > 60) stateIdx = 2;
            else if (pct > 30) stateIdx = 1;
            
            const phrases = PSY_PHRASES[stateIdx];
            
            if (Math.random() > 0.7 || bubble.style.display === 'none') {
                bubble.innerText = phrases[Math.floor(Math.random() * phrases.length)];
            }
            bubble.style.display = 'block';
        }

        function renderCartoonBar(cur, total) {
            let html = '<div class="cartoon-bar">';
            const maxPills = 10;
            const showTotal = total > maxPills ? maxPills : total;
            for(let i=1; i<=showTotal; i++) {
                let cls = 'cb-pill';
                if (i < cur) cls += ' paid';
                else if (i === cur) cls += ' current';
                else cls += ' future';
                html += `<div class="${cls}"></div>`;
            }
            if(total > maxPills) html += '<div class="cb-text">+</div>';
            html += `<div class="cb-text">${cur}/${total}</div>`;
            html += '</div>';
            return html;
        }

        function getMonthData(d) {
            const m = d.getMonth(), y = d.getFullYear(); 
            let res = [];
            db.transactions.forEach(t => {
                const [ty, tm, td] = t.date.split('-').map(Number);
                const tDate = new Date(ty, tm-1, td);
                if(t.type === 'credit') {
                    let startM = tDate.getMonth();
                    let startY = tDate.getFullYear();
                    const absStart = startY * 12 + startM;
                    const absView = y * 12 + m;
                    const absEnd = absStart + (t.inst - 1);
                    if(absView >= absStart && absView <= absEnd) {
                        res.push({...t, instVal: t.val / t.inst, curInst: (absView - absStart) + 1});
                    }
                } else {
                    if(tDate.getMonth() === m && tDate.getFullYear() === y) {
                        res.push({...t, instVal: t.val, curInst: 1});
                    }
                }
            });
            return res;
        }

        // --- ACTIONS ---
        function togglePaymentFields() {
            const method = document.getElementById('formMethod').value;
            const cFields = document.getElementById('creditFields');
            const wPaid = document.getElementById('whoPaidField');
            if (method === 'credit') { cFields.classList.remove('hidden'); wPaid.classList.add('hidden'); } 
            else { cFields.classList.add('hidden'); wPaid.classList.remove('hidden'); }
        }
        
        function toggleTransportFields() {
            const cat = document.getElementById('formCat').value.toLowerCase();
            const fields = document.getElementById('transportFields');
            if(cat.includes('transporte') || cat.includes('uber') || cat.includes('99') || cat.includes('onibus')) { fields.classList.remove('hidden'); } 
            else { fields.classList.add('hidden'); }
        }

        function openAddModal() {
            document.getElementById('formTitle').innerText = "Nova Aventura";
            document.getElementById('editId').value = '';
            document.getElementById('formVal').value = '';
            document.getElementById('formDesc').value = '';
            document.getElementById('formLoc').value = '';
            document.getElementById('formOrig').value = '';
            document.getElementById('formDest').value = '';
            document.getElementById('formMethod').value = 'credit';
            togglePaymentFields();
            toggleTransportFields();
            document.getElementById('btnDel').classList.add('hidden');
            document.getElementById('modalAdd').style.display = 'flex';
        }

        function editTrans(id) {
            const t = db.transactions.find(x => x.id == id);
            if(!t) return;
            document.getElementById('formTitle').innerText = "Editar";
            document.getElementById('editId').value = t.id;
            document.getElementById('formVal').value = fmt(t.val);
            document.getElementById('formDesc').value = t.desc;
            document.getElementById('formDate').value = t.date;
            document.getElementById('formCat').value = t.cat;
            document.getElementById('formLoc').value = t.loc || '';
            document.getElementById('formOrig').value = t.orig || '';
            document.getElementById('formDest').value = t.dest || '';
            
            const cat = t.cat.toLowerCase();
            const fields = document.getElementById('transportFields');
            if(t.orig || t.dest || cat.includes('transporte') || cat.includes('uber')) { fields.classList.remove('hidden'); } 
            else { fields.classList.add('hidden'); }
            
            const method = t.type === 'credit' ? 'credit' : (t.method || 'pix');
            document.getElementById('formMethod').value = method;
            togglePaymentFields();

            if(t.type === 'credit') {
                document.getElementById('formInst').value = t.inst;
                document.getElementById('formCardType').value = t.cardType || 'physical';
            } else {
                const radios = document.getElementsByName('whoPaid');
                radios.forEach(r => r.checked = (r.value === t.whoPaid));
            }
            
            document.getElementById('btnDel').classList.remove('hidden');
            document.getElementById('modalAdd').style.display = 'flex';
        }

        function saveTrans() {
            const id = document.getElementById('editId').value;
            const val = parseMoney(document.getElementById('formVal').value);
            if(!val) return;

            const method = document.getElementById('formMethod').value;
            const type = method === 'credit' ? 'credit' : 'other';
            let whoPaid = 'benai';
            if (type === 'other') {
                const radios = document.getElementsByName('whoPaid');
                radios.forEach(r => { if(r.checked) whoPaid = r.value; });
            }

            const data = {
                id: id ? parseInt(id) : Date.now(),
                type: type,
                method: method,
                val: val,
                desc: document.getElementById('formDesc').value,
                date: document.getElementById('formDate').value,
                cat: document.getElementById('formCat').value,
                loc: document.getElementById('formLoc').value,
                orig: document.getElementById('formOrig').value,
                dest: document.getElementById('formDest').value,
                inst: type === 'credit' ? (parseInt(document.getElementById('formInst').value) || 1) : 1,
                cardType: type === 'credit' ? document.getElementById('formCardType').value : null,
                whoPaid: whoPaid,
                paid: id ? (db.transactions.find(x=>x.id==id)?.paid || false) : false 
            };

            if(id) {
                const idx = db.transactions.findIndex(x => x.id == id);
                db.transactions[idx] = data;
            } else db.transactions.push(data);

            saveDB(); closeModals(); render();
            confetti({ particleCount: 50, spread: 50, origin: { y: 0.6 }, colors: ['#fde047', '#0ea5e9'] });
        }

        function delTrans() {
            if(confirm("Excluir?")) {
                db.transactions = db.transactions.filter(t => t.id != document.getElementById('editId').value);
                saveDB(); closeModals(); render();
            }
        }

        function toggleInvoicePaid() {
            const mStr = getMonthKey(curDate);
            const idx = db.paidMonths.indexOf(mStr);
            let paying = false;
            if(idx > -1) { db.paidMonths.splice(idx, 1); } 
            else { db.paidMonths.push(mStr); paying = true; }
            saveDB(); render();
            if(paying) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        // --- CATEGORY MANAGER ---
        function openCatManager() { document.getElementById('modalCatManager').style.display = 'flex'; renderCatList(); }
        function renderCatList() {
            const l = document.getElementById('catList'); l.innerHTML = '';
            db.categories.sort().forEach((c, i) => {
                l.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl text-sm font-bold text-slate-600 border-2 border-slate-100"><span>${c}</span> <div class="flex gap-2"><i class="fa-solid fa-pencil cursor-pointer text-blue-400 hover:text-blue-600" onclick="editCat(${i})"></i> <i class="fa-solid fa-trash cursor-pointer text-red-400 hover:text-red-600" onclick="delCat(${i})"></i></div></div>`;
            });
        }
        function addCat() { const n = document.getElementById('newCatName').value; if(n){ db.categories.push(n); saveDB(); renderCatList(); updateCatSelects(); document.getElementById('newCatName').value=''; } }
        function editCat(i) { const n = prompt("Novo nome:", db.categories[i]); if(n) { db.categories[i]=n; saveDB(); renderCatList(); updateCatSelects(); } }
        function delCat(i) { if(confirm("Excluir?")) { db.categories.splice(i,1); saveDB(); renderCatList(); updateCatSelects(); } }

        // --- CONFIG & LIMITS ---
        function openConfig() { 
            const mStr = getMonthKey(curDate);
            document.getElementById('cfgMonthSelect').value = mStr; 
            loadConfigForMonth();
            document.getElementById('cfgTele').value = db.config.telegramUser || '';
            document.getElementById('modalConfig').style.display='flex'; 
        }
        function loadConfigForMonth() {
            const mStr = document.getElementById('cfgMonthSelect').value;
            document.getElementById('cfgLimit').value = db.config.limits[mStr] || 4000;
        }
        function saveConfig() {
            const mStr = document.getElementById('cfgMonthSelect').value;
            if(mStr) { db.config.limits[mStr] = parseFloat(document.getElementById('cfgLimit').value); }
            db.config.telegramUser = document.getElementById('cfgTele').value.replace('@','').trim();
            saveDB(); closeModals(); render();
        }

        // --- REPORT & TELEGRAM ---
        function openReportModal() {
            document.getElementById('rep-total').innerText = document.getElementById('total-invoice').innerText;
            document.getElementById('rep-share').innerText = document.getElementById('val-talita').innerText;
            document.getElementById('modalReport').style.display = 'flex';
        }
        function sendTelegram() {
            const user = db.config.telegramUser;
            const month = document.getElementById('month-display').innerText;
            const total = document.getElementById('rep-total').innerText;
            const share = document.getElementById('rep-share').innerText;
            const msg = document.getElementById('repMsg').value;
            let text = `üê• **Tesouro do Casal - ${month}**%0A%0A`;
            text += `üí∞ Fatura Total: *${total}*%0A`;
            text += `üß° Parte da Talita: *${share}*%0A`;
            if(msg) text += `%0Aüíå _${encodeURIComponent(msg)}_%0A`;
            text += `%0A_Enviado com amor pelo Benai App_`;
            const url = user ? `https://t.me/${user}?text=${text}` : `https://t.me/share/url?url=${text}`;
            window.open(url, '_blank');
            closeModals();
        }

        // --- DATA & CLOUD ---
        async function forceCloudLoad() {
            const token = localStorage.getItem(TOKEN_KEY);
            if (!token) return false;
            try {
                const res = await fetch('https://api.github.com/gists', { headers: { 'Authorization': `token ${token}` } });
                const gists = await res.json();
                const found = gists.find(g => g.description === GIST_DESC);
                if (found) {
                    gistId = found.id;
                    const r = await fetch(found.url, { headers: { 'Authorization': `token ${token}` } });
                    const d = await r.json();
                    if (d.files[GIST_FILENAME]) {
                        db = JSON.parse(d.files[GIST_FILENAME].content);
                        localStorage.setItem(DB_KEY, JSON.stringify(db));
                        return true;
                    }
                }
            } catch (e) { return false; }
            return false;
        }

        async function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            const token = localStorage.getItem(TOKEN_KEY);
            if(token) {
                updateStatus('sync');
                try {
                    // Same Logic as Prime
                    if(!gistId) {
                         const s = await fetch('https://api.github.com/gists',{headers:{'Authorization':`token ${token}`}});
                         const g = await s.json();
                         const f = g.find(x=>x.description===GIST_DESC);
                         if(f) gistId = f.id;
                    }
                    const body = JSON.stringify({ description: GIST_DESC, public: false, files: { [GIST_FILENAME]: { content: JSON.stringify(db) } } });
                    let url = 'https://api.github.com/gists'; let method = 'POST';
                    if(gistId) { url += `/${gistId}`; method = 'PATCH'; }
                    await fetch(url, { method, headers: {'Authorization': `token ${token}`}, body });
                    updateStatus('online');
                } catch(e) { updateStatus('error'); }
            }
        }

        // --- UTILS ---
        function maskMoney(i) { let v = i.value.replace(/\D/g,""); v=(v/100).toFixed(2)+""; v=v.replace(".",","); v=v.replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1."); i.value=v; }
        function parseMoney(s) { 
            if(typeof s === 'number') return s;
            if(!s) return 0;
            const clean = s.replace(/[^0-9,\.]/g, '').replace(/\./g,'').replace(',','.');
            return parseFloat(clean) || 0; 
        }
        function fmt(n) { return n.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); }
        function fmtDate(d) { return d.split('-').reverse().join('/'); }
        function getMonthKey(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
        function updateHeader() { 
            const m = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"]; 
            document.getElementById('month-display').innerText = `${m[curDate.getMonth()]} ${curDate.getFullYear()}`; 
        }
        function changeMonth(d) { curDate.setMonth(curDate.getMonth()+d); render(); }
        
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
        function openCloudModal() { document.getElementById('modalCloud').style.display='flex'; }
        function openGatekeeperConfig() { document.getElementById('gk-config-modal').style.display='flex'; }
        function updateStatus(s) { const d=document.getElementById('cloudStatusDot'); if(d) d.className = 'w-3 h-3 rounded-full absolute top-2 right-2 border-2 border-white shadow-sm ' + (s==='online'?'bg-emerald-400':(s==='sync'?'bg-sky-400 animate-pulse':'bg-slate-300')); }
        function saveToken() { const t=document.getElementById('ghToken').value; if(t) { localStorage.setItem(TOKEN_KEY, t); saveDB(); closeModals(); } }
        function saveTokenGK() { const t=document.getElementById('gk-token').value; if(t) { localStorage.setItem(TOKEN_KEY, t); location.reload(); } }
        function forceSync() { initApp(); closeModals(); }

        // --- EXPORT/IMPORT ---
        function exportData() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type:'application/json'}));
            a.download = 'benai_card_backup.json'; a.click();
        }
        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    db = JSON.parse(e.target.result);
                    if(!db.paidMonths) db.paidMonths = [];
                    saveDB(); location.reload();
                } catch(err) { alert("Arquivo inv√°lido"); }
            };
            reader.readAsText(file);
        }

        // --- MIGRATION LOGIC ---
        function importLegacyData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const raw = JSON.parse(e.target.result);
                    let transactionsToImport = [];
                    let catsToImport = [];
                    if (Array.isArray(raw)) { transactionsToImport = raw; } 
                    else if (raw.transactions) { transactionsToImport = raw.transactions; if(raw.categories) catsToImport = raw.categories; }
                    catsToImport.forEach(c => { if(!db.categories.includes(c)) db.categories.push(c); });
                    let count = 0;
                    transactionsToImport.forEach(oldT => {
                        if(db.transactions.find(t => t.id === oldT.id)) return;
                        const isCredit = (oldT.type === 'credit' || oldT.method === 'credit');
                        const type = isCredit ? 'credit' : 'other';
                        const method = isCredit ? 'credit' : (oldT.method || 'pix');
                        const val = parseMoney(oldT.val);
                        const newT = {
                            id: oldT.id || (Date.now() + count),
                            type: type, val: val, desc: oldT.desc || 'Sem Descri√ß√£o', date: oldT.date, cat: oldT.cat || 'Outros',
                            inst: parseInt(oldT.inst) || 1, method: method, whoPaid: oldT.whoPaid || 'benai', paid: true,
                            loc: oldT.loc || '', orig: oldT.orig || oldT.origem || '', dest: oldT.dest || oldT.destino || ''
                        };
                        if (newT.date.includes('/')) { const parts = newT.date.split('/'); if (parts.length === 3) newT.date = `${parts[2]}-${parts[1]}-${parts[0]}`; }
                        db.transactions.push(newT); count++;
                    });
                    saveDB(); updateCatSelects(); render(); closeModals(); alert(`${count} registros importados!`);
                } catch(err) { alert("Erro: " + err.message); }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
