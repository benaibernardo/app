<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benai Manager | Painel</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #001F5B; --accent: #00A8E8; --bg: #f0f2f5;
            --surface: #ffffff; --border: #e2e8f0; --text: #1f2937;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --c-drop: #ef4444; --c-rnp: #f59e0b; --c-iso: #06b6d4; 
            --c-pyr: #8b5cf6; --c-bi: #00A8E8; --c-tri: #6366f1;
            --font-ui: 'Plus Jakarta Sans', sans-serif; --font-num: 'Outfit', sans-serif;
        }
        
        * { box-sizing: border-box; outline: none; font-family: var(--font-ui); }
        
        /* 4-COLUMN GRID LAYOUT */
        body { margin: 0; height: 100vh; display: grid; grid-template-columns: 260px 1fr 280px 280px; overflow: hidden; background: var(--bg); color: var(--text); font-size: 13px; }

        /* SIDEBARS */
        .sidebar { background: var(--surface); display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); border-left: 1px solid var(--border); z-index: 10; height: 100vh; overflow: hidden; }
        
        .brand { color: var(--primary); font-family: var(--font-num); font-weight: 900; font-size: 1.2rem; margin-bottom: 20px; display: flex; flex-direction: column; line-height: 1; }
        .brand span { font-size: 0.6rem; color: var(--accent); letter-spacing: 1px; text-transform: uppercase; margin-top: 4px; }

        /* LISTS */
        .list-header { font-weight: 800; color: var(--text); font-size: 0.75rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px; }
        .list-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px; }
        
        /* STUDENT CARD */
        .student-item { padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: white; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .student-item:hover { border-color: var(--accent); transform: translateX(2px); }
        .student-item.active { background: #f0f9ff; border-color: var(--accent); border-left: 4px solid var(--accent); }
        .st-name { font-weight: 700; color: var(--primary); display: block; font-family: var(--font-num); font-size: 0.95rem; }
        .st-info { font-size: 0.7rem; color: #64748b; display: flex; justify-content: space-between; margin-top: 4px; position: relative; z-index: 2; }
        .st-bar-bg { height: 4px; width: 100%; background: #f1f5f9; border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .st-bar-fill { height: 100%; background: var(--success); border-radius: 2px; transition: width 0.5s; }

        .item-card { padding: 8px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-size: 0.85rem; font-weight: 600; }
        .item-card:hover { background: white; border-color: var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .item-actions { display:flex; gap:8px; opacity:0.5; transition:0.2s; }
        .item-card:hover .item-actions { opacity:1; }

        /* BUTTONS */
        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85rem; transition: 0.2s; width: 100%; }
        .btn-pri { background: var(--primary); color: white; margin-bottom: 5px; }
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* TOOLBAR */
        .toolbar { background: var(--surface); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; flex-shrink: 0; }
        .chip { padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; cursor: pointer; border: 1px solid var(--border); background: white; color: #64748b; transition: 0.2s; }
        .chip:hover { transform: translateY(-1px); border-color: var(--accent); color: var(--accent); }
        .chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* CENTER CANVAS */
        .col-center { display: flex; flex-direction: column; background: #e2e8f0; height: 100vh; overflow: hidden; position: relative; }
        .canvas { flex: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; align-items: flex-start; }
        
        /* PHONE PREVIEW (MATCHING ALUNO.HTML) */
        .phone { width: 100%; max-width: 480px; background: #fdfdfd; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-height: 800px; border: 1px solid #cbd5e1; overflow: hidden; margin-bottom: 50px; }
        
        .ph-header { background: var(--primary); padding: 25px 20px; color: white; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; box-shadow: 0 10px 30px -10px rgba(0,31,91,0.3); z-index: 5; }
        .ph-brand { font-size: 0.65rem; letter-spacing: 2px; opacity: 0.8; text-transform: uppercase; margin-bottom: 4px; font-weight: 700; font-family: var(--font-num); color: var(--accent); }
        .ph-inp { background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 0; width: 100%; font-weight: 800; font-family: var(--font-num); font-size: 1.6rem; margin-bottom: 2px; }
        .ph-inp:focus { outline: none; border-color: var(--accent); }
        .ph-inp-sub { background: transparent; border: none; color: #bae6fd; font-size: 0.9rem; width: 100%; font-weight: 500; margin-bottom: 10px; }
        
        .ph-dates { display: flex; gap: 8px; font-size: 0.65rem; font-weight: 700; color: white; opacity:0.9; }
        .ph-date-badge { background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 6px; display:flex; align-items:center; gap:4px; border:1px solid rgba(255,255,255,0.1); }

        .ph-body { padding: 20px; flex: 1; background: #fdfdfd; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }

        /* BLOCKS IN PREVIEW */
        .block-container { position: relative; margin-bottom: 10px; transition: 0.3s; }
        .block-head { margin-bottom: 5px; }
        .block-head-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        
        .w-title { background: transparent; border: none; font-weight: 800; font-family: var(--font-num); color: var(--primary); font-size: 0.9rem; text-transform: uppercase; width: 100%; border-left: 4px solid var(--accent); padding-left: 10px; }
        .w-details { width: 100%; background: transparent; border: none; font-size: 0.75rem; color: #64748b; padding-left: 14px; font-style: italic; }
        
        /* Drawer/Collapse Logic */
        .block-body-content { transition: max-height 0.3s ease-in-out, opacity 0.3s; overflow: hidden; max-height: 2000px; opacity: 1; }
        .block-container.collapsed .block-body-content { max-height: 0; opacity: 0; }
        .block-container.collapsed .w-title { opacity: 0.5; }

        .biset-cont { border: 2px dashed var(--c-bi); background: #f0f9ff; border-radius: 16px; padding: 30px 10px 10px 10px; position: relative; }
        .biset-cont::before { content: 'BI-SET'; position: absolute; top: 0; left: 0; background: var(--c-bi); color: white; font-size: 0.65rem; font-weight: 800; padding: 4px 12px; border-bottom-right-radius: 12px; }
        .biset-cont .w-title { display: none; }
        .biset-cont .w-details { display: none; }
        
        .triset-cont { border: 2px dashed var(--c-tri); background: #fdf4ff; border-radius: 16px; padding: 30px 10px 10px 10px; position: relative; }
        .triset-cont::before { content: 'TRI-SET'; position: absolute; top: 0; left: 0; background: var(--c-tri); color: white; font-size: 0.65rem; font-weight: 800; padding: 4px 12px; border-bottom-right-radius: 12px; }
        .triset-cont .w-title { display: none; }
        .triset-cont .w-details { display: none; }

        .active-block { ring: 2px solid var(--accent); border-radius: 12px; }

        /* EXERCISE ROW IN PREVIEW */
        .ex-row { background: white; border: 1px solid var(--border); padding: 15px; border-radius: 14px; margin-bottom: 10px; border-left: 4px solid #cbd5e1; position: relative; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .ex-row:hover { border-color: var(--accent); }
        
        .ex-row.m-Drop { border-left-color: var(--c-drop); background: #fef2f2; }
        .ex-row.m-RNP { border-left-color: var(--c-rnp); background: #fff7ed; }
        .ex-row.m-Iso { border-left-color: var(--c-iso); background: #ecfeff; }
        .ex-row.m-Pyr { border-left-color: var(--c-pyr); background: #faf5ff; }

        .ex-name { font-weight: 700; font-size: 1rem; display: block; margin-bottom: 8px; color: #1e293b; font-family: var(--font-num); display: flex; align-items: center; gap: 6px; }
        .ex-name i { color: #ef4444; font-size: 1.1rem; }
        
        .pills { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        .pill-wrap { display: flex; flex-direction: column; }
        .pill-inp { width: 50px; text-align: center; border: 1px solid var(--border); border-radius: 8px; padding: 4px; font-size: 0.8rem; font-weight: 700; color: #475569; font-family: var(--font-num); }
        .pill-lbl { font-size: 0.6rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; }
        .obs-inp { width: 100%; border: none; background: #fffbeb; font-size: 0.8rem; padding: 8px; margin-top: 5px; border-radius: 8px; color: #b45309; border-left: 3px solid #f59e0b; }

        .row-actions { position: absolute; top: -10px; right: 10px; display: none; background: white; padding: 4px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; z-index: 10; }
        .ex-row:hover .row-actions { display: flex; gap: 5px; }
        .icon-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; color: #64748b; background: #f1f5f9; transition: 0.2s; }
        .icon-btn:hover { background: var(--primary); color: white; }
        .icon-btn.del:hover { background: var(--danger); }

        /* INPUTS RIGHT */
        .search-inp { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; font-family: var(--font-ui); }
        .cat-select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; background: white; font-weight: 700; color: var(--primary); }

        .logic-item { display: flex; gap: 5px; margin-bottom: 5px; }
        .logic-inp { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.8rem; }

        .cloud-status { padding: 5px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; display: flex; align-items: center; gap: 5px; cursor: pointer; background: #f1f5f9; width: fit-content; margin-bottom: 10px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .dot.ok { background: var(--success); }
        .dot.err { background: var(--danger); }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        #toast { position: fixed; top: 20px; right: 20px; background: var(--success); color: white; padding: 10px 20px; border-radius: 8px; font-weight: 700; transform: translateX(150%); transition: 0.3s; z-index: 2000; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        #toast.show { transform: translateX(0); }
        
        /* CLOUD SHIELD (BLOCKING OVERLAY) */
        #cloud-shield {
            position: fixed; inset: 0; z-index: 9999;
            background: #0f172a; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .shield-spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #0ea5e9; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Print Area */
        #print-area { display: none; }
    </style>
</head>
<body>

<!-- CLOUD SHIELD (Load Blocker) -->
<div id="cloud-shield">
    <div class="shield-spinner"></div>
    <h2 style="font-size:1.5rem; font-weight:800; font-family:var(--font-num); letter-spacing:2px; text-transform:uppercase;">Sincronizando</h2>
    <p style="font-size:0.8rem; color:#94a3b8; margin-top:10px;">Buscando dados da nuvem...</p>
</div>

<!-- TOAST -->
<div id="toast">Ação realizada!</div>

<!-- MODAL EXERCICIO (ADD/EDIT) -->
<div id="modal-ex" class="modal">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--primary); font-weight:800; font-family:var(--font-num);" id="modalExTitle">Gerenciar Exercício</h3>
        <input type="hidden" id="exEditBlockIdx">
        <input type="hidden" id="exEditItemIdx">
        <input type="hidden" id="exEditLibId"> <!-- NEW for Library Edit -->
        
        <label class="list-header">Nome do Exercício</label>
        <input id="exName" class="search-inp" placeholder="Ex: Supino Reto">
        
        <label class="list-header">Link do Vídeo (YouTube)</label>
        <input id="exLink" class="search-inp" placeholder="https://...">
        
        <!-- Shown when adding new OR editing library item -->
        <div id="libOptions">
            <label class="list-header">Categoria</label>
            <select id="exCat" class="cat-select"></select>
            <label class="list-header">Tipo</label>
            <select id="exType" class="cat-select">
                <option value="Musculação">Musculação</option>
                <option value="Calistenia">Calistenia</option>
            </select>
        </div>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-pri" onclick="confirmExSave()">Salvar</button>
            <button class="btn btn-sec" onclick="closeExModal()">Cancelar</button>
        </div>
    </div>
</div>

<!-- MODAL CLOUD -->
<div id="modal-cloud" class="modal">
    <div class="modal-box">
        <h3 style="margin-top:0; color:var(--primary); font-weight:800;">Central de Dados</h3>
        <p style="font-size:0.8rem; color:#64748b; margin-bottom:10px;">Gerenciar Sincronização e Backup.</p>
        
        <div style="margin-bottom:10px;">
            <label class="list-header">Token Global</label>
            <input id="ghToken" type="password" class="search-inp" placeholder="ghp_...">
            <button class="btn btn-pri" onclick="saveToken()">Salvar Token</button>
        </div>

        <div style="border-top:1px solid var(--border); padding-top:15px; margin-top:10px; display:flex; gap:5px; flex-direction:column;">
            <button class="btn btn-sec" style="background:#1e293b; color:white; border:none;" onclick="backupData()"><i class="fas fa-download"></i> Fazer Backup (JSON)</button>
            <label class="btn btn-sec" style="cursor:pointer;"><i class="fas fa-upload"></i> Restaurar Backup <input type="file" id="fileIn" hidden onchange="restoreData(this)"></label>
        </div>
        
        <button class="btn btn-sec" style="margin-top:10px; border:none; color:var(--danger);" onclick="document.getElementById('modal-cloud').style.display='none'">Fechar</button>
    </div>
</div>

<!-- COLUMN 1: ALUNOS -->
<div class="sidebar">
    <div class="brand">BENAI BERNARDO <span>Manager</span></div>
    
    <div class="cloud-status" onclick="document.getElementById('modal-cloud').style.display='flex'">
        <div id="stDot" class="dot"></div> <span id="stText">Offline</span>
    </div>

    <button class="btn btn-pri" onclick="createStudent()">+ Novo Aluno</button>
    
    <input class="search-inp" placeholder="Filtrar aluno..." onkeyup="renderStudents(this.value)">
    <div class="list-header">Lista de Alunos</div>
    <div class="list-scroll" id="studentList"></div>
</div>

<!-- COLUMN 2: PHONE -->
<div class="col-center">
    <div class="toolbar">
        <span style="font-weight:800; color:var(--primary); font-size:0.7rem;">PRESETS:</span>
        <div class="chip" onclick="applyPreset('3','15','60s')">Padrão</div>
        <div class="chip" onclick="applyPreset('4','10','60s')">Hipertrofia</div>
        <div class="chip" onclick="applyPreset('3','20','45s')">Metabólico</div>
        <div class="chip" onclick="applyPreset('5','5','180s')">Força</div>
        <div class="chip" onclick="applyPreset('3','30','30s')">RML</div>
    </div>

    <div class="canvas">
        <div class="phone">
            <div class="ph-header">
                <div class="ph-brand">BENAI BERNARDO</div>
                <input id="sName" class="ph-inp" placeholder="Nome do Aluno" oninput="updateCurrent()">
                <input id="sFocus" class="ph-inp-sub" placeholder="Objetivo Principal" oninput="updateCurrent()">
                <div class="ph-dates">
                    <div class="ph-date-badge"><i class="fas fa-calendar"></i> <span id="lblStart">--/--</span></div>
                    <div class="ph-date-badge"><i class="fas fa-hourglass"></i> <span id="lblEnd">--/--</span></div>
                </div>
            </div>
            <div class="ph-body" id="workoutBlocks">
                <!-- BLOCKS RENDER HERE -->
            </div>
            <div style="padding: 10px; display:flex; gap:5px;">
                <button class="btn btn-sec" onclick="addBlock('Normal')">+ Bloco</button>
                <button class="btn btn-sec" onclick="addBlock('BiSet')">+ Bi-Set</button>
                <button class="btn btn-sec" onclick="addBlock('TriSet')">+ Tri-Set</button>
            </div>
        </div>
    </div>
</div>

<!-- COLUMN 3: SETTINGS -->
<div class="sidebar">
    <div class="list-header" style="margin-top:0;">Configurações do Treino</div>
    <div style="background:white; padding:10px; border-radius:8px; border:1px solid var(--border); margin-bottom:10px;">
        <label class="pill-lbl">Metodologia</label>
        <select id="sMethod" class="cat-select" style="margin-bottom:10px; width:100%;" onchange="updateCurrent()">
            <option value="Musculação">Musculação</option>
            <option value="Calistenia">Calistenia</option>
        </select>
        
        <label class="pill-lbl">Início</label>
        <input type="date" id="dStart" class="search-inp" style="margin-bottom:5px;" onchange="updateCurrent()">
        <label class="pill-lbl">Vencimento</label>
        <input type="date" id="dEnd" class="search-inp" style="margin-bottom:0;" onchange="updateCurrent()">
    </div>

    <div class="list-header">Lógica do Treino</div>
    <div id="logicList" style="margin-bottom:20px;"></div>
    <button class="btn btn-sec" onclick="addLogic()">+ Frase</button>

    <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:8px;">
        <button class="btn btn-pri" style="background:var(--accent);" onclick="generateLink('new')"><i class="fas fa-link"></i> Criar Link</button>
        <button class="btn btn-pri" style="background:var(--success);" onclick="generateLink('update')"><i class="fas fa-sync"></i> Atualizar Link</button>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-sec" onclick="generateOffline()"><i class="fas fa-qrcode"></i> Offline</button>
            <button class="btn btn-sec" onclick="printPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
    </div>
</div>

<!-- COLUMN 4: LIBRARY (NEW) -->
<div class="sidebar" style="background:#f8fafc;">
    <div class="list-header" style="margin-top:0;">Biblioteca de Exercícios</div>
    <div style="display:flex; gap:5px;">
        <input id="libSearch" class="search-inp" placeholder="Buscar..." onkeyup="renderLib()">
        <button class="btn btn-pri" style="width:40px;" onclick="openExModal(null, null)">+</button>
    </div>
    <select id="libCat" class="cat-select" onchange="renderLib()"></select>
    
    <div class="list-scroll" id="libList"></div>
</div>

<div id="print-area"></div>

<script>
    // --- MASTER CONFIG (FIXED & STANDARDIZED) ---
    const DB_KEY = 'BENAI_MANAGER_MASTER'; // Definitive Key
    const TOKEN_KEY = 'BENAI_GLOBAL_TOKEN'; 
    const GIST_DESC = 'BENAI_MANAGER_DB'; // Unique description for this app state
    const GIST_FILENAME = 'manager_data.json';
    
    // MIGRATION CANDIDATES
    const OLD_DB_KEYS = ['benai_data_v3', 'benai_data_v2', 'benai_data_v1', 'benai_treinos'];

    const PILLARS = {
        'Musculação': [
            {t:"1. Dor Boa vs. Dor Ruim", d:"Queimação muscular é sinal verde. Pontada aguda na articulação é SINAL VERMELHO."},
            {t:"2. Não vire um Baiacu", d:"Não prenda o ar ficando roxo! Solte o ar (assopre a vela) quando fizer a força."},
            {t:"3. Postura de Super-herói", d:"Estufe o peito e trave o abdômen. Essa armadura protege sua coluna."},
            {t:"4. Quem manda é você", d:"Não deixe o peso despencar. Desça em câmera lenta (3 seg) e suba com explosão."},
            {t:"5. O Descanso é Sagrado", d:"Respeite o timer. Menos descanso atrapalha a força, mais descanso esfria o corpo."},
            {t:"6. Intensidade de Verdade", d:"Se terminou a série mexendo no celular, estava leve. O treino bom é aquele que a gente faz careta."}
        ],
        'Calistenia': [
            {t:"1. Dor vs. Desconforto", d:"O corpo vai tremer, é normal. Mas fisgada no ombro ou cotovelo não é."},
            {t:"2. Corpo de Pedra (Tensão)", d:"Contraia tudo! Bumbum duro, ponta de pé esticada, barriga travada. Gera leveza."},
            {t:"3. Amplitude é Rei", d:"Estique o braço todo! Encoste o peito no chão! Meia repetição dá meio resultado."},
            {t:"4. Ombros Longe da Orelha", d:"Não deixe os ombros subirem. Empurre o chão com vontade e mantenha as costas firmes."},
            {t:"5. Controle a Negativa", d:"A gravidade não pode te vencer. Segure a volta do movimento."},
            {t:"6. Qualidade > Quantidade", d:"5 barras perfeitas valem mais que 20 barras 'minhoquinha'. Forma perfeita sempre."}
        ]
    };

    let appData = { students: [], library: [], lastUpdated: 0 };
    let currentStudent = null;
    let categories = ["Peito", "Costas", "Pernas", "Ombros", "Bíceps", "Tríceps", "Core", "Mobilidade", "Cardio"];
    let collapsedBlocks = {}; // Track UI state locally

    // --- INITIALIZATION ---
    window.onload = async function() {
        const shield = document.getElementById('cloud-shield');
        const hasToken = localStorage.getItem(TOKEN_KEY);
        let loadedFromCloud = false;

        // Init UI
        const catSel = document.getElementById('libCat');
        const exCat = document.getElementById('exCat');
        catSel.innerHTML = '<option value="">Todas</option>';
        exCat.innerHTML = '';
        categories.forEach(c => {
            catSel.add(new Option(c, c));
            exCat.add(new Option(c, c));
        });

        if (hasToken) {
            document.getElementById('ghToken').value = hasToken;
            updateSyncUI(true);
            try {
                loadedFromCloud = await forceCloudLoad();
            } catch (e) {
                console.error("Shield Error", e);
            }
        }
        
        if(!loadedFromCloud) {
            loadLocal();
            updateSyncUI(false);
        }

        // Ensure data is robust
        sanitizeData(appData);

        // Fade out shield
        shield.style.opacity = '0';
        setTimeout(() => shield.style.display = 'none', 500);

        if (loadedFromCloud) showToast('Nuvem Sincronizada (Dados Mestre)');
        else if (hasToken) showToast('Offline (Usando cache local)');

        renderLib();
        renderStudents();

        if (appData.students.length > 0) loadStudent(appData.students[0].id);
        else createStudent();
    };

    function updateSyncUI(online) {
        document.getElementById('stText').innerText = online ? "Online" : "Offline";
        document.getElementById('stDot').className = online ? "dot ok" : "dot err";
    }

    // --- DATA HANDLING (MIGRATION & SYNC) ---

    function sanitizeData(data) {
        if(!data.students) data.students = [];
        if(!data.library) data.library = [];
        if(data.library.length === 0) initLibrary(data);
        
        // Ensure student fields
        data.students.forEach(s => {
            if(!s.blocks) s.blocks = [];
            if(!s.logic) s.logic = [];
        });
        return data;
    }

    function initLibrary(data) {
        data.library = [
            {id:1, name:"Supino Reto", cat:"Peito", type:"Musculação", link:""},
            {id:2, name:"Flexão de Braço", cat:"Peito", type:"Calistenia", link:""},
            {id:3, name:"Agachamento Livre", cat:"Pernas", type:"Musculação", link:""},
            {id:4, name:"Puxada Alta", cat:"Costas", type:"Musculação", link:""},
            {id:5, name:"Burpees", cat:"Cardio", type:"Calistenia", link:""}
        ];
    }

    function loadLocal() {
        // 1. Try Master Key
        const saved = localStorage.getItem(DB_KEY);
        if(saved) {
            try {
                appData = JSON.parse(saved);
                return;
            } catch(e) { console.error("Corrupt Master DB", e); }
        }

        // 2. Try Old Keys (Migration)
        for(const key of OLD_DB_KEYS) {
            const oldData = localStorage.getItem(key);
            if(oldData) {
                try {
                    console.log(`Migrating from ${key}...`);
                    const parsed = JSON.parse(oldData);
                    appData = sanitizeData(parsed);
                    appData.lastUpdated = Date.now();
                    localStorage.setItem(DB_KEY, JSON.stringify(appData)); // Save to Master
                    showToast("Dados antigos recuperados localmente!");
                    return;
                } catch(e) { console.error(`Failed to migrate ${key}`, e); }
            }
        }
    }

    async function forceCloudLoad() {
        const token = localStorage.getItem(TOKEN_KEY);
        if (!token) return false;
        
        const headers = { 'Authorization': `token ${token}` };
        try {
            const res = await fetch('https://api.github.com/gists', { headers });
            if (!res.ok) return false;
            
            const gists = await res.json();
            const found = gists.find(g => g.description === GIST_DESC);
            
            if (found) {
                appData.gistId = found.id;
                const r = await fetch(found.url, { headers });
                const data = await r.json();
                
                if (data.files[GIST_FILENAME]) {
                    const cloudData = JSON.parse(data.files[GIST_FILENAME].content);
                    appData = sanitizeData(cloudData);
                    localStorage.setItem(DB_KEY, JSON.stringify(appData));
                    return true;
                }
            }
        } catch (e) { console.error("Cloud Error", e); return false; }
        return false;
    }

    async function syncData(silent = false) {
        const token = localStorage.getItem(TOKEN_KEY);
        if(!token) return;
        
        // Save Local First
        localStorage.setItem(DB_KEY, JSON.stringify(appData));

        const headers = { 'Authorization': `token ${token}` };
        try {
            if(!silent) showToast('Salvando na Nuvem...');
            
            if(!appData.gistId) {
                // Check if Gist exists (if we lost ID but have token)
                const res = await fetch('https://api.github.com/gists', { headers });
                const gists = await res.json();
                const found = gists.find(g => g.description === GIST_DESC);
                if(found) appData.gistId = found.id;
            }

            // Create payload
            const filesPayload = {};
            filesPayload[GIST_FILENAME] = { content: JSON.stringify(appData) };
            
            const body = JSON.stringify({
                description: GIST_DESC,
                public: false,
                files: filesPayload
            });

            // POST (New) or PATCH (Update)
            let url = 'https://api.github.com/gists';
            let method = 'POST';
            if(appData.gistId) {
                url += `/${appData.gistId}`;
                method = 'PATCH';
            }

            const r = await fetch(url, { method, headers, body });
            if(r.ok) {
                const json = await r.json();
                appData.gistId = json.id;
                localStorage.setItem(DB_KEY, JSON.stringify(appData)); // Update local with Gist ID
                if(!silent) showToast('Dados Salvos na Nuvem!');
            }
        } catch(e) {
            console.error(e);
            if(!silent) alert("Erro de sincronização.");
        }
    }

    function saveData() {
        appData.lastUpdated = Date.now();
        localStorage.setItem(DB_KEY, JSON.stringify(appData));
        syncData(true); // Background sync
    }

    // --- CORE APP LOGIC ---

    function createStudent() {
        const id = Date.now().toString();
        const today = new Date().toISOString().split('T')[0];
        const nextMonth = new Date(); nextMonth.setDate(nextMonth.getDate() + 30);
        
        const newS = {
            id: id,
            name: "Novo Aluno",
            focus: "",
            methodology: "Musculação",
            start: today,
            end: nextMonth.toISOString().split('T')[0],
            logic: ["Foco na execução perfeita.", "Respeite o tempo de descanso."],
            blocks: [{ id: Date.now(), name: "Bloco Principal", details: "", type: "Normal", items: [] }],
            cloudId: null
        };

        appData.students.unshift(newS);
        saveData();
        renderStudents();
        loadStudent(id);
        
        document.getElementById('sName').value = "";
        document.getElementById('sName').focus();
    }

    function loadStudent(id) {
        currentStudent = appData.students.find(s => s.id === id);
        if (!currentStudent) return;

        document.getElementById('sName').value = currentStudent.name;
        document.getElementById('sFocus').value = currentStudent.focus || "";
        document.getElementById('sMethod').value = currentStudent.methodology || "Musculação";
        document.getElementById('dStart').value = currentStudent.start;
        document.getElementById('dEnd').value = currentStudent.end;
        
        collapsedBlocks = {}; // Reset collapsed state
        updateDatesDisplay();
        renderLogicList();
        renderBlocks();
        
        document.querySelectorAll('.student-item').forEach(el => el.classList.remove('active'));
        const activeItem = document.getElementById(`st-${id}`);
        if(activeItem) activeItem.classList.add('active');
    }

    function updateCurrent() {
        if (!currentStudent) return;
        currentStudent.name = document.getElementById('sName').value || "Novo Aluno";
        currentStudent.focus = document.getElementById('sFocus').value;
        currentStudent.methodology = document.getElementById('sMethod').value;
        currentStudent.start = document.getElementById('dStart').value;
        currentStudent.end = document.getElementById('dEnd').value;
        
        saveData();
        const stEl = document.querySelector(`#st-${currentStudent.id} .st-name`);
        if(stEl) stEl.innerText = currentStudent.name;
        updateDatesDisplay();
        renderStudents(document.querySelector('.search-inp').value || "");
    }

    function updateDatesDisplay() {
        const s = document.getElementById('dStart').value.split('-');
        const e = document.getElementById('dEnd').value.split('-');
        document.getElementById('lblStart').innerText = `${s[2]}/${s[1]}`;
        document.getElementById('lblEnd').innerText = `${e[2]}/${e[1]}`;
    }

    // --- RENDERERS ---

    function renderStudents(filter = "") {
        const list = document.getElementById('studentList');
        list.innerHTML = "";
        
        appData.students.filter(s => s.name.toLowerCase().includes(filter.toLowerCase())).forEach(s => {
            const div = document.createElement('div');
            div.className = "student-item";
            div.id = `st-${s.id}`;
            div.onclick = () => loadStudent(s.id);
            
            let pct = 0;
            let color = 'var(--success)';
            if(s.start && s.end) {
                const total = new Date(s.end) - new Date(s.start);
                const elapsed = new Date() - new Date(s.start);
                pct = Math.min(100, Math.max(0, (elapsed/total)*100));
                if(pct > 75) color = 'var(--danger)'; else if (pct > 50) color = 'var(--warning)';
            }

            div.innerHTML = `
                <span class="st-name">${s.name}</span>
                <div class="st-info">
                    <span>${formatDate(s.end)}</span>
                    <i class="fas fa-trash" style="color:#cbd5e1;" onclick="deleteStudent(event, '${s.id}')"></i>
                </div>
                <div class="st-bar-bg"><div class="st-bar-fill" style="width:${pct}%; background:${color}"></div></div>
            `;
            list.appendChild(div);
        });
        
        if (currentStudent) {
            const activeItem = document.getElementById(`st-${currentStudent.id}`);
            if(activeItem) activeItem.classList.add('active');
        }
    }

    function renderLogicList() {
        const div = document.getElementById('logicList');
        div.innerHTML = "";
        (currentStudent.logic || []).forEach((t, i) => {
            div.innerHTML += `
            <div class="logic-item">
                <input class="logic-inp" value="${t}" onchange="updateLogic(${i}, this.value)">
                <i class="fas fa-trash" style="color:var(--danger); cursor:pointer; padding:5px;" onclick="delLogic(${i})"></i>
            </div>`;
        });
    }

    function renderBlocks() {
        const container = document.getElementById('workoutBlocks');
        container.innerHTML = "";
        
        if (!currentStudent || !currentStudent.blocks) return;

        currentStudent.blocks.forEach((block, bIdx) => {
            if(!block.id) block.id = Date.now() + bIdx; // Ensure ID
            const isCollapsed = collapsedBlocks[block.id];
            
            const bDiv = document.createElement('div');
            let cls = "block-container";
            if (isCollapsed) cls += " collapsed";
            if (block.type === 'BiSet') cls += " biset-cont";
            if (block.type === 'TriSet') cls += " triset-cont";
            bDiv.className = cls;

            let itemsHTML = "";
            block.items.forEach((item, iIdx) => {
                let methodClass = "";
                if(item.method === 'Drop') methodClass = 'm-Drop';
                if(item.method === 'RNP') methodClass = 'm-RNP';
                if(item.method === 'Iso') methodClass = 'm-Iso';
                if(item.method === 'Pyr') methodClass = 'm-Pyr';

                const linkIcon = item.link ? `<i class="fas fa-play-circle" title="Tem vídeo"></i>` : '';

                itemsHTML += `
                <div class="ex-row ${methodClass}">
                    <span class="ex-name">${item.name} ${linkIcon}</span>
                    
                    <div class="pills">
                        <div class="pill-wrap"><span class="pill-lbl">Sets</span><input class="pill-inp" value="${item.sets}" onchange="updateItem(${bIdx}, ${iIdx}, 'sets', this.value)"></div>
                        <div class="pill-wrap"><span class="pill-lbl">Reps</span><input class="pill-inp" value="${item.reps}" onchange="updateItem(${bIdx}, ${iIdx}, 'reps', this.value)"></div>
                        <div class="pill-wrap"><span class="pill-lbl">Desc</span><input class="pill-inp" value="${item.rest}" onchange="updateItem(${bIdx}, ${iIdx}, 'rest', this.value)"></div>
                        <div class="pill-wrap">
                            <span class="pill-lbl">Método</span>
                            <select class="pill-inp" style="width:70px;" onchange="updateItem(${bIdx}, ${iIdx}, 'method', this.value)">
                                <option value="Normal" ${item.method==='Normal'?'selected':''}>Normal</option>
                                <option value="Drop" ${item.method==='Drop'?'selected':''}>Drop</option>
                                <option value="RNP" ${item.method==='RNP'?'selected':''}>RNP</option>
                                <option value="Iso" ${item.method==='Iso'?'selected':''}>Iso</option>
                                <option value="Pyr" ${item.method==='Pyr'?'selected':''}>Pyr</option>
                            </select>
                        </div>
                    </div>
                    <input class="obs-inp" value="${item.obs||''}" placeholder="Obs..." onchange="updateItem(${bIdx}, ${iIdx}, 'obs', this.value)">
                    <div class="row-actions">
                        <div class="icon-btn" onclick="openExModal(${bIdx}, ${iIdx})"><i class="fas fa-pencil"></i></div>
                        <div class="icon-btn" onclick="moveItem(${bIdx}, ${iIdx}, -1)"><i class="fas fa-arrow-up"></i></div>
                        <div class="icon-btn" onclick="moveItem(${bIdx}, ${iIdx}, 1)"><i class="fas fa-arrow-down"></i></div>
                        <div class="icon-btn del" onclick="deleteItem(${bIdx}, ${iIdx})"><i class="fas fa-trash"></i></div>
                    </div>
                </div>`;
            });

            bDiv.innerHTML = `
                <div class="block-head">
                    <div class="block-head-top">
                        <input class="w-title" value="${block.name}" onchange="updateBlockName(${bIdx}, this.value)">
                        <div style="display:flex; gap:5px;">
                            <i class="fas fa-eye" style="color:var(--accent); cursor:pointer; padding:5px;" onclick="toggleBlock('${block.id}')" title="Minimizar"></i>
                            <i class="fas fa-trash" style="color:var(--danger); cursor:pointer; padding:5px;" onclick="deleteBlock(${bIdx})"></i>
                        </div>
                    </div>
                    <input class="w-details" value="${block.details || ''}" placeholder="Detalhes do bloco (opcional)" onchange="updateBlockDetails(${bIdx}, this.value)">
                </div>
                <div class="block-body-content">${itemsHTML}</div>
            `;
            container.appendChild(bDiv);
        });
    }

    function toggleBlock(id) {
        collapsedBlocks[id] = !collapsedBlocks[id];
        renderBlocks();
    }

    function renderLib() {
        const list = document.getElementById('libList');
        const term = document.getElementById('libSearch').value.toLowerCase();
        const cat = document.getElementById('libCat').value;
        list.innerHTML = "";
        
        appData.library.filter(x => 
            x.name.toLowerCase().includes(term) && 
            (cat === "" || x.cat === cat)
        ).forEach(x => {
            const div = document.createElement('div');
            div.className = "item-card";
            div.innerHTML = `
            <div style="flex:1" onclick="addItem(${x.id})">
                <span>${x.name}</span>
            </div>
            <div class="item-actions">
                <i class="fas fa-pencil" style="color:#cbd5e1; font-size:0.7rem; cursor:pointer;" onclick="editLibItem(${x.id})"></i>
                <i class="fas fa-plus-circle" style="color:var(--success); font-size:1rem; cursor:pointer;" onclick="addItem(${x.id})"></i>
            </div>`;
            list.appendChild(div);
        });
    }

    // --- ACTIONS ---

    function addItem(libId) {
        const ex = appData.library.find(x => x.id === libId);
        if (!ex) return;
        
        if (!currentStudent) { createStudent(); }
        let block = currentStudent.blocks[currentStudent.blocks.length - 1];
        if (!block) { addBlock('Normal'); block = currentStudent.blocks[0]; }

        block.items.push({
            name: ex.name,
            link: ex.link || '',
            sets: '3',
            reps: '12',
            rest: '60s',
            obs: '',
            method: 'Normal'
        });
        
        saveData();
        renderBlocks();
        // Expand if added to a collapsed block
        if(collapsedBlocks[block.id]) { collapsedBlocks[block.id] = false; renderBlocks(); }
        
        setTimeout(() => {
            const c = document.querySelector('.ph-body');
            c.scrollTop = c.scrollHeight;
        }, 50);
    }

    function addBlock(type) {
        if (!currentStudent) return;
        let name = "Bloco " + (currentStudent.blocks.length + 1);
        if(type === 'BiSet') name = "Bi-Set";
        if(type === 'TriSet') name = "Tri-Set";
        currentStudent.blocks.push({ id: Date.now(), name: name, details: "", type: type, items: [] });
        saveData();
        renderBlocks();
        setTimeout(() => {
            const c = document.querySelector('.ph-body');
            c.scrollTop = c.scrollHeight;
        }, 50);
    }

    function updateItem(bIdx, iIdx, field, val) {
        currentStudent.blocks[bIdx].items[iIdx][field] = val;
        saveData();
        if(field === 'method') renderBlocks(); // Re-render for color change
    }

    function updateBlockName(bIdx, val) { currentStudent.blocks[bIdx].name = val; saveData(); }
    function updateBlockDetails(bIdx, val) { currentStudent.blocks[bIdx].details = val; saveData(); }
    
    function moveItem(bIdx, iIdx, dir) {
        const items = currentStudent.blocks[bIdx].items;
        if (iIdx + dir < 0 || iIdx + dir >= items.length) return;
        const temp = items[iIdx]; items[iIdx] = items[iIdx + dir]; items[iIdx + dir] = temp;
        saveData(); renderBlocks();
    }
    function deleteItem(bIdx, iIdx) { currentStudent.blocks[bIdx].items.splice(iIdx, 1); saveData(); renderBlocks(); }
    function deleteBlock(bIdx) { if(confirm("Apagar bloco?")) { currentStudent.blocks.splice(bIdx, 1); saveData(); renderBlocks(); } }
    
    function deleteStudent(e, id) {
        e.stopPropagation();
        if(confirm("Apagar aluno?")) {
            appData.students = appData.students.filter(s => s.id !== id);
            if (currentStudent && currentStudent.id === id) currentStudent = appData.students.length > 0 ? appData.students[0] : null;
            saveData();
            renderStudents();
            if(currentStudent) loadStudent(currentStudent.id); else document.getElementById('workoutBlocks').innerHTML = "";
        }
    }

    function addLogic() { if(!currentStudent.logic) currentStudent.logic=[]; currentStudent.logic.push(""); saveData(); renderLogicList(); }
    function updateLogic(i, v) { currentStudent.logic[i] = v; saveData(); }
    function delLogic(i) { currentStudent.logic.splice(i, 1); saveData(); renderLogicList(); }

    function applyPreset(s,r,t) {
        if(!currentStudent) return;
        // Apply to last added exercise
        let found = false;
        for(let b=currentStudent.blocks.length-1; b>=0; b--) {
            if(currentStudent.blocks[b].items.length > 0) {
                const lastItem = currentStudent.blocks[b].items[currentStudent.blocks[b].items.length-1];
                lastItem.sets = s; lastItem.reps = r; lastItem.rest = t;
                found = true;
                break;
            }
        }
        if(found) { saveData(); renderBlocks(); showToast(`Preset Aplicado: ${s}x${r}`); }
        else showToast("Adicione um exercício primeiro.");
    }

    // --- MODAL EXERCISE (EDIT/ADD) ---
    function openExModal(bIdx, iIdx) {
        document.getElementById('modal-ex').style.display = 'flex';
        const isEditWorkoutItem = (bIdx !== null && iIdx !== null);
        document.getElementById('libOptions').style.display = isEditWorkoutItem ? 'none' : 'block';
        
        // Reset hidden fields
        document.getElementById('exEditBlockIdx').value = "";
        document.getElementById('exEditItemIdx').value = "";
        document.getElementById('exEditLibId').value = "";

        if(isEditWorkoutItem) {
            document.getElementById('modalExTitle').innerText = "Editar Item do Treino";
            const item = currentStudent.blocks[bIdx].items[iIdx];
            document.getElementById('exName').value = item.name;
            document.getElementById('exLink').value = item.link || '';
            document.getElementById('exEditBlockIdx').value = bIdx;
            document.getElementById('exEditItemIdx').value = iIdx;
        } else {
            // Adding new to Library
            document.getElementById('modalExTitle').innerText = "Adicionar à Biblioteca";
            document.getElementById('exName').value = '';
            document.getElementById('exLink').value = '';
        }
    }

    function editLibItem(id) {
        const item = appData.library.find(x => x.id === id);
        if(!item) return;
        document.getElementById('modal-ex').style.display = 'flex';
        document.getElementById('libOptions').style.display = 'block';
        document.getElementById('modalExTitle').innerText = "Editar na Biblioteca";
        
        document.getElementById('exName').value = item.name;
        document.getElementById('exLink').value = item.link || '';
        document.getElementById('exCat').value = item.cat;
        document.getElementById('exType').value = item.type || 'Musculação';
        document.getElementById('exEditLibId').value = id;
    }

    function closeExModal() { document.getElementById('modal-ex').style.display = 'none'; }

    function confirmExSave() {
        const name = document.getElementById('exName').value;
        const link = document.getElementById('exLink').value;
        const bIdx = document.getElementById('exEditBlockIdx').value;
        const iIdx = document.getElementById('exEditItemIdx').value;
        const libId = document.getElementById('exEditLibId').value;

        if(!name) return alert("Nome obrigatório");

        if(bIdx !== "") {
            // Editing existing item in workout
            currentStudent.blocks[bIdx].items[iIdx].name = name;
            currentStudent.blocks[bIdx].items[iIdx].link = link;
            saveData();
            renderBlocks();
        } else if (libId !== "") {
            // Editing Library Item
            const idx = appData.library.findIndex(x => x.id == libId);
            if(idx > -1) {
                appData.library[idx].name = name;
                appData.library[idx].link = link;
                appData.library[idx].cat = document.getElementById('exCat').value;
                appData.library[idx].type = document.getElementById('exType').value;
                saveData();
                renderLib();
            }
        } else {
            // Adding new to Library
            const cat = document.getElementById('exCat').value;
            const type = document.getElementById('exType').value;
            appData.library.push({id: Date.now(), name, cat, type, link});
            saveData();
            renderLib();
        }
        closeExModal();
    }

    // --- CLOUD/BACKUP ---
    function saveToken() { const t = document.getElementById('ghToken').value.trim(); if(t) { localStorage.setItem(TOKEN_KEY, t); updateSyncUI(true); showToast('Token Salvo! Sincronizando...'); syncData(true); } }
    function backupData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(appData,null,2)],{type:"application/json"})); a.download=`manager_backup_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); showToast('Backup baixado!'); }
    function restoreData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(confirm("Substituir dados atuais?")) {
                    appData = sanitizeData(json);
                    saveData(); // Will sync to cloud
                    showToast('Restaurado!');
                    setTimeout(() => location.reload(), 1000);
                }
            } catch(err) { alert("Erro JSON."); }
        };
        reader.readAsText(file);
    }

    // --- PDF & LINK ---

    async function generateLink(mode) {
        if(!currentStudent) return alert("Nenhum aluno selecionado.");
        const token = localStorage.getItem(TOKEN_KEY);
        if(!token) return alert("Salve o Token do GitHub.");

        // NOTE: This creates/updates a SEPARATE file for the student (treino.json)
        // It does NOT affect the Manager DB file.
        const payload = {
            name: currentStudent.name,
            focus: currentStudent.focus,
            methodology: currentStudent.methodology,
            startDate: currentStudent.start,
            expiryDate: currentStudent.end,
            logic: currentStudent.logic.join('\n'), // Legacy compatibility
            blocks: currentStudent.blocks
        };

        showToast("Salvando...");
        try {
            let url = 'https://api.github.com/gists';
            let method = 'POST';
            if (mode === 'update' && currentStudent.cloudId) { url += '/' + currentStudent.cloudId; method = 'PATCH'; }

            const res = await fetch(url, { method: method, headers: {'Authorization': `token ${token}`, 'Content-Type': 'application/json'}, body: JSON.stringify({description: `Treino: ${currentStudent.name}`, public: false, files: {"treino.json": { content: JSON.stringify(payload) }}}) });
            if (!res.ok) throw new Error("Erro na API");
            const json = await res.json();
            currentStudent.cloudId = json.id;
            saveData(); // Save the new cloudId to manager DB

            if (mode === 'new') {
                const link = `${window.location.origin}${window.location.pathname.replace('gerador.html','aluno.html')}?id=${json.id}`;
                navigator.clipboard.writeText(link);
                alert("Link criado e copiado!");
                window.open(`https://tinyurl.com/create.php?url=${encodeURIComponent(link)}`, '_blank');
            } else { alert("Atualizado!"); }
        } catch (e) { alert("Erro ao conectar."); }
    }

    function generateOffline() {
        if(!currentStudent) return;
        const payload = { name: currentStudent.name, focus: currentStudent.focus, methodology: currentStudent.methodology, startDate: currentStudent.start, expiryDate: currentStudent.end, logic: currentStudent.logic.join('\n'), blocks: currentStudent.blocks };
        const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(payload));
        const link = `${window.location.origin}${window.location.pathname.replace('gerador.html','aluno.html')}?data=${compressed}`;
        navigator.clipboard.writeText(link);
        alert("Link Offline Copiado!");
    }

    function printPDF() {
        if(!currentStudent) return;
        const area = document.getElementById('print-area');
        const logicHTML = (currentStudent.logic||[]).map(l => `<div style="margin-bottom:5px;">• ${l}</div>`).join('');
        const pillars = PILLARS[currentStudent.methodology] || PILLARS['Musculação'];
        const pillarsHTML = pillars.map(p => `
            <div style="background:#f0f9ff; padding:10px; border-radius:8px; margin-bottom:5px; border-left:4px solid #00A8E8; font-size:10px;">
                <div style="font-weight:800; color:#001F5B; margin-bottom:2px;">${p.t}</div>
                <div style="color:#555;">${p.d}</div>
            </div>
        `).join('');

        let blocksHTML = '';
        currentStudent.blocks.forEach(b => {
            let items = b.items.map(i => `
                <div style="display:flex; justify-content:space-between; padding:6px; border-bottom:1px solid #eee; align-items:center;">
                    <div style="width:45%;">
                        <div style="font-weight:bold; color:#1e293b;">${i.name}</div>
                        ${i.link ? `<a href="${i.link}" style="color:#00A8E8; font-size:9px; text-decoration:none;" target="_blank">► VER VÍDEO</a>` : ''}
                    </div>
                    <div style="width:15%; text-align:center;">${i.sets}x ${i.reps}</div>
                    <div style="width:15%; text-align:center;">${i.rest}</div>
                    <div style="width:25%; text-align:right; color:#64748b; font-size:10px;">${i.method} ${i.obs ? `<br><span style="color:#d97706">${i.obs}</span>` : ''}</div>
                </div>
            `).join('');
            
            blocksHTML += `
            <div style="margin-bottom:20px; break-inside:avoid; border:1px solid #eee; border-radius:8px; overflow:hidden;">
                <div style="background:#001F5B; color:white; padding:8px 15px; font-weight:bold; font-size:12px; display:flex; justify-content:space-between;">
                    <span>${b.name}</span>
                    <span style="opacity:0.8; font-size:10px;">${b.type}</span>
                </div>
                ${b.details ? `<div style="background:#f8fafc; color:#64748b; padding:5px 15px; font-size:10px; border-bottom:1px solid #eee; font-style:italic;">${b.details}</div>` : ''}
                <div style="padding:10px; background:#f9fafb; font-size:9px; font-weight:800; color:#94a3b8; text-transform:uppercase; display:flex; justify-content:space-between;">
                    <div style="width:45%">Exercício</div>
                    <div style="width:15%; text-align:center;">Séries/Reps</div>
                    <div style="width:15%; text-align:center;">Intervalo</div>
                    <div style="width:25%; text-align:right;">Obs/Método</div>
                </div>
                <div style="padding:0 10px 10px;">${items}</div>
            </div>`;
        });

        area.innerHTML = `
            <div style="font-family:sans-serif; padding:20px; color:#1e293b;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #001F5B; padding-bottom:15px; margin-bottom:20px;">
                    <div>
                        <h1 style="color:#001F5B; margin:0; font-size:24px; line-height:1;">BENAI BERNARDO</h1>
                        <div style="color:#00A8E8; font-weight:bold; letter-spacing:2px; font-size:10px; margin-top:5px;">CONSULTORIA DE TREINAMENTO</div>
                        <a href="https://wa.me/5541997222664" target="_blank" style="display:inline-block; margin-top:10px; background:#25D366; color:white; padding:5px 10px; border-radius:4px; text-decoration:none; font-size:10px; font-weight:bold;">WHATSAPP: (41) 99722-2664</a>
                    </div>
                    <div style="text-align:right; font-size:10px;">
                        <div>ALUNO: <b>${currentStudent.name}</b></div>
                        <div>OBJETIVO: ${currentStudent.focus}</div>
                        <div>VALIDADE: ${formatDate(currentStudent.end)}</div>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <h3 style="background:#001F5B; color:white; padding:5px 10px; font-size:12px; border-radius:4px; margin-top:0;">LÓGICA DO TREINO</h3>
                        <div style="font-size:11px;">${logicHTML}</div>
                    </div>
                    <div>
                        <h3 style="background:#00A8E8; color:white; padding:5px 10px; font-size:12px; border-radius:4px; margin-top:0;">PILARES DO TREINAMENTO</h3>
                        ${pillarsHTML}
                    </div>
                </div>
                
                ${blocksHTML}
            </div>
        `;
        area.style.display = 'block';
        html2pdf(area, { margin: 5, filename: `Treino_${currentStudent.name}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).then(() => area.style.display = 'none');
    }

    function formatDate(iso) { if(!iso) return '--'; const p = iso.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
</script>
</body>
</html>
