<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benai Generator | Consultoria</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #001F5B; --accent: #00A8E8; --bg: #f0f2f5;
            --surface: #ffffff; --border: #e2e8f0; --text: #1f2937;
            --success: #10b981; --danger: #ef4444; 
            
            --c-drop: #ef4444; --c-rnp: #f59e0b; --c-iso: #06b6d4; 
            --c-pyr: #8b5cf6; --c-fst: #ec4899; --c-bi: #00A8E8; --c-tri: #6366f1;
            
            --font-ui: 'Plus Jakarta Sans', sans-serif; --font-num: 'Outfit', sans-serif;
        }
        
        * { box-sizing: border-box; outline: none; font-family: var(--font-ui); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        body { margin: 0; height: 100vh; display: grid; grid-template-columns: 280px 1fr 320px; overflow: hidden; background: var(--bg); color: var(--text); font-size: 13px; }

        /* SIDEBAR ESQUERDA */
        .sidebar { background: var(--surface); display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); border-left: 1px solid var(--border); z-index: 10; height: 100vh; overflow: hidden; }
        .brand-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .brand { color: var(--primary); font-family: var(--font-num); font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; text-transform:uppercase; letter-spacing:0.5px;}
        
        .cloud-pill { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 20px; cursor: pointer; font-size: 0.75rem; font-weight: 700; color: #64748b; transition: 0.2s; }
        .cloud-pill:hover { background: #e2e8f0; color: var(--primary); }
        .cloud-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .cloud-dot.ok { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .cloud-dot.sync { background: var(--accent); animation: pulse 1s infinite; }
        .cloud-dot.error { background: var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .list-header { font-weight: 800; color: var(--text); font-size: 0.75rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
        .list-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-right: 5px; padding-bottom: 20px; }
        
        .item-card { padding: 10px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; transition: 0.1s; }
        .item-card:hover { background: white; border-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateX(2px); }
        
        .student-item { padding: 12px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; background: white; border-bottom: 1px solid var(--border); position: relative; transition:0.2s; }
        .student-item:hover { background: #f0f9ff; }
        .student-item.active { background: #eff6ff; border-color: var(--accent); box-shadow: 0 2px 8px rgba(0, 168, 232, 0.15); }
        .st-name { font-weight: 700; color: var(--primary); font-size: 0.9rem; display: block; }
        .st-focus { font-size: 0.75rem; color: #64748b; }
        .st-del { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #cbd5e1; cursor: pointer; padding: 6px; z-index: 5; }
        .st-del:hover { color: var(--danger); background: #fee2e2; border-radius: 6px; }

        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85rem; transition: 0.2s; }
        .btn-pri { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,31,91,0.2); }
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }

        /* EDITOR CENTRAL */
        .col-center { display: flex; flex-direction: column; background: #e2e8f0; height: 100vh; overflow: hidden; }
        .toolbar { background: var(--surface); padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; overflow-x: auto; white-space: nowrap; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .toolbar-label { font-weight: 800; color: var(--primary); font-size: 0.7rem; margin-right: 5px; }
        .chip { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border: 1px solid var(--border); background: white; color: #64748b; transition: 0.2s; display: flex; flex-direction: column; align-items: center; line-height: 1.1; min-width: 70px; }
        .chip:hover { border-color: var(--accent); background: var(--accent); color: white; transform: translateY(-1px); }

        .canvas { flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; align-items: flex-start; scroll-behavior: smooth; }
        .phone { width: 100%; max-width: 480px; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-height: 800px; border: 1px solid #cbd5e1; overflow: hidden; margin-bottom: 50px; }
        
        .ph-header { background: var(--primary); padding: 25px 20px; color: white; }
        .ph-inp { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 12px; border-radius: 8px; width: 100%; margin-bottom: 8px; font-weight: 600; font-family: var(--font-ui); font-size: 0.95rem; transition: 0.2s; }
        .ph-inp::placeholder { color: rgba(255,255,255,0.6); }
        .ph-inp:focus { background: rgba(255,255,255,0.25); border-color: white; outline: none; }
        
        .ph-body { padding: 15px; background: #f8fafc; flex: 1; display: flex; flex-direction: column; gap: 15px; }

        .normal-wrap { background: transparent; border: none; margin-bottom: 15px; transition: 0.2s; }
        .normal-wrap .block-head { background: transparent; padding: 0 0 5px 5px; border-bottom: 1px solid #e2e8f0; margin-bottom: 10px; }
        .w-title { background: transparent; border: none; font-weight: 800; font-family:var(--font-num); color: var(--primary); font-size: 0.85rem; text-transform: uppercase; width: 100%; }

        .biset-cont { border: 2px dashed var(--c-bi); background: #f0f9ff; border-radius: 16px; margin-bottom: 15px; overflow:hidden; transition: 0.2s; }
        .biset-cont .block-head { background: #e0f2fe; padding: 8px 12px; border-bottom:1px solid rgba(0,0,0,0.05); }
        .biset-cont .block-body { padding: 10px; }

        .triset-cont { border: 2px dashed var(--c-tri); background: #fdf4ff; border-radius: 16px; margin-bottom: 15px; overflow:hidden; transition: 0.2s; }
        .triset-cont .block-head { background: #f3e8ff; padding: 8px 12px; border-bottom:1px solid rgba(0,0,0,0.05); }
        .triset-cont .block-body { padding: 10px; }

        .active-block { border: 2px solid var(--primary) !important; box-shadow: 0 0 0 4px rgba(0, 31, 91, 0.1); }
        .block-head { display: flex; justify-content: space-between; align-items: center; gap:10px; }
        .blk-actions { display:flex; gap:5px; }
        .blk-btn { width:24px; height:24px; border-radius:4px; background:rgba(255,255,255,0.5); display:flex; align-items:center; justify-content:center; cursor:pointer; color:#64748b; font-size:0.7rem; }
        .blk-btn:hover { background:white; color:var(--primary); }

        .ex-row { padding: 12px; border: 1px solid #e2e8f0; background: white; border-radius: 12px; position: relative; margin-bottom: 10px; border-left-width: 4px; border-left-color: #cbd5e1; cursor: pointer; transition: 0.2s; }
        .ex-row.selected { border: 2px solid var(--accent); background: #f0f9ff; }
        .ex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .ex-name { font-weight: 700; font-size: 1rem; color: #1e293b; font-family: var(--font-num); }
        
        .method-tabs { display: flex; gap: 4px; margin-bottom: 10px; background: #f1f5f9; padding: 3px; border-radius: 8px; overflow-x: auto; }
        .m-tab { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; border: none; background: transparent; color: #64748b; cursor: pointer; white-space: nowrap; transition: 0.1s; }
        .m-tab:hover { background: rgba(255,255,255,0.5); }
        .m-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .pills-edit { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px; align-items: flex-end; }
        .pill-group { display: flex; flex-direction: column; align-items: flex-start; }
        .pill-lbl { font-size: 0.6rem; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px; }
        .pill-inp { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 6px; font-size: 0.85rem; font-weight: 700; color: var(--primary); width: 60px; text-align: center; font-family: var(--font-num); }
        .obs-inp { width: 100%; border: none; background: #fffbeb; padding: 8px; font-size: 0.8rem; color: #b45309; border-radius: 6px; }

        .row-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 5px; }
        .act-btn { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #cbd5e1; transition: 0.2s; }
        .act-btn:hover { background: #f1f5f9; color: var(--danger); }

        /* SIDEBAR DIREITA */
        .logic-list { display: flex; flex-direction: column; gap: 8px; }
        .logic-item { display: flex; gap: 5px; }
        .logic-inp { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; font-family:var(--font-ui); background: white; }
        .logic-del { color: var(--danger); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; width: 30px; }
        .search-inp { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; margin-bottom: 10px; }
        .cat-select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.85rem; margin-bottom: 10px; background: white; }
        .cat-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:5px; }

        .multi-btn-area { display: flex; flex-direction: column; gap: 10px; margin-top: auto; padding-top: 15px; border-top: 1px solid var(--border); }
        .btn-cloud-new { width: 100%; height: 45px; background: var(--accent); color: white; border-radius: 10px; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-cloud-upd { width: 100%; height: 45px; background: var(--success); color: white; border-radius: 10px; font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-offline { width: 100%; height: 40px; background: white; color: #64748b; border: 1px dashed #cbd5e1; border-radius: 10px; font-weight: 700; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }

        /* MODAIS */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
        .modal-box { background:white; width:90%; max-width:400px; padding:25px; border-radius:20px; box-shadow:0 20px 50px rgba(0,0,0,0.2); }
        .modal-h { font-size: 1.2rem; font-weight: 800; color: var(--primary); margin-bottom: 15px; font-family: var(--font-num); }
        .sync-btn { width: 100%; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; cursor: pointer; text-align: left; transition: 0.2s; }
        .sync-btn:hover { border-color: var(--accent); background: #f0f9ff; }
    </style>
</head>
<body>

<script>
    (function() {
        if (sessionStorage.getItem("benai_access_granted") === "true") return;
        document.write(`
            <style>body{visibility:hidden;overflow:hidden}#gatekeeper{visibility:visible;position:fixed;inset:0;background:#0f172a;color:white;z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Outfit',sans-serif}.pin-box{text-align:center;width:90%;max-width:350px}.pin-inp{padding:15px;font-size:1.5rem;text-align:center;border-radius:12px;border:1px solid #1e293b;outline:none;margin-top:25px;background:rgba(255,255,255,0.05);color:white;letter-spacing:4px;width:100%}.pin-inp:focus{border-color:#38bdf8;box-shadow:0 0 0 4px rgba(56,189,248,0.1)}</style>
            <div id="gatekeeper"><div class="pin-box"><i class="fa-solid fa-shield-halved" style="font-size:3rem;color:#38bdf8;margin-bottom:15px"></i><h2 style="font-size:1.5rem">Sistema Protegido</h2><p style="opacity:0.6;font-size:0.9rem">Insira o c칩digo de 8 d칤gitos</p><input type="password" class="pin-inp" maxlength="8" placeholder="********" inputmode="numeric" onkeyup="if(this.value==='16359001'){sessionStorage.setItem('benai_access_granted','true');location.reload()}"></div></div>
        `);
    })();
</script>

<div class="sidebar col-left">
    <div class="brand-area">
        <div class="brand"><i class="fas fa-bolt"></i> BENAI GENERATOR</div>
        <div class="cloud-pill" onclick="openModal('sync')">
            <i class="fa-solid fa-cloud"></i> DADOS
            <div id="cloudIndicator" class="cloud-dot"></div>
        </div>
    </div>
    <button class="btn btn-pri" style="width:100%; margin-bottom:15px;" onclick="createNewWorkout()"><i class="fas fa-user-plus"></i> Novo Aluno</button>
    <input class="search-inp" placeholder="Buscar aluno..." onkeyup="filterStudents(this.value)">
    <div class="list-header">Meus Alunos</div><div class="list-scroll" id="studentList"></div>
</div>

<div class="col-center">
    <div class="toolbar">
        <span class="toolbar-label">APLICAR:</span>
        <div class="chip" onclick="applyPreset('3','15','60s')">Padr칚o 3x15</div>
        <div class="chip" onclick="applyPreset('4','10','60s')">Hipertrofia</div>
        <div class="chip" onclick="applyPreset('3','20','45s')">Metab칩lico</div>
        <div class="chip" onclick="applyPreset('5','5','180s')">For칞a</div>
        <div class="chip" onclick="applyPreset('3','30','30s')">RML</div>
        <div class="chip" onclick="applyPreset('3','Falha','60s')">Falha</div>
    </div>

    <div class="canvas">
        <div class="phone">
            <div class="ph-header">
                <input class="ph-inp" id="sName" placeholder="Nome do Aluno" onchange="saveCurrent()" onclick="event.stopPropagation()" style="font-size:1.2rem; margin-bottom:8px;">
                <input class="ph-inp" id="sFocus" placeholder="Objetivo Principal" style="opacity:0.9; margin:0; font-weight:400;" onchange="saveCurrent()" onclick="event.stopPropagation()">
            </div>

            <div class="ph-body">
                <div id="blocksContainer"></div>
                <div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:10px;">
                    <button class="btn btn-sec" style="flex:1; border-style:dashed;" onclick="addBlock('Normal')">+ Simples</button>
                    <button class="btn btn-sec" style="flex:1; border-style:dashed; color:var(--c-bi); border-color:var(--c-bi);" onclick="addBlock('BiSet')">+ Bi-Set</button>
                    <button class="btn btn-sec" style="flex:1; border-style:dashed; color:var(--c-tri); border-color:var(--c-tri);" onclick="addBlock('TriSet')">+ Tri-Set</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="sidebar col-right">
    <div class="list-header" style="color:var(--primary); display:flex; align-items:center; gap:5px;">
        <i class="fa-solid fa-list-check"></i> L칩gica do Treino
    </div>
    
    <div style="margin-bottom:10px;">
        <div id="logicContainer" class="logic-list"></div>
        <button class="btn btn-sec" style="width:100%; margin-top:10px; padding:8px; font-size:0.8rem; background:white;" onclick="addLogicTopic()">+ Adicionar T칩pico</button>
    </div>

    <div style="width:100%; height:1px; background:var(--border); margin-bottom:20px; margin-top:20px;"></div>

    <div class="list-header">Biblioteca</div>
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input class="search-inp" id="searchLib" placeholder="Buscar..." onkeyup="renderLib()" style="margin:0;">
        <button class="btn btn-pri" style="width:40px;" onclick="openExModal()"><i class="fas fa-plus"></i></button>
    </div>
    
    <div style="display:flex; gap:5px; align-items:center; margin-bottom:10px;">
        <select class="cat-select" id="catFilter" onchange="renderLib()" style="margin:0; width:100%; padding:8px; border-radius:8px; border:1px solid var(--border);"></select>
    </div>

    <div class="list-scroll" id="libList"></div>

    <div class="multi-btn-area">
        <button class="btn-cloud-new" id="btn-cloud-new" onclick="saveToCloud('new')">
            <i class="fas fa-cloud-arrow-up"></i> <span>Salvar + Link Novo</span>
        </button>
        <button class="btn-cloud-upd" id="btn-cloud-upd" onclick="saveToCloud('update')">
            <i class="fas fa-rotate"></i> <span>Apenas Atualizar</span>
        </button>
        <button class="btn-offline" onclick="generateOfflineLink()">
            <i class="fas fa-box-archive"></i> Gerar Link Offline
        </button>
    </div>
</div>

<div id="modal-ex" class="modal">
    <div class="modal-box">
        <div class="modal-h">Exerc칤cio</div>
        <input type="hidden" id="exId">
        <label class="list-header">Nome</label><input class="search-inp" id="exName">
        <label class="list-header">Categoria</label><select class="cat-select" id="exCat" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border);"></select>
        <label class="list-header">Link V칤deo (Opcional)</label><input class="search-inp" id="exLink" placeholder="YouTube URL...">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-sec" style="flex:1" onclick="closeModal('ex')">Cancelar</button>
            <button class="btn btn-pri" style="flex:1" onclick="saveEx()">Salvar</button>
        </div>
    </div>
</div>

<div id="modal-sync" class="modal">
    <div class="modal-box">
        <div class="modal-h">Central de Dados</div>
        
        <label class="list-header">Token do GitHub</label>
        <input class="search-inp" id="ghTokenInp" type="password" placeholder="ghp_..." style="margin-bottom:20px;">
        
        <div class="list-header" style="color:var(--accent);">Nuvem (Consultoria)</div>
        <button class="sync-btn" onclick="forceDownload()">
            <i class="fa-solid fa-cloud-arrow-down" style="color:var(--accent); font-size:1.2rem;"></i>
            <div>
                <div style="font-weight:700; color:var(--primary);">Baixar da Nuvem</div>
                <div style="font-size:0.75rem; color:#64748b;">Puxar dados do GitHub (Sync)</div>
            </div>
        </button>

        <div class="list-header" style="color:#64748b; margin-top:15px;">Backup Local</div>
        <button class="sync-btn" onclick="exportData()">
            <i class="fa-solid fa-download" style="color:var(--text); font-size:1.2rem;"></i>
            <div><div style="font-weight:700;">Baixar JSON</div><div style="font-size:0.75rem; color:#64748b;">Salvar arquivo no PC</div></div>
        </button>
        <button class="sync-btn" onclick="document.getElementById('importFile').click()">
            <i class="fa-solid fa-upload" style="color:var(--text); font-size:1.2rem;"></i>
            <div><div style="font-weight:700;">Restaurar JSON</div><div style="font-size:0.75rem; color:#64748b;">Carregar arquivo do PC</div></div>
        </button>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-pri" style="flex:1" onclick="saveTokenAndClose()">Salvar Token</button>
            <button class="btn btn-sec" style="flex:1" onclick="closeModal('sync')">Fechar</button>
        </div>
        <div style="text-align:center; margin-top:15px;"><span style="color:var(--danger); cursor:pointer; font-size:0.8rem; font-weight:700;" onclick="hardReset()">Resetar Tudo</span></div>
    </div>
</div>
<input type="file" id="importFile" hidden onchange="importData(this)">

<script>
    const KEY_LIB = 'benai_coach_lib_main';
    const KEY_STU = 'benai_coach_stu_main';
    const KEY_TOKEN = 'benai_coach_gh_token';
    const GIST_DESC = 'BENAI_CONSULTANCY_DB';

    let appData = { library: [], students: [], categories: ["Peito","Costas","Pernas","Ombros","B칤ceps","Tr칤ceps","Core","Mobilidade","Cardio"] };
    let currentWorkout = null;
    let activeExerciseId = null; 
    let gistId = null;
    const catColors = { 'Peito':'#ef4444', 'Costas':'#3b82f6', 'Pernas':'#eab308', 'Ombros':'#f97316', 'B칤ceps':'#a855f7', 'Tr칤ceps':'#ec4899', 'Core':'#10b981', 'Mobilidade':'#06b6d4', 'Cardio':'#6366f1' };

    init();

    async function init() {
        appData.library = JSON.parse(localStorage.getItem(KEY_LIB)) || [];
        appData.students = JSON.parse(localStorage.getItem(KEY_STU)) || [];
        
        const t = localStorage.getItem(KEY_TOKEN);
        if(t) document.getElementById('ghTokenInp').value = t;

        populateCats(); renderLib(); renderStudentList();
        if(appData.students.length > 0) loadStudent(appData.students[0].id);
        else createNewWorkout();

        await syncCloudInit();
    }

    function saveData() {
        localStorage.setItem(KEY_LIB, JSON.stringify(appData.library));
        localStorage.setItem(KEY_STU, JSON.stringify(appData.students));
    }

    // --- NUVEM LOGIC ---
    function updateCloudStatus(st) { const el = document.getElementById('cloudIndicator'); if(el) el.className = 'cloud-dot ' + st; }
    
    async function syncCloudInit() {
        const token = localStorage.getItem(KEY_TOKEN);
        if(!token) return updateCloudStatus('error');
        updateCloudStatus('sync');
        
        try {
            // 1. Achar Gist ID
            if(!gistId) {
                const s = await fetch('https://api.github.com/gists', { headers: { 'Authorization': `token ${token}` } });
                const g = await s.json();
                const f = g.find(x => x.description === GIST_DESC);
                if(f) gistId = f.id;
            }
            // 2. Se achar, 칩timo. Se n칚o, ser치 criado ao salvar algo.
            if(gistId) updateCloudStatus('ok');
            else updateCloudStatus('ok'); // Pronto para criar
        } catch(e) { updateCloudStatus('error'); }
    }

    async function forceDownload() {
        const token = localStorage.getItem(KEY_TOKEN);
        if(!token) return alert("Salve o token primeiro.");
        
        try {
            updateCloudStatus('sync');
            if(!gistId) await syncCloudInit();
            
            if(gistId) {
                const r = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { 'Authorization': `token ${token}` } });
                const j = await r.json();
                if(j.files["gerador_data.json"]) {
                    const cloudDB = JSON.parse(j.files["gerador_data.json"].content);
                    appData = cloudDB;
                    saveData();
                    alert("Dados baixados da nuvem!");
                    location.reload();
                } else { alert("Arquivo ainda n칚o existe na nuvem."); }
            } else { alert("Gist n칚o encontrado. Salve algo primeiro."); }
            updateCloudStatus('ok');
        } catch(e) { alert("Erro ao baixar: " + e.message); updateCloudStatus('error'); }
    }

    async function pushToCloudDB() {
        const token = localStorage.getItem(KEY_TOKEN);
        if(!token) return;
        updateCloudStatus('sync');
        try {
            let url = 'https://api.github.com/gists'; let method = 'POST';
            if(gistId) { url += '/' + gistId; method = 'PATCH'; }
            
            const payload = { 
                description: GIST_DESC, 
                public: false, 
                files: { "gerador_data.json": { content: JSON.stringify(appData) } } 
            };
            
            const res = await fetch(url, { method: method, headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const json = await res.json();
            if(json.id) gistId = json.id;
            
            updateCloudStatus('ok');
        } catch(e) { updateCloudStatus('error'); }
    }

    function saveTokenAndClose() {
        const t = document.getElementById('ghTokenInp').value;
        if(t) { localStorage.setItem(KEY_TOKEN, t); alert("Token Salvo!"); syncCloudInit(); closeModal('sync'); }
    }

    // FUN칂츾O DE ENVIO DO TREINO (Gera Link)
    async function saveToCloud(mode) {
        if(!currentWorkout.name) return alert("Preencha o nome!");
        const token = localStorage.getItem(KEY_TOKEN);
        if(!token) return alert("Configure o Token do GitHub na engrenagem!");

        // Salva DB Geral primeiro
        saveData(); pushToCloudDB();

        // L칩gica de Gist Individual do Treino
        let actualMode = mode;
        if(mode === 'update' && !currentWorkout.cloudId) actualMode = 'new_silent';

        const btn = document.getElementById(mode === 'new' ? 'btn-cloud-new' : 'btn-cloud-upd');
        const originalText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
        
        saveCurrent(); 

        const l=(currentWorkout.logicList||[]).join('\n');
        const workoutData = {
            name: currentWorkout.name, focus: currentWorkout.focus, logic: l,
            blocks: currentWorkout.blocks.map(b=>({
                name: b.name, type: b.type==='BiSet'?'biset':(b.type==='TriSet'?'triset':'block'),
                items: b.items.map(i=>({ name:i.name, link:i.link, sets:i.sets, reps:i.reps, rest:i.rest, obs:i.obs, method:i.method, drops:i.drops, isoReps:i.isoReps, rnpRest:i.rnpRest }))
            }))
        };

        try {
            let url = 'https://api.github.com/gists'; let method = 'POST';
            if (currentWorkout.cloudId) { url += '/' + currentWorkout.cloudId; method = 'PATCH'; }

            const res = await fetch(url, {
                method: method,
                headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ description: `Treino: ${currentWorkout.name}`, public: false, files: { "treino.json": { content: JSON.stringify(workoutData) } } })
            });

            if(!res.ok) {
                if(res.status === 404 && currentWorkout.cloudId) {
                    currentWorkout.cloudId = null; alert("Arquivo nuvem n칚o existe. Criando novo ID..."); return saveToCloud('new');
                }
                throw new Error("GitHub: " + res.status);
            }

            const json = await res.json();
            currentWorkout.cloudId = json.id;
            saveCurrent(); 

            btn.innerHTML = '<i class="fas fa-check"></i> Sucesso!';
            setTimeout(() => { btn.disabled = false; btn.innerHTML = originalText; }, 2000);

            if(mode === 'new') {
                let p = window.location.href.split('?')[0]; p = p.substring(0, p.lastIndexOf('/')+1);
                const finalLink = `${p}aluno.html?id=${currentWorkout.cloudId}`;
                navigator.clipboard.writeText(finalLink);
                let cleanName = currentWorkout.name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9]/g, "");
                window.open(`https://tinyurl.com/create.php?url=${encodeURIComponent(finalLink)}&alias=Benai-${cleanName}`, '_blank');
            } 
        } catch(e) { alert("Erro: " + e.message); btn.disabled = false; btn.innerHTML = originalText; }
    }

    // --- CORE ---
    function applyPreset(s, r, t) {
        if(!activeExerciseId) return alert("Selecione um exerc칤cio.");
        const { blockId, itemIdx, subIdx } = activeExerciseId;
        const b = getB(blockId);
        let item = (subIdx !== null && b.items[itemIdx].data) ? b.items[itemIdx].data[subIdx] : b.items[itemIdx];
        item.sets = s; item.reps = r; item.rest = t;
        saveCurrent(); renderBuilder();
    }

    function renderLogic() {
        const c = document.getElementById('logicContainer'); c.innerHTML = '';
        if(!currentWorkout.logicList) currentWorkout.logicList = [];
        currentWorkout.logicList.forEach((txt, idx) => {
            const row = document.createElement('div'); row.className = 'logic-item';
            row.innerHTML = `<input class="logic-inp" value="${txt}" onchange="updLogic(${idx}, this.value)"><div class="logic-del" onclick="delLogic(${idx})"><i class="fas fa-trash"></i></div>`;
            c.appendChild(row);
        });
    }
    function addLogicTopic() { if(!currentWorkout.logicList) currentWorkout.logicList = []; currentWorkout.logicList.push(""); saveCurrent(); renderLogic(); }
    function updLogic(idx, val) { currentWorkout.logicList[idx] = val; saveCurrent(); }
    function delLogic(idx) { currentWorkout.logicList.splice(idx, 1); saveCurrent(); renderLogic(); }

    function createNewWorkout() {
        currentWorkout = { id: Date.now(), cloudId: null, name: '', focus: '', logicList: [], blocks: [] };
        addBlock('Normal'); document.getElementById('sName').value = ''; document.getElementById('sFocus').value = '';
        activeExerciseId = null; renderBuilder(); renderLogic();
    }
    function addBlock(type) {
        if(!currentWorkout) createNewWorkout();
        let name = 'Bloco Principal'; if(type==='BiSet') name = 'Bi-Set'; if(type==='TriSet') name = 'Tri-Set';
        currentWorkout.blocks.push({ id: Date.now(), type: type, name: name, items: [] });
        saveCurrent(); renderBuilder();
    }
    function saveCurrent() {
        if(!currentWorkout) return;
        currentWorkout.name = document.getElementById('sName').value;
        currentWorkout.focus = document.getElementById('sFocus').value;
        if(currentWorkout.name.trim() !== "") {
            const idx = appData.students.findIndex(s => s.id === currentWorkout.id);
            if(idx >= 0) appData.students[idx] = currentWorkout; else appData.students.push(currentWorkout);
            saveData(); renderStudentList();
        }
    }
    function loadStudent(id) {
        const s = appData.students.find(x => x.id === id);
        if(s) { currentWorkout = JSON.parse(JSON.stringify(s)); if(!currentWorkout.logicList) currentWorkout.logicList = (currentWorkout.logic||'').split('\n').filter(x=>x); activeExerciseId = null; renderBuilder(); renderLogic(); }
    }

    function renderBuilder() {
        document.getElementById('sName').value = currentWorkout.name || '';
        document.getElementById('sFocus').value = currentWorkout.focus || '';
        const cont = document.getElementById('blocksContainer'); cont.innerHTML = '';
        currentWorkout.blocks.forEach(blk => {
            let cls = 'block-container';
            if(blk.type === 'BiSet') cls += ' biset-cont'; else if(blk.type === 'TriSet') cls += ' triset-cont'; else cls += ' normal-wrap';
            if(activeExerciseId && activeExerciseId.blockId === blk.id) cls += ' active-block';
            const div = document.createElement('div'); div.className = cls;
            let itemsHtml = blk.items.length === 0 ? `<div style="text-align:center; padding:20px; color:#94a3b8; font-size:0.8rem;">Toque num exerc칤cio da biblioteca</div>` : blk.items.map((it, idx) => renderRow(blk.id, idx, it, null)).join('');
            div.innerHTML = `<div class="block-head"><input class="w-title" value="${blk.name}" placeholder="Nome do Bloco" onchange="updBlock(${blk.id}, this.value)"><div class="blk-actions"><div class="blk-btn" onclick="moveBlock(${blk.id}, -1)"><i class="fas fa-arrow-up"></i></div><div class="blk-btn" onclick="moveBlock(${blk.id}, 1)"><i class="fas fa-arrow-down"></i></div><div class="blk-btn" style="color:var(--danger)" onclick="delBlock(${blk.id})"><i class="fas fa-trash"></i></div></div></div><div class="block-body">${itemsHtml}</div>`;
            div.onclick = (e) => { if(!e.target.closest('input') && !e.target.closest('button') && !e.target.closest('.m-tab') && !e.target.closest('.act-btn') && !e.target.closest('.blk-btn')) { if(activeExerciseId?.blockId !== blk.id) { activeExerciseId = { blockId: blk.id, itemIdx: null }; renderBuilder(); } } };
            cont.appendChild(div);
        });
    }

    function renderRow(bId, idx, item, sIdx) {
        const isActive = activeExerciseId && activeExerciseId.blockId === bId && activeExerciseId.itemIdx === idx;
        let lblReps="Reps", repsInputType="number", repsWidth="55px", showDrops=false;
        if(item.method==='Drop'){ lblReps="Reps Max"; showDrops=true; }
        if(item.method==='Iso') lblReps="Tempo(s)";
        if(item.method==='Pyr'){ lblReps="Escada"; repsInputType="text"; repsWidth="80px"; }
        
        let methods = ['Normal', 'Drop', 'RNP', 'Iso', 'Pyr'];
        let tabsHtml = `<div class="method-tabs">` + methods.map(m => `<button class="m-tab ${item.method===m?'active':''}" onclick="updItem(${bId}, ${idx}, 'method', '${m}'); event.stopPropagation();">${m}</button>`).join('') + `</div>`;
        
        let fieldsHtml = `<div class="pill-group"><span class="pill-lbl">SETS</span><input class="pill-inp" type="number" value="${item.sets}" onchange="updItem(${bId},${idx},'sets',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">${lblReps.toUpperCase()}</span><input class="pill-inp" type="${repsInputType}" style="width:${repsWidth}" value="${item.reps}" onchange="updItem(${bId},${idx},'reps',this.value)" onclick="event.stopPropagation()"></div>`;
        if(item.method==='Iso') fieldsHtml=`<div class="pill-group"><span class="pill-lbl">SETS</span><input class="pill-inp" type="number" value="${item.sets}" onchange="updItem(${bId},${idx},'sets',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">ISO(s)</span><input class="pill-inp" type="number" value="${item.reps}" onchange="updItem(${bId},${idx},'reps',this.value)" onclick="event.stopPropagation()"></div>`;
        if(item.method==='RNP') fieldsHtml+=`<div class="pill-group"><span class="pill-lbl">PAUSA</span><input class="pill-inp" type="number" value="${item.rnpRest||10}" onchange="updItem(${bId},${idx},'rnpRest',this.value)" onclick="event.stopPropagation()"></div>`;
        if(showDrops) fieldsHtml+=`<div class="pill-group"><span class="pill-lbl">DROPS</span><input class="pill-inp" type="number" value="${item.drops||0}" onchange="updItem(${bId},${idx},'drops',this.value)" onclick="event.stopPropagation()"></div>`;

        return `<div class="ex-row ${isActive?'selected':''}" data-method="${item.method}" onclick="selectExercise(${bId},${idx},null)"><div class="ex-header"><span class="ex-name">${item.name}</span></div>${tabsHtml}<div class="pills-edit">${fieldsHtml}<div class="pill-group pill-int"><span class="pill-lbl">INT FINAL</span><input class="pill-inp" type="text" value="${item.rest}" onchange="updItem(${bId},${idx},'rest',this.value)" onclick="event.stopPropagation()"></div></div><input class="obs-inp" value="${item.obs}" placeholder="Carga / Obs..." onchange="updItem(${bId},${idx},'obs',this.value)" onclick="event.stopPropagation()"><div class="row-actions"><div class="act-btn" onclick="moveItem(${bId},${idx},-1);event.stopPropagation();"><i class="fas fa-arrow-up"></i></div><div class="act-btn" onclick="moveItem(${bId},${idx},1);event.stopPropagation();"><i class="fas fa-arrow-down"></i></div><div class="act-btn" style="color:var(--danger);" onclick="delItem(${bId},${idx});event.stopPropagation();"><i class="fas fa-trash"></i></div></div></div>`;
    }

    function getB(id) { return currentWorkout.blocks.find(b=>b.id===id); }
    function updBlock(id, val) { getB(id).name = val; saveCurrent(); }
    function selectExercise(bId, idx, sIdx) { activeExerciseId = { blockId: bId, itemIdx: idx, subIdx: sIdx }; renderBuilder(); }
    function delBlock(id) { if(confirm("Excluir bloco?")) { currentWorkout.blocks = currentWorkout.blocks.filter(b=>b.id!==id); activeExerciseId = null; saveCurrent(); renderBuilder(); } }
    function moveBlock(id, dir) { const idx = currentWorkout.blocks.findIndex(b => b.id === id); if(idx + dir < 0 || idx + dir >= currentWorkout.blocks.length) return; const temp = currentWorkout.blocks[idx]; currentWorkout.blocks[idx] = currentWorkout.blocks[idx + dir]; currentWorkout.blocks[idx + dir] = temp; saveCurrent(); renderBuilder(); }
    function addItem(ex){ if(!currentWorkout)createNewWorkout(); let t; if(activeExerciseId) t=activeExerciseId.blockId; else{ if(currentWorkout.blocks.length===0)addBlock('Normal'); t=currentWorkout.blocks[currentWorkout.blocks.length-1].id; } let b=getB(t); b.items.push({name:ex.name,link:ex.link||'',sets:'3',reps:'10',rest:'60s',obs:'',method:'Normal',drops:0,isoReps:1,rnpRest:10}); activeExerciseId={blockId:t,itemIdx:b.items.length-1,subIdx:null}; saveCurrent();renderBuilder(); const c=document.querySelector('.canvas');c.scrollTop=c.scrollHeight; }
    function updItem(bId,idx,f,v){const b=getB(bId);b.items[idx][f]=v;saveCurrent();renderBuilder();}
    function delItem(bId,idx){const b=getB(bId);b.items.splice(idx,1);activeExerciseId=null;saveCurrent();renderBuilder();}
    function moveItem(bId,idx,d){const b=getB(bId);if(idx+d<0||idx+d>=b.items.length)return;const t=b.items[idx];b.items[idx]=b.items[idx+d];b.items[idx+d]=t;if(activeExerciseId&&activeExerciseId.blockId===bId&&activeExerciseId.itemIdx===idx)activeExerciseId.itemIdx+=d;saveCurrent();renderBuilder();}
    function renderLib(){const l=document.getElementById('libList'),t=document.getElementById('searchLib').value.toLowerCase(),c=document.getElementById('catFilter').value;l.innerHTML='';appData.library.filter(x=>x.name.toLowerCase().includes(t)&&(c==='Todas'||x.cat===c)).forEach(x=>{const d=document.createElement('div');d.className='item-card';d.innerHTML=`<div style="font-weight:600;color:var(--text);font-size:0.85rem;"><span class="cat-dot" style="background:${catColors[x.cat]||'#999'}"></span> ${x.name}</div><div style="display:flex;gap:8px;"><i class="fas fa-pen" style="color:#cbd5e1;font-size:0.7rem;" onclick="editEx(${x.id},event)"></i><i class="fas fa-trash" style="color:#cbd5e1;font-size:0.7rem;" onclick="delEx(${x.id},event)"></i></div>`;d.onclick=(e)=>{if(e.target.tagName!=='I')addItem(x)};l.appendChild(d);});}
    function filterStudents(v){const l=document.getElementById('studentList');l.innerHTML='';appData.students.filter(s=>s.name.toLowerCase().includes(v.toLowerCase())).forEach(s=>{const d=document.createElement('div');d.className=`student-item ${currentWorkout&&s.id===currentWorkout.id?'active':''}`;d.innerHTML=`<div><span class="st-name">${s.name}</span><span class="st-focus">${s.focus||'Sem objetivo'}</span></div><i class="fas fa-trash st-del" onclick="delStudent(${s.id},event)"></i>`;d.onclick=()=>loadStudent(s.id);l.appendChild(d);});}
    function delStudent(id,e){ e.stopPropagation(); if(confirm("Apagar aluno permanentemente?")){ appData.students=appData.students.filter(s=>s.id!==id); saveData(); if(currentWorkout&&currentWorkout.id===id) createNewWorkout(); renderStudentList(); } }
    function renderStudentList(){filterStudents('');}
    function populateCats(){const s=[document.getElementById('catFilter'),document.getElementById('exCat')];s[0].innerHTML='<option value="Todas">Todas</option>';s[1].innerHTML='';appData.categories.forEach(c=>{s[0].add(new Option(c,c));s[1].add(new Option(c,c));});}
    function openExModal(){document.getElementById('exId').value='';document.getElementById('exName').value='';document.getElementById('exLink').value='';openModal('ex');}
    function editEx(id,e){e.stopPropagation();const x=appData.library.find(z=>z.id===id);document.getElementById('exId').value=x.id;document.getElementById('exName').value=x.name;document.getElementById('exCat').value=x.cat;document.getElementById('exLink').value=x.link||'';openModal('ex');}
    function saveEx(){const i=document.getElementById('exId').value,n=document.getElementById('exName').value,c=document.getElementById('exCat').value,l=document.getElementById('exLink').value;if(!n)return;if(i){const x=appData.library.findIndex(z=>z.id==i);appData.library[x]={id:Number(i),name:n,cat:c,link:l};}else appData.library.push({id:Date.now(),name:n,cat:c,link:l});saveData();renderLib();closeModal('ex');}
    function delEx(id,e){e.stopPropagation();if(confirm("Apagar?")){appData.library=appData.library.filter(x=>x.id!==id);saveData();renderLib();}}
    function openModal(id){document.getElementById('modal-'+id).style.display='flex';}
    function closeModal(id){document.getElementById('modal-'+id).style.display='none';}
    
    function exportData(){const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData));const a=document.createElement('a');a.href=d;a.download="benai_consultoria_backup.json";a.click();}
    function importData(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const j=JSON.parse(e.target.result);if(j.library)appData.library=j.library;if(j.students)appData.students=j.students;saveData();init();alert("Dados restaurados!");}catch(x){alert("Erro");}};r.readAsText(f);}
    
    function generateOfflineLink(){
        if(!currentWorkout.name) return alert("Preencha o nome!");
        saveCurrent();
        const l=(currentWorkout.logicList||[]).join('\n');
        const m={name:currentWorkout.name,focus:currentWorkout.focus,logic:l,blocks:currentWorkout.blocks.map(b=>({name:b.name,type:b.type==='BiSet'?'biset':(b.type==='TriSet'?'triset':'block'),items:b.items.map(i=>({name:i.name,link:i.link,sets:i.sets,reps:i.reps,rest:i.rest,obs:i.obs,method:i.method,drops:i.drops,isoReps:i.isoReps,rnpRest:i.rnpRest}))}))};
        const j=JSON.stringify(m);
        const c=LZString.compressToEncodedURIComponent(j);
        let p=window.location.href.split('?')[0]; p=p.substring(0,p.lastIndexOf('/')+1);
        const u=`${p}aluno.html?data=${c}`;
        navigator.clipboard.writeText(u).then(()=>alert("游닍 Link OFFLINE copiado!"));
    }
    
    function hardReset(){if(confirm("Apagar tudo?")){localStorage.clear(); location.reload();}}
</script>
</body>
</html>
