<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benai Generator | Final Master</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

<script>
        (function() {
            // --- CONFIGURA√á√ÉO DA SENHA ---
            const PIN_CORRETO = "16359001"; 
            // -----------------------------

            if (sessionStorage.getItem("benai_access_granted") === "true") return;

            document.write(`
                <style>
                    body { visibility: hidden; overflow: hidden; }
                    #gatekeeper {
                        visibility: visible; position: fixed; inset: 0;
                        background: #0f172a; color: white; z-index: 99999;
                        display: flex; flex-direction: column; align-items: center; justify-content: center;
                        font-family: 'Outfit', sans-serif;
                    }
                    .pin-box { text-align: center; animation: fadeIn 0.5s ease; width: 90%; max-width: 350px; }
                    .pin-inp { 
                        padding: 15px; font-size: 1.5rem; text-align: center; 
                        border-radius: 15px; border: 2px solid rgba(56, 189, 248, 0.3); outline: none; margin-top: 25px;
                        background: rgba(255,255,255,0.05); color: white; letter-spacing: 4px; width: 100%;
                        transition: 0.3s;
                    }
                    .pin-inp:focus { border-color: #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.2); }
                    .pin-msg { color: #f87171; margin-top: 15px; font-weight: 600; font-size: 0.9rem; height: 20px; }
                    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                </style>
                <div id="gatekeeper">
                    <div class="pin-box">
                        <i class="fa-solid fa-shield-halved" style="font-size: 3rem; color: #38bdf8; margin-bottom: 15px;"></i>
                        <h2 style="font-size: 1.5rem; letter-spacing: -1px;">Sistema Protegido</h2>
                        <p style="opacity: 0.6; font-size: 0.85rem;">Insira o c√≥digo de 8 d√≠gitos</p>
                        <input type="password" class="pin-inp" maxlength="8" placeholder="********" inputmode="numeric" autocomplete="off" onkeyup="verifyPin(this)">
                        <div class="pin-msg" id="pin-error"></div>
                    </div>
                </div>
            `);

            window.verifyPin = function(el) {
                if (el.value.length === 8) {
                    if (el.value === PIN_CORRETO) {
                        sessionStorage.setItem("benai_access_granted", "true");
                        location.reload();
                    } else {
                        document.getElementById("pin-error").innerText = "C√≥digo Incorreto";
                        el.value = "";
                        if(navigator.vibrate) navigator.vibrate(200);
                    }
                }
            };
        })();
    </script>
    <style>
        :root {
            --primary: #001F5B; --accent: #00A8E8; --bg: #f0f2f5;
            --surface: #ffffff; --border: #e2e8f0; --text: #1f2937;
            --success: #10b981; --danger: #ef4444; 
            
            /* CORES ID√äNTICAS AO ALUNO.HTML */
            --c-drop: #ef4444; --c-rnp: #f59e0b; --c-iso: #06b6d4; 
            --c-pyr: #8b5cf6; --c-fst: #ec4899; --c-bi: #00A8E8; --c-tri: #6366f1;
            
            --font-ui: 'Plus Jakarta Sans', sans-serif; --font-num: 'Outfit', sans-serif;
        }
        
        * { box-sizing: border-box; outline: none; font-family: var(--font-ui); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        body { margin: 0; height: 100vh; display: grid; grid-template-columns: 280px 1fr 320px; overflow: hidden; background: var(--bg); color: var(--text); font-size: 13px; }

        /* SIDEBARS */
        .sidebar { background: var(--surface); display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); border-left: 1px solid var(--border); z-index: 10; height: 100vh; overflow: hidden; }
        .brand-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .brand { color: var(--primary); font-family: var(--font-num); font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; text-transform:uppercase; letter-spacing:0.5px;}
        .cloud-btn { width: 34px; height: 34px; border-radius: 10px; background: rgba(0, 168, 232, 0.05); color: var(--accent); border: 1px solid rgba(0, 168, 232, 0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        
        .list-header { font-weight: 800; color: var(--text); font-size: 0.75rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
        .list-scroll { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-right: 5px; padding-bottom: 20px; }
        
        .item-card { padding: 10px; border-radius: 8px; border: 1px solid transparent; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; transition: 0.1s; }
        .item-card:hover { background: white; border-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateX(2px); }
        
        .student-item { padding: 12px; border-radius: 10px; cursor: pointer; border: 1px solid transparent; background: white; border-bottom: 1px solid var(--border); position: relative; transition:0.2s; }
        .student-item:hover { background: #f0f9ff; }
        .student-item.active { background: #eff6ff; border-color: var(--accent); box-shadow: 0 2px 8px rgba(0, 168, 232, 0.15); }
        .st-name { font-weight: 700; color: var(--primary); font-size: 0.9rem; display: block; }
        .st-focus { font-size: 0.75rem; color: #64748b; }
        .st-del { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #cbd5e1; cursor: pointer; padding: 6px; z-index: 5; }
        .st-del:hover { color: var(--danger); background: #fee2e2; border-radius: 6px; }

        /* BUTTONS */
        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85rem; transition: 0.2s; }
        .btn-pri { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,31,91,0.2); }
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-acc { background: var(--accent); color: white; }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }

        /* CENTER AREA */
        .col-center { display: flex; flex-direction: column; background: #e2e8f0; height: 100vh; overflow: hidden; }
        
        .toolbar { background: var(--surface); padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; overflow-x: auto; white-space: nowrap; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .toolbar-label { font-weight: 800; color: var(--primary); font-size: 0.7rem; margin-right: 5px; }
        .chip { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; cursor: pointer; border: 1px solid var(--border); background: white; color: #64748b; transition: 0.2s; display: flex; flex-direction: column; align-items: center; line-height: 1.1; min-width: 70px; }
        .chip small { font-weight: 400; font-size: 0.65rem; opacity: 0.8; }
        .chip:hover { border-color: var(--accent); background: var(--accent); color: white; transform: translateY(-1px); }

        .canvas { flex: 1; overflow-y: auto; padding: 30px; display: flex; justify-content: center; align-items: flex-start; scroll-behavior: smooth; }
        
        .phone { width: 100%; max-width: 480px; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-height: 800px; border: 1px solid #cbd5e1; overflow: hidden; margin-bottom: 50px; }
        .ph-header { background: var(--primary); padding: 25px 20px; color: white; }
        .ph-inp { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 10px 12px; border-radius: 8px; width: 100%; margin-bottom: 8px; font-weight: 600; font-family: var(--font-ui); font-size: 0.95rem; }
        .ph-inp::placeholder { color: rgba(255,255,255,0.5); }
        .ph-inp:focus { background: rgba(255,255,255,0.2); border-color: white; outline: none; }
        .ph-body { padding: 15px; background: #f8fafc; flex: 1; display: flex; flex-direction: column; gap: 15px; }

        /* --- BLOCOS (ESTILO FINAL) --- */
        
        /* 1. Normal: Invisivel (Sem borda dupla) */
        .normal-wrap { background: transparent; border: none; margin-bottom: 15px; transition: 0.2s; }
        .normal-wrap .block-head { background: transparent; padding: 0 0 5px 5px; border-bottom: 1px solid #e2e8f0; margin-bottom: 10px; }
        .normal-wrap .block-body { padding: 0; }
        /* T√≠tulo Normal */
        .w-title { background: transparent; border: none; font-weight: 800; font-family:var(--font-num); color: var(--primary); font-size: 0.85rem; text-transform: uppercase; width: 100%; }

        /* 2. Bi/Tri: Vis√≠vel com Borda Pontilhada */
        .biset-cont { border: 2px dashed var(--c-bi); background: #f0f9ff; border-radius: 16px; margin-bottom: 15px; overflow:hidden; transition: 0.2s; }
        .biset-cont .block-head { background: #e0f2fe; padding: 8px 12px; border-bottom:1px solid rgba(0,0,0,0.05); }
        .biset-cont .block-body { padding: 10px; }

        .triset-cont { border: 2px dashed var(--c-tri); background: #fdf4ff; border-radius: 16px; margin-bottom: 15px; overflow:hidden; transition: 0.2s; }
        .triset-cont .block-head { background: #f3e8ff; padding: 8px 12px; border-bottom:1px solid rgba(0,0,0,0.05); }
        .triset-cont .block-body { padding: 10px; }

        /* DESTAQUE DE BLOCO ATIVO (PEDIDO) */
        .active-block {
            border: 2px solid var(--primary) !important; /* Borda S√≥lida Escura */
            box-shadow: 0 0 0 4px rgba(0, 31, 91, 0.1);
        }
        /* Para o bloco normal, como ele √© transparente, colocamos uma borda sutil para indicar sele√ß√£o */
        .normal-wrap.active-block {
            border: 2px solid var(--primary) !important;
            background: rgba(255,255,255,0.5);
            padding: 10px;
            border-radius: 16px;
        }

        .block-head { display: flex; justify-content: space-between; align-items: center; gap:10px; }
        .blk-actions { display:flex; gap:5px; }
        .blk-btn { width:24px; height:24px; border-radius:4px; background:rgba(255,255,255,0.5); display:flex; align-items:center; justify-content:center; cursor:pointer; color:#64748b; font-size:0.7rem; }
        .blk-btn:hover { background:white; color:var(--primary); }

        /* ROWS */
        .ex-row { 
            padding: 12px; border: 1px solid #e2e8f0; background: white; 
            border-radius: 12px; position: relative; margin-bottom: 10px; 
            border-left-width: 4px; border-left-color: #cbd5e1; cursor: pointer;
            transition: 0.2s;
        }
        /* Sele√ß√£o de Exerc√≠cio */
        .ex-row.selected { border: 2px solid var(--accent); background: #f0f9ff; }
        
        /* Dentro de Bi/Tri */
        .biset-cont .ex-row, .triset-cont .ex-row {
            border: none; border-radius: 0; margin-bottom: 0; 
            border-bottom: 1px dashed #cbd5e1; background: transparent;
            border-left-width: 4px; 
        }
        .biset-cont .ex-row:last-child, .triset-cont .ex-row:last-child { border-bottom: none; }

        /* Cores de M√©todo */
        .ex-row[data-method="Drop"] { border-left-color: var(--c-drop); } 
        .ex-row[data-method="RNP"] { border-left-color: var(--c-rnp); } 
        .ex-row[data-method="Iso"] { border-left-color: var(--c-iso); } 
        .ex-row[data-method="Pyr"] { border-left-color: var(--c-pyr); } 

        .ex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .ex-name { font-weight: 700; font-size: 1rem; color: #1e293b; font-family: var(--font-num); }
        
        .method-tabs { display: flex; gap: 4px; margin-bottom: 10px; background: #f1f5f9; padding: 3px; border-radius: 8px; overflow-x: auto; }
        .m-tab { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; border: none; background: transparent; color: #64748b; cursor: pointer; white-space: nowrap; transition: 0.1s; }
        .m-tab:hover { background: rgba(255,255,255,0.5); }
        .m-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ex-row[data-method="Drop"] .m-tab.active { color: var(--c-drop); }
        .ex-row[data-method="RNP"] .m-tab.active { color: var(--c-rnp); }
        .ex-row[data-method="Iso"] .m-tab.active { color: var(--c-iso); }
        .ex-row[data-method="Pyr"] .m-tab.active { color: var(--c-pyr); }

        .pills-edit { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 8px; align-items: flex-end; }
        .pill-group { display: flex; flex-direction: column; align-items: flex-start; }
        .pill-lbl { font-size: 0.6rem; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px; }
        
        .pill-inp { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 6px; font-size: 0.85rem; font-weight: 700; color: var(--primary); width: 60px; text-align: center; font-family: var(--font-num); }
        .pill-inp:focus { border-color: var(--accent); outline:none; }
        .pill-inp:disabled { background: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; }
        
        .pill-int { margin-left: auto; border-left: 1px solid #e2e8f0; padding-left: 15px; }
        .obs-inp { width: 100%; border: none; background: #fffbeb; padding: 8px; font-size: 0.8rem; color: #b45309; border-radius: 6px; }

        .row-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 5px; }
        .act-btn { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #cbd5e1; transition: 0.2s; }
        .act-btn:hover { background: #f1f5f9; color: var(--danger); }

        /* Helpers */
        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.85rem; transition: 0.2s; }
        .btn-pri { background: var(--primary); color: white; }
        .btn-sec { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-acc { background: var(--accent); color: white; }
        
        .logic-list { display: flex; flex-direction: column; gap: 8px; }
        .logic-item { display: flex; gap: 5px; }
        .logic-inp { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; font-family:var(--font-ui); background: white; }
        .logic-del { color: var(--danger); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; width: 30px; }
        .search-inp { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; margin-bottom: 10px; }
        .cat-select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.85rem; margin-bottom: 10px; background: white; }
        
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(3px); }
        .modal-box { background:white; width:90%; max-width:400px; padding:25px; border-radius:20px; box-shadow:0 20px 50px rgba(0,0,0,0.2); }
        .modal-h { font-size: 1.2rem; font-weight: 800; color: var(--primary); margin-bottom: 15px; font-family: var(--font-num); }
        .sync-btn { width: 100%; padding: 15px; border: 1px solid #e2e8f0; border-radius: 12px; background: white; display: flex; align-items: center; gap: 15px; margin-bottom: 10px; cursor: pointer; text-align: left; }
        .cat-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:5px; }
    </style>
</head>
<body>

<div class="sidebar col-left">
    <div class="brand-area"><div class="brand"><i class="fas fa-bolt"></i> BENAI GENERATOR</div><div class="cloud-btn" onclick="openModal('sync')"><i class="fa-solid fa-cloud"></i></div></div>
    <button class="btn btn-pri" style="width:100%; margin-bottom:15px;" onclick="createNewWorkout()"><i class="fas fa-user-plus"></i> Novo Aluno</button>
    <input class="search-inp" placeholder="Buscar aluno..." onkeyup="filterStudents(this.value)">
    <div class="list-header">Meus Alunos</div><div class="list-scroll" id="studentList"></div>
</div>

<div class="col-center">
    <div class="toolbar">
        <span class="toolbar-label">APLICAR:</span>
        <div class="chip" onclick="applyPreset('3','15','60s')">Padr√£o 3x15</div>
        <div class="chip" onclick="applyPreset('4','10','60s')">Hipertrofia</div>
        <div class="chip" onclick="applyPreset('3','20','45s')">Metab√≥lico</div>
        <div class="chip" onclick="applyPreset('5','5','180s')">For√ßa</div>
        <div class="chip" onclick="applyPreset('3','30','30s')">RML</div>
        <div class="chip" onclick="applyPreset('3','Falha','60s')">Falha</div>
    </div>

    <div class="canvas">
        <div class="phone">
            <div class="ph-header">
                <input class="ph-inp" id="sName" placeholder="Nome do Aluno" onchange="saveCurrent()" onclick="event.stopPropagation()" style="font-size:1.2rem; background:transparent; border:none; padding:0; margin-bottom:5px;">
                <input class="ph-inp" id="sFocus" placeholder="Objetivo Principal" style="font-weight:400; font-size:0.9rem; opacity:0.9; margin:0;" onchange="saveCurrent()" onclick="event.stopPropagation()">
            </div>

            <div class="ph-body">
                <div id="blocksContainer"></div>
                
                <div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:10px;">
                    <button class="btn btn-sec" style="flex:1; border-style:dashed;" onclick="addBlock('Normal')">+ Simples</button>
                    <button class="btn btn-sec" style="flex:1; border-style:dashed; color:var(--c-bi); border-color:var(--c-bi);" onclick="addBlock('BiSet')">+ Bi-Set</button>
                    <button class="btn btn-sec" style="flex:1; border-style:dashed; color:var(--c-tri); border-color:var(--c-tri);" onclick="addBlock('TriSet')">+ Tri-Set</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="sidebar col-right">
    <div class="list-header" style="color:var(--primary); display:flex; align-items:center; gap:5px;">
        <i class="fa-solid fa-list-check"></i> L√≥gica do Treino
    </div>
    
    <div style="margin-bottom:10px;">
        <div id="logicContainer" class="logic-list"></div>
        <button class="btn btn-sec" style="width:100%; margin-top:10px; padding:8px; font-size:0.8rem; background:white;" onclick="addLogicTopic()">+ Adicionar T√≥pico</button>
    </div>

    <div style="width:100%; height:1px; background:var(--border); margin-bottom:20px; margin-top:20px;"></div>

    <div class="list-header">Biblioteca</div>
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input class="search-inp" id="searchLib" placeholder="Buscar..." onkeyup="renderLib()" style="margin:0;">
        <button class="btn btn-pri" style="width:40px;" onclick="openExModal()"><i class="fas fa-plus"></i></button>
    </div>
    
    <div style="display:flex; gap:5px; align-items:center; margin-bottom:10px;">
        <select class="cat-select" id="catFilter" onchange="renderLib()" style="margin:0; width:100%; padding:8px; border-radius:8px; border:1px solid var(--border);"></select>
    </div>

    <div class="list-scroll" id="libList"></div>

    <div style="padding-top:20px; border-top:1px solid var(--border); margin-top:auto;">
        <button class="btn btn-acc" style="width:100%; height:50px; font-size:1rem;" onclick="generateLink()">
            <i class="fas fa-link"></i> SALVAR E GERAR LINK
        </button>
    </div>
</div>

<div id="modal-sync" class="modal">
    <div class="modal-box">
        <i class="fa-solid fa-xmark modal-close" onclick="closeModal('sync')"></i>
        <div style="font-weight:800; font-size:1.2rem; color:var(--primary); margin-bottom:20px;">Central de Dados</div>
        <button class="sync-btn" onclick="exportData()"><i class="fa-solid fa-download" style="color:var(--accent)"></i> <div>Baixar JSON (Backup PC)</div></button>
        <button class="sync-btn" onclick="document.getElementById('importFile').click()"><i class="fa-solid fa-upload" style="color:var(--primary)"></i> <div>Restaurar JSON</div></button>
        <button class="sync-btn" style="border-color:var(--danger); color:var(--danger); margin-top:10px;" onclick="hardReset()"><i class="fa-solid fa-trash"></i> Resetar Tudo</button>
    </div>
</div>

<div id="modal-ex" class="modal">
    <div class="modal-box">
        <div class="modal-h">Exerc√≠cio</div>
        <input type="hidden" id="exId">
        <label class="list-header">Nome</label><input class="search-inp" id="exName">
        <label class="list-header">Categoria</label><select class="cat-select" id="exCat" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border);"></select>
        <label class="list-header">Link V√≠deo (Opcional)</label><input class="search-inp" id="exLink" placeholder="YouTube URL...">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-sec" style="flex:1" onclick="closeModal('ex')">Cancelar</button>
            <button class="btn btn-pri" style="flex:1" onclick="saveEx()">Salvar</button>
        </div>
    </div>
</div>

<div id="modal-cat" class="modal">
    <div class="modal-box">
        <div class="modal-h">Gerenciar Categorias</div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input class="search-inp" id="newCatName" placeholder="Nova..." style="margin:0;">
            <button class="btn btn-pri" onclick="addCategory()">Add</button>
        </div>
        <div id="catList" style="max-height:200px; overflow-y:auto;"></div>
        <button class="btn btn-sec" style="width:100%; margin-top:15px;" onclick="closeModal('cat')">Fechar</button>
    </div>
</div>

<input type="file" id="importFile" hidden onchange="importData(this)">

<script>
    // CHAVES MESTRAS PARA EVITAR PERDA DE DADOS
    const KEY_LIB = 'benai_coach_lib_main';
    const KEY_STU = 'benai_coach_stu_main';
    const KEY_CAT = 'benai_coach_cat_main';
    
    // Lista de chaves antigas para migra√ß√£o autom√°tica
    const OLD_KEYS_LIB = ['benai_lib_v13', 'benai_lib_v12', 'benai_lib_v11'];
    const OLD_KEYS_STU = ['benai_students_v13', 'benai_students_v12'];
    const OLD_KEYS_CAT = ['benai_cats_v13', 'benai_cats_v12'];

    let appData = {
        library: [],
        students: [],
        categories: []
    };

    let currentWorkout = null;
    let activeExerciseId = null; 
    
    const catColors = { 'Peito':'#ef4444', 'Costas':'#3b82f6', 'Pernas':'#eab308', 'Ombros':'#f97316', 'B√≠ceps':'#a855f7', 'Tr√≠ceps':'#ec4899', 'Core':'#10b981', 'Mobilidade':'#06b6d4', 'Cardio':'#6366f1' };

    init();

    function init() {
        // Tenta carregar Main
        let lib = localStorage.getItem(KEY_LIB);
        let stu = localStorage.getItem(KEY_STU);
        let cat = localStorage.getItem(KEY_CAT);

        // Se vazio, tenta migrar
        if(!lib) lib = migrate(OLD_KEYS_LIB, KEY_LIB);
        if(!stu) stu = migrate(OLD_KEYS_STU, KEY_STU);
        if(!cat) cat = migrate(OLD_KEYS_CAT, KEY_CAT);

        appData.library = JSON.parse(lib) || [];
        appData.students = JSON.parse(stu) || [];
        appData.categories = JSON.parse(cat) || ["Peito","Costas","Pernas","Ombros","B√≠ceps","Tr√≠ceps","Core","Mobilidade","Cardio"];

        populateCats();
        renderLib(); 
        renderStudentList();
        
        if(appData.students.length > 0) loadStudent(appData.students[0].id);
        else createNewWorkout();
    }

    function migrate(oldKeys, newKey) {
        for(let k of oldKeys) {
            let d = localStorage.getItem(k);
            if(d) {
                localStorage.setItem(newKey, d); // Salva na nova
                return d;
            }
        }
        return null;
    }

    function saveData() {
        localStorage.setItem(KEY_LIB, JSON.stringify(appData.library));
        localStorage.setItem(KEY_STU, JSON.stringify(appData.students));
        localStorage.setItem(KEY_CAT, JSON.stringify(appData.categories));
    }

    // --- PROTOCOLS (PRESETS) ---
    function applyPreset(s, r, t) {
        if(!activeExerciseId) return alert("Selecione um exerc√≠cio para aplicar.");
        const { blockId, itemIdx, subIdx } = activeExerciseId;
        const b = getB(blockId);
        let item = (subIdx !== null && b.items[itemIdx].data) ? b.items[itemIdx].data[subIdx] : b.items[itemIdx];
        item.sets = s; item.reps = r; item.rest = t;
        saveCurrent(); renderBuilder();
    }

    // --- LOGIC TOPICS ---
    function renderLogic() {
        const c = document.getElementById('logicContainer');
        c.innerHTML = '';
        if(!currentWorkout.logicList) currentWorkout.logicList = [];
        
        currentWorkout.logicList.forEach((txt, idx) => {
            const row = document.createElement('div');
            row.className = 'logic-item';
            row.innerHTML = `
                <input class="logic-inp" value="${txt}" onchange="updLogic(${idx}, this.value)">
                <div class="logic-del" onclick="delLogic(${idx})"><i class="fas fa-trash"></i></div>
            `;
            c.appendChild(row);
        });
    }
    function addLogicTopic() {
        if(!currentWorkout.logicList) currentWorkout.logicList = [];
        currentWorkout.logicList.push("");
        saveCurrent(); renderLogic();
    }
    function updLogic(idx, val) {
        currentWorkout.logicList[idx] = val;
        saveCurrent();
    }
    function delLogic(idx) {
        currentWorkout.logicList.splice(idx, 1);
        saveCurrent(); renderLogic();
    }

    // --- WORKOUT BUILDER ---
    function createNewWorkout() {
        currentWorkout = { id: Date.now(), name: '', focus: '', logicList: [], blocks: [] };
        addBlock('Normal'); 
        document.getElementById('sName').value = '';
        document.getElementById('sFocus').value = '';
        activeExerciseId = null;
        renderBuilder(); renderLogic();
    }

    function addBlock(type) {
        if(!currentWorkout) createNewWorkout();
        let name = 'Bloco Principal';
        if(type==='BiSet') name = 'Bi-Set';
        if(type==='TriSet') name = 'Tri-Set';
        
        const blk = { id: Date.now(), type: type, name: name, items: [] };
        currentWorkout.blocks.push(blk);
        saveCurrent(); renderBuilder();
    }

    function saveCurrent() {
        if(!currentWorkout) return;
        currentWorkout.name = document.getElementById('sName').value;
        currentWorkout.focus = document.getElementById('sFocus').value;
        
        if(currentWorkout.name.trim() !== "") {
            const idx = appData.students.findIndex(s => s.id === currentWorkout.id);
            if(idx >= 0) appData.students[idx] = currentWorkout;
            else appData.students.push(currentWorkout);
            saveData(); 
            renderStudentList();
        }
    }

    function loadStudent(id) {
        const s = appData.students.find(x => x.id === id);
        if(s) { 
            currentWorkout = JSON.parse(JSON.stringify(s)); 
            if(!currentWorkout.logicList) currentWorkout.logicList = (currentWorkout.logic||'').split('\n').filter(x=>x); 
            activeExerciseId = null;
            renderBuilder(); renderLogic();
        }
    }

    // --- RENDERIZADOR PRINCIPAL ---
    function renderBuilder() {
        document.getElementById('sName').value = currentWorkout.name || '';
        document.getElementById('sFocus').value = currentWorkout.focus || '';
        const cont = document.getElementById('blocksContainer'); cont.innerHTML = '';
        
        currentWorkout.blocks.forEach(blk => {
            let cls = 'block-container';
            if(blk.type === 'BiSet') cls += ' biset-cont';
            else if(blk.type === 'TriSet') cls += ' triset-cont';
            else cls += ' normal-wrap';
            
            // SELE√á√ÉO DO BLOCO
            if(activeExerciseId && activeExerciseId.blockId === blk.id) cls += ' active-block';

            const div = document.createElement('div');
            div.className = cls;
            
            let itemsHtml = '';
            if(blk.items.length === 0) {
                itemsHtml = `<div style="text-align:center; padding:20px; color:#94a3b8; font-size:0.8rem;">Toque num exerc√≠cio da biblioteca</div>`;
            } else {
                itemsHtml = blk.items.map((it, idx) => renderRow(blk.id, idx, it, null)).join('');
            }

            // Header com inputs e botoes
            let headHtml = `<div class="block-head">
                <input class="w-title" value="${blk.name}" placeholder="Nome do Bloco" onchange="updBlock(${blk.id}, this.value)">
                <div class="blk-actions">
                    <div class="blk-btn" onclick="moveBlock(${blk.id}, -1)"><i class="fas fa-arrow-up"></i></div>
                    <div class="blk-btn" onclick="moveBlock(${blk.id}, 1)"><i class="fas fa-arrow-down"></i></div>
                    <div class="blk-btn" style="color:var(--danger)" onclick="delBlock(${blk.id})"><i class="fas fa-trash"></i></div>
                </div>
            </div>`;

            div.innerHTML = `${headHtml}<div class="block-body">${itemsHtml}</div>`;
            
            // Click to select block logic
            div.onclick = (e) => {
                // Avoid triggering on inputs/buttons inside
                if(!e.target.closest('input') && !e.target.closest('button') && !e.target.closest('.m-tab') && !e.target.closest('.act-btn') && !e.target.closest('.blk-btn')) {
                    if(activeExerciseId?.blockId !== blk.id) {
                        activeExerciseId = { blockId: blk.id, itemIdx: null };
                        renderBuilder();
                    }
                }
            };
            cont.appendChild(div);
        });
    }

    function renderRow(bId, idx, item, sIdx) {
        const isActive = activeExerciseId && activeExerciseId.blockId === bId && activeExerciseId.itemIdx === idx && activeExerciseId.subIdx === sIdx;
        const activeClass = isActive ? 'selected' : '';
        
        let lblReps="Reps", repsInputType="number", repsWidth="55px", showDrops=false;
        if(item.method==='Drop'){ lblReps="Reps Max"; showDrops=true; }
        if(item.method==='Iso') lblReps="Tempo(s)";
        if(item.method==='Pyr'){ lblReps="Escada"; repsInputType="text"; repsWidth="80px"; }
        
        const methods = ['Normal', 'Drop', 'RNP', 'Iso', 'Pyr'];
        let tabsHtml = `<div class="method-tabs">`;
        methods.forEach(m => {
            tabsHtml += `<button class="m-tab ${item.method===m?'active':''}" data-m="${m}" onclick="updItem(${bId}, ${idx}, 'method', '${m}'); event.stopPropagation();">${m}</button>`;
        });
        tabsHtml += `</div>`;
        
        let fieldsHtml = '';
        if(item.method==='Iso') fieldsHtml=`<div class="pill-group"><span class="pill-lbl">SETS</span><input class="pill-inp" type="number" value="${item.sets}" onchange="updItem(${bId},${idx},'sets',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">REPS</span><input class="pill-inp" type="number" value="${item.isoReps||1}" onchange="updItem(${bId},${idx},'isoReps',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">ISO(s)</span><input class="pill-inp" type="number" value="${item.reps}" onchange="updItem(${bId},${idx},'reps',this.value)" onclick="event.stopPropagation()"></div>`;
        // RNP COM CAMPO EXTRA DE FALHA
        else if(item.method==='RNP') fieldsHtml=`<div class="pill-group"><span class="pill-lbl">SETS</span><input class="pill-inp" type="number" value="${item.sets}" onchange="updItem(${bId},${idx},'sets',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">REPS</span><input class="pill-inp" type="text" value="${item.reps}" onchange="updItem(${bId},${idx},'reps',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">PAUSA(s)</span><input class="pill-inp" type="number" value="${item.rnpRest||10}" onchange="updItem(${bId},${idx},'rnpRest',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">EXTRA</span><input class="pill-inp" type="text" value="+ Falha" disabled style="width:50px;font-size:0.7rem;color:#94a3b8; background:#f1f5f9;"></div>`;
        else fieldsHtml=`<div class="pill-group"><span class="pill-lbl">SETS</span><input class="pill-inp" type="number" value="${item.sets}" onchange="updItem(${bId},${idx},'sets',this.value)" onclick="event.stopPropagation()"></div><div class="pill-group"><span class="pill-lbl">${lblReps.toUpperCase()}</span><input class="pill-inp" type="${repsInputType}" style="width:${repsWidth}" value="${item.reps}" onchange="updItem(${bId},${idx},'reps',this.value)" onclick="event.stopPropagation()"></div>`;
        
        if(showDrops) fieldsHtml+=`<div class="pill-group"><span class="pill-lbl">DROPS</span><input class="pill-inp" type="number" value="${item.drops||0}" onchange="updItem(${bId},${idx},'drops',this.value)" onclick="event.stopPropagation()"></div>`;

        return `<div class="ex-row ${activeClass}" data-method="${item.method}" onclick="selectExercise(${bId},${idx},null)"><div class="ex-header"><span class="ex-name">${item.name}</span></div>${tabsHtml}<div class="pills-edit">${fieldsHtml}<div class="pill-group pill-int"><span class="pill-lbl">INT FINAL</span><input class="pill-inp" type="text" value="${item.rest}" onchange="updItem(${bId},${idx},'rest',this.value)" onclick="event.stopPropagation()"></div></div><input class="obs-inp" value="${item.obs}" placeholder="Carga / Obs..." onchange="updItem(${bId},${idx},'obs',this.value)" onclick="event.stopPropagation()"><div class="row-actions"><div class="act-btn" onclick="moveItem(${bId},${idx},-1);event.stopPropagation();"><i class="fas fa-arrow-up"></i></div><div class="act-btn" onclick="moveItem(${bId},${idx},1);event.stopPropagation();"><i class="fas fa-arrow-down"></i></div><div class="act-btn" style="color:var(--danger);" onclick="delItem(${bId},${idx});event.stopPropagation();"><i class="fas fa-trash"></i></div></div></div>`;
    }

    // LOGIC
    function getB(id) { return currentWorkout.blocks.find(b=>b.id===id); }
    function updBlock(id, val) { getB(id).name = val; saveCurrent(); }
    
    function selectExercise(bId, idx, sIdx) {
        activeExerciseId = { blockId: bId, itemIdx: idx, subIdx: sIdx };
        renderBuilder();
    }

    function delBlock(id) { 
        if(confirm("Excluir bloco?")) {
            currentWorkout.blocks = currentWorkout.blocks.filter(b=>b.id!==id);
            activeExerciseId = null;
            saveCurrent(); renderBuilder();
        }
    }

    // MOVE BLOCK LOGIC
    function moveBlock(id, dir) {
        const idx = currentWorkout.blocks.findIndex(b => b.id === id);
        if(idx + dir < 0 || idx + dir >= currentWorkout.blocks.length) return;
        const temp = currentWorkout.blocks[idx];
        currentWorkout.blocks[idx] = currentWorkout.blocks[idx + dir];
        currentWorkout.blocks[idx + dir] = temp;
        saveCurrent(); renderBuilder();
    }

    function addItem(ex){
        if(!currentWorkout)createNewWorkout();
        let t;
        if(activeExerciseId) t=activeExerciseId.blockId;
        else{
            if(currentWorkout.blocks.length===0)addBlock('Normal');
            t=currentWorkout.blocks[currentWorkout.blocks.length-1].id;
        }
        let b=getB(t);
        // Default new item logic
        b.items.push({name:ex.name,link:ex.link||'',sets:'3',reps:'10',rest:'60s',obs:'',method:'Normal',drops:0,isoReps:1,rnpRest:10});
        activeExerciseId={blockId:t,itemIdx:b.items.length-1,subIdx:null};
        saveCurrent();renderBuilder();
        const c=document.querySelector('.canvas');c.scrollTop=c.scrollHeight;
    }
    
    function updItem(bId,idx,f,v){const b=getB(bId);b.items[idx][f]=v;if(f==='method'){if(v==='Iso'){b.items[idx].reps='30';b.items[idx].isoReps=1;}if(v==='RNP'){b.items[idx].reps='10';b.items[idx].rnpRest=10;}}saveCurrent();renderBuilder();}
    function delItem(bId,idx){const b=getB(bId);b.items.splice(idx,1);activeExerciseId=null;saveCurrent();renderBuilder();}
    function moveItem(bId,idx,d){const b=getB(bId);if(idx+d<0||idx+d>=b.items.length)return;const t=b.items[idx];b.items[idx]=b.items[idx+d];b.items[idx+d]=t;if(activeExerciseId&&activeExerciseId.blockId===bId&&activeExerciseId.itemIdx===idx)activeExerciseId.itemIdx+=d;saveCurrent();renderBuilder();}
    function renderLib(){const l=document.getElementById('libList'),t=document.getElementById('searchLib').value.toLowerCase(),c=document.getElementById('catFilter').value;l.innerHTML='';appData.library.filter(x=>x.name.toLowerCase().includes(t)&&(c==='Todas'||x.cat===c)).forEach(x=>{const d=document.createElement('div');d.className='item-card';d.innerHTML=`<div style="font-weight:600;color:var(--text);font-size:0.85rem;"><span class="cat-dot" style="background:${catColors[x.cat]||'#999'}"></span> ${x.name}</div><div style="display:flex;gap:8px;"><i class="fas fa-pen" style="color:#cbd5e1;font-size:0.7rem;" onclick="editEx(${x.id},event)"></i><i class="fas fa-trash" style="color:#cbd5e1;font-size:0.7rem;" onclick="delEx(${x.id},event)"></i></div>`;d.onclick=(e)=>{if(e.target.tagName!=='I')addItem(x)};l.appendChild(d);});}
    function filterStudents(v){const l=document.getElementById('studentList');l.innerHTML='';appData.students.filter(s=>s.name.toLowerCase().includes(v.toLowerCase())).forEach(s=>{const d=document.createElement('div');d.className=`student-item ${currentWorkout&&s.id===currentWorkout.id?'active':''}`;d.innerHTML=`<div><span class="st-name">${s.name}</span><span class="st-focus">${s.focus||'Sem objetivo'}</span></div><i class="fas fa-trash st-del" onclick="delStudent(${s.id},event)"></i>`;d.onclick=()=>loadStudent(s.id);l.appendChild(d);});}
    
    // DELETE BUG FIX
    function delStudent(id,e){
        e.stopPropagation();
        if(confirm("Apagar aluno permanentemente?")){
            appData.students=appData.students.filter(s=>s.id!==id);
            saveData();
            if(currentWorkout&&currentWorkout.id===id) createNewWorkout();
            
            // Hard refresh of list
            document.getElementById('studentList').innerHTML = '';
            filterStudents(document.querySelector('.search-inp').value);
        }
    }
    function renderStudentList(){filterStudents('');}

    // ... Modals lib mantidos ...
    function populateCats(){const s=[document.getElementById('catFilter'),document.getElementById('exCat')];s[0].innerHTML='<option value="Todas">Todas</option>';s[1].innerHTML='';appData.categories.forEach(c=>{s[0].add(new Option(c,c));s[1].add(new Option(c,c));});}
    function openExModal(){document.getElementById('exId').value='';document.getElementById('exName').value='';document.getElementById('exLink').value='';openModal('ex');}
    function editEx(id,e){e.stopPropagation();const x=appData.library.find(z=>z.id===id);document.getElementById('exId').value=x.id;document.getElementById('exName').value=x.name;document.getElementById('exCat').value=x.cat;document.getElementById('exLink').value=x.link||'';openModal('ex');}
    function saveEx(){const i=document.getElementById('exId').value,n=document.getElementById('exName').value,c=document.getElementById('exCat').value,l=document.getElementById('exLink').value;if(!n)return;if(i){const x=appData.library.findIndex(z=>z.id==i);appData.library[x]={id:Number(i),name:n,cat:c,link:l};}else appData.library.push({id:Date.now(),name:n,cat:c,link:l});saveData();renderLib();closeModal('ex');}
    function delEx(id,e){e.stopPropagation();if(confirm("Apagar?")){appData.library=appData.library.filter(x=>x.id!==id);saveData();renderLib();}}
    function openModal(id){document.getElementById('modal-'+id).style.display='flex';}
    function closeModal(id){document.getElementById('modal-'+id).style.display='none';}
    function exportData(){const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(appData));const a=document.createElement('a');a.href=d;a.download="benai_coach_v14.json";a.click();}
    function importData(i){const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const j=JSON.parse(e.target.result);if(j.library)appData.library=j.library;if(j.students)appData.students=j.students;saveData();init();alert("Dados restaurados!");}catch(x){alert("Erro");}};r.readAsText(f);}
    function tryRescueOldData(){const k=['benai_lib_v13','benai_lib_v12'];for(let x of k){const d=localStorage.getItem(x);if(d){try{appData.library=JSON.parse(d);saveData();return;}catch(e){}}}}
    function rescueData(){tryRescueOldData();location.reload();}
    function hardReset(){if(confirm("Apagar tudo?")){localStorage.clear(); location.reload();}}
    function generateLink(){if(!currentWorkout.name)return alert("Preencha o nome!");saveCurrent();const l=(currentWorkout.logicList||[]).join('\n');const m={name:currentWorkout.name,focus:currentWorkout.focus,logic:l,blocks:currentWorkout.blocks.map(b=>({name:b.name,type:b.type==='BiSet'?'biset':(b.type==='TriSet'?'triset':'block'),items:b.items.map(i=>({name:i.name,link:i.link,sets:i.sets,reps:i.reps,rest:i.rest,obs:i.obs,method:i.method,drops:i.drops,isoReps:i.isoReps,rnpRest:i.rnpRest}))}))};const j=JSON.stringify(m);const c=LZString.compressToEncodedURIComponent(j);let p=window.location.href.split('?')[0];p=p.substring(0,p.lastIndexOf('/')+1);const u=`${p}aluno.html?data=${c}`;navigator.clipboard.writeText(u).then(()=>alert("üîó Link Copiado!"));}
</script>
</body>
</html>